<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="本次从宏观到微观，关注一个核心系统的账务应该如何运行。希望可以准确的考虑账务的总流程和细节。放款、还款、计提、转列、拨备、批扣、流水同步。每个场景下的细节和事务控制等尽量详细。"><title>账务是怎样运行的</title><link rel=canonical href=https://thecoolboyhan.github.io/p/%E8%B4%A6%E5%8A%A1%E6%98%AF%E6%80%8E%E6%A0%B7%E8%BF%90%E8%A1%8C%E7%9A%84/><link rel=stylesheet href=/scss/style.min.833d6eed45de56f48306bf57268d5b8cdfc8a60e8e7bdc99810464fcd033f7c6.css><meta property='og:title' content="账务是怎样运行的"><meta property='og:description' content="本次从宏观到微观，关注一个核心系统的账务应该如何运行。希望可以准确的考虑账务的总流程和细节。放款、还款、计提、转列、拨备、批扣、流水同步。每个场景下的细节和事务控制等尽量详细。"><meta property='og:url' content='https://thecoolboyhan.github.io/p/%E8%B4%A6%E5%8A%A1%E6%98%AF%E6%80%8E%E6%A0%B7%E8%BF%90%E8%A1%8C%E7%9A%84/'><meta property='og:site_name' content='韩永发的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='账务'><meta property='article:tag' content='分布式'><meta property='article:published_time' content='2025-12-25T00:00:00+00:00'><meta property='article:modified_time' content='2025-12-25T00:00:00+00:00'><meta property='og:image' content='https://thecoolboyhan.github.io/1.png'><meta name=twitter:title content="账务是怎样运行的"><meta name=twitter:description content="本次从宏观到微观，关注一个核心系统的账务应该如何运行。希望可以准确的考虑账务的总流程和细节。放款、还款、计提、转列、拨备、批扣、流水同步。每个场景下的细节和事务控制等尽量详细。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://thecoolboyhan.github.io/1.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_63165f4306fe5eb3.png width=300 height=400 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>韩永发的博客</a></h1><h2 class=site-description>目前人在上海，20年毕业，普通muggle，java开发。邮箱：hanyongfa2013@163.com 。</h2></div></header><ol class=menu-social><li><a href=https://github.com/thecoolboyhan target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://leetcode.cn/u/thecoolboy/ target=_blank title=力扣 rel=me><svg role="img" viewBox="0 0 24 24"><title>LeetCode</title><path d="M13.483.0a1.374 1.374.0 00-.961.438L7.116 6.226l-3.854 4.126a5.266 5.266.0 00-1.209 2.104 5.35 5.35.0 00-.125.513 5.527 5.527.0 00.062 2.362 5.83 5.83.0 00.349 1.017 5.938 5.938.0 001.271 1.818l4.277 4.193.039.038c2.248 2.165 5.852 2.133 8.063-.074l2.396-2.392c.54-.54.54-1.414.003-1.955a1.378 1.378.0 00-1.951-.003l-2.396 2.392a3.021 3.021.0 01-4.205.038l-.02-.019-4.276-4.193c-.652-.64-.972-1.469-.948-2.263a2.68 2.68.0 01.066-.523 2.545 2.545.0 01.619-1.164L9.13 8.114c1.058-1.134 3.204-1.27 4.43-.278l3.501 2.831c.593.48 1.461.387 1.94-.207a1.384 1.384.0 00-.207-1.943l-3.5-2.831c-.8-.647-1.766-1.045-2.774-1.202l2.015-2.158A1.384 1.384.0 0013.483.0zm-2.866 12.815a1.38 1.38.0 00-1.38 1.382 1.38 1.38.0 001.38 1.382H20.79a1.38 1.38.0 001.38-1.382 1.38 1.38.0 00-1.38-1.382z"/></svg></a></li><li><a href=mailto:hanyongfa2013@163.com target=_blank title=邮箱 rel=me><svg id="mdi-email-arrow-right-outline" viewBox="0 0 24 24"><path d="M13 19C13 18.66 13.04 18.33 13.09 18H4V8l8 5 8-5v5.09C20.72 13.21 21.39 13.46 22 13.81V6C22 4.9 21.1 4 20 4H4C2.9 4 2 4.9 2 6V18c0 1.1.9 2 2 2h9.09C13.04 19.67 13 19.34 13 19M20 6l-8 5L4 6H20m0 16V20H16V18h4V16l3 3-3 3z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#基础信息说明>基础信息说明</a><ol><li><a href=#账户信息>账户信息</a></li><li><a href=#借据信息>借据信息</a></li><li><a href=#利率表>利率表</a></li><li><a href=#贷款期供表>贷款期供表</a></li><li><a href=#交易主流水>交易主流水</a></li><li><a href=#贷款交易流水>贷款交易流水</a></li><li><a href=#支付交易流水>支付交易流水</a></li><li><a href=#利息计提流水>利息计提流水</a></li><li><a href=#期供交易流水表>期供交易流水表</a></li></ol></li><li><a href=#放款>放款</a><ol><li><a href=#放款前的准备>放款前的准备</a><ol><li><a href=#产品信息>产品信息</a></li><li><a href=#放款基础信息>放款基础信息</a></li></ol></li><li><a href=#放款试算>放款试算</a><ol><li><a href=#前期准备杂项介绍>前期准备杂项介绍</a></li><li><a href=#等额本金试算器>等额本金试算器</a></li><li><a href=#等额本息试算器>等额本息试算器</a></li></ol></li><li><a href=#放款try>放款try</a><ol><li><a href=#流水登记事务1>流水登记（事务1）</a></li><li><a href=#开户放款试算信息落库事务2>开户、放款试算信息落库（事务2）</a></li></ol></li><li><a href=#放款confirm>放款confirm</a></li><li><a href=#放款取消cancel>放款取消Cancel</a></li><li><a href=#放款总结答疑>放款总结答疑</a></li></ol></li><li><a href=#日切>日切</a><ol><li><a href=#计提>计提</a></li><li><a href=#转列>转列</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/%E8%B4%A6%E5%8A%A1%E6%98%AF%E6%80%8E%E6%A0%B7%E8%BF%90%E8%A1%8C%E7%9A%84/><img src=/1.png loading=lazy alt="Featured image of post 账务是怎样运行的"></a></div><div class=article-details><header class=article-category><a href=/categories/%E7%B2%BE%E9%80%89/>精选
</a><a href=/categories/%E9%87%91%E8%9E%8D/>金融
</a><a href=/categories/%E4%B8%AA%E8%B4%B7%E6%A0%B8%E5%BF%83/>个贷核心</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E8%B4%A6%E5%8A%A1%E6%98%AF%E6%80%8E%E6%A0%B7%E8%BF%90%E8%A1%8C%E7%9A%84/>账务是怎样运行的</a></h2><h3 class=article-subtitle>本次从宏观到微观，关注一个核心系统的账务应该如何运行。希望可以准确的考虑账务的总流程和细节。放款、还款、计提、转列、拨备、批扣、流水同步。每个场景下的细节和事务控制等尽量详细。</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-12-25T00:00:00Z>Dec 25, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 18 分钟</time></div></footer></div></header><section class=article-content><h1 id=账务是怎样运行的>账务是怎样运行的</h1><p>对于业务主流程可以看我的<a class=link href=https://thecoolboyhan.github.io/p/%E4%B8%AA%E8%B4%B7%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E4%B8%8E%E6%A0%B8%E7%AE%97%E8%A7%84%E5%88%99%E6%A6%82%E8%A7%88/ target=_blank rel=noopener>这篇文章</a>。</p><blockquote><p>本次尽量在把所有的操作分成多个阶段，每个阶段都会对已知信息做出总结。（个人绘制，配图）</p></blockquote><h2 id=基础信息说明>基础信息说明</h2><blockquote><p>在开启业务之前，需要同步的几个重要信息。下面列举的信息为目的，本文中列举的所有业务场景，只是为了达到下面几个目的所使用的手段。类似于本地强事务中：AID和C的关系。</p></blockquote><h3 id=账户信息>账户信息</h3><blockquote><p>一个客户对应一个账户，一个账户对应一笔借据，每次账务操作都需对账户上锁</p></blockquote><div class=table-wrapper><table><thead><tr><th>字段</th><th>说明</th><th>枚举</th></tr></thead><tbody><tr><td>客户号</td><td></td><td></td></tr><tr><td>借据号</td><td></td><td></td></tr><tr><td>产品ID</td><td></td><td></td></tr><tr><td>减值标识</td><td>当前账户是否已减值</td><td></td></tr><tr><td>账户余额</td><td>贷款余额</td><td></td></tr><tr><td>上日账户余额</td><td>上次贷款余额</td><td></td></tr><tr><td>上次交易会计日期</td><td>标定当前账户已计提日期</td><td></td></tr><tr><td>上日正常本金</td><td></td><td></td></tr><tr><td>上日逾期本金</td><td></td><td></td></tr><tr><td>上日减值本金</td><td></td><td></td></tr><tr><td>上日计提利息</td><td>上次利息计提余额</td><td></td></tr><tr><td>账户状态</td><td>标识当前账户是否有效，如果借据结清，就销户</td><td>正常<br>销户<br>放款冲正<br>预开户</td></tr><tr><td>处理状态</td><td>锁位</td><td>处理中<br>已处理</td></tr><tr><td>预锁定</td><td></td><td>无锁定<br>预锁定</td></tr><tr><td>加锁流水号</td><td>只有上锁的流水号才能实现解锁</td><td></td></tr></tbody></table></div><p><strong>锁定账户</strong>：哪条流水（连接/线程）进行的加锁（开启事务/获取资源）操作，有且只有这条流水去进行解锁，而且必须保证解锁的逻辑能够执行。</p><h3 id=借据信息>借据信息</h3><blockquote><p>借据维度的详细信息</p></blockquote><div class=table-wrapper><table><thead><tr><th>字段</th><th>说明</th><th>枚举</th></tr></thead><tbody><tr><td>借据号</td><td></td><td></td></tr><tr><td>账户号</td><td></td><td></td></tr><tr><td>客户号</td><td></td><td></td></tr><tr><td>还款方式</td><td>与下文中产品信息中的还款方式相同</td><td></td></tr><tr><td>四级分类</td><td>核心自己的账户登记</td><td>正常<br>逾期<br>呆滞<br>呆账</td></tr><tr><td>五级分类</td><td>银行贷款角度的五级分类</td><td>正常、关注、次级、可疑、损失</td></tr><tr><td>借据金额</td><td>放款本金</td><td></td></tr><tr><td>正常本金</td><td></td><td></td></tr><tr><td>逾期本金</td><td></td><td></td></tr><tr><td>减值本金</td><td></td><td></td></tr><tr><td>减值标识</td><td>表内外标识</td><td></td></tr><tr><td>是否停息</td><td>本借据是否仍然计提</td><td></td></tr><tr><td>停息日期</td><td></td><td></td></tr><tr><td>借据余额</td><td></td><td></td></tr><tr><td>应收应计利息</td><td>所有未结清期供计提的累计（已结清期供应计利息置0）</td><td></td></tr><tr><td>催收应计利息</td><td>与上同理，借据减值后，会从应收转催收</td><td></td></tr><tr><td>应收欠息</td><td>已到期的未收利息累计</td><td></td></tr><tr><td>催收欠息</td><td>非应计状态下的欠息</td><td></td></tr><tr><td>应收应计罚息</td><td>与利息同理</td><td></td></tr><tr><td>催收应计罚息</td><td></td><td></td></tr><tr><td>应收罚息</td><td>正常情况下罚息计提后立刻转应收，但部分结息规则不同，可能导致转应收不及时</td><td></td></tr><tr><td>催收应收罚息</td><td></td><td></td></tr><tr><td>应计复息</td><td></td><td></td></tr><tr><td>复息</td><td></td><td></td></tr><tr><td>核销标识</td><td>是否已核销</td><td></td></tr><tr><td>核销利息</td><td>只表示核销时共核销的金额，不代表核销后的余额</td><td></td></tr><tr><td>核销罚息</td><td>只表示核销时共核销的金额，不代表核销后的余额</td><td></td></tr><tr><td>核销复息</td><td>只表示核销时共核销的金额，不代表核销后的余额</td><td></td></tr><tr><td>总期数</td><td></td><td></td></tr><tr><td>本期期数</td><td>当前贷款处于哪一期</td><td></td></tr><tr><td>上次还款日</td><td>上一次还款的日期</td><td></td></tr><tr><td>下次还款日</td><td>通常为借据所处当前期次的到期时间</td><td></td></tr><tr><td>计提日期</td><td>上次计提的日期</td><td></td></tr><tr><td>结息日期</td><td>上次结息的日期</td><td></td></tr></tbody></table></div><p>借据的详细信息表：从账务角度出发，主要包含应计（已计提）应收（未还）、已还（累计已还）三种金额。以及当前借据所处的状态等（4级分类、5级分类、表内外标识等）</p><h3 id=利率表>利率表</h3><blockquote><p>理论上相同产品的利率相同，但在金融领域，利率是由风控来抉择的，使用相同产品的不同人，可能出现不同的利率。</p></blockquote><p>每笔借据对应的利率</p><div class=table-wrapper><table><thead><tr><th>字段</th><th>说明</th><th>枚举</th></tr></thead><tbody><tr><td>客户号</td><td></td><td></td></tr><tr><td>借据号</td><td></td><td></td></tr><tr><td>账户号</td><td></td><td></td></tr><tr><td>正常利率</td><td></td><td></td></tr><tr><td>罚息利率</td><td></td><td></td></tr><tr><td>复利利率</td><td></td><td></td></tr><tr><td>折后利率</td><td>使用优惠后会出现</td><td></td></tr><tr><td>费用利率</td><td>试算费用时使用的利率</td><td></td></tr><tr><td>基准利率</td><td>LPR或人行基准利率</td><td></td></tr><tr><td>贴息利率</td><td>针对贴息场景使用的贴息率</td><td></td></tr></tbody></table></div><h3 id=贷款期供表>贷款期供表</h3><blockquote><p>还款计划，核心账务运行的基础组件，所有贷款都是由不同各种各样的还款计划来构成一个完整的贷款。</p></blockquote><div class=table-wrapper><table><thead><tr><th>字段</th><th>说明</th><th>枚举</th></tr></thead><tbody><tr><td>客户号</td><td></td><td></td></tr><tr><td>借据号</td><td></td><td></td></tr><tr><td>账户号</td><td></td><td></td></tr><tr><td>本期期数</td><td></td><td></td></tr><tr><td>起始日期</td><td></td><td>当期开始的时间</td></tr><tr><td>到期日期</td><td>当前期次的到期日，一般就是下一期的开始日期</td><td>当期结束的日期</td></tr><tr><td>上日还款日期</td><td></td><td></td></tr><tr><td>下次还款日期</td><td>一般为到期日</td><td></td></tr><tr><td>初始本金</td><td>放款时预生成的值</td><td></td></tr><tr><td>初始利息</td><td></td><td></td></tr><tr><td>初始费用</td><td></td><td></td></tr><tr><td>剩余余额</td><td>剩余本金</td><td></td></tr><tr><td>剩余本金</td><td></td><td></td></tr><tr><td>应收应计利息</td><td>已计提的未还总额</td><td></td></tr><tr><td>催收应计利息</td><td>减值已计提未还总额</td><td></td></tr><tr><td>应收欠息</td><td>剩余欠息</td><td></td></tr><tr><td>催收欠息</td><td>减值剩余欠息</td><td></td></tr><tr><td>应收应计罚息</td><td></td><td></td></tr><tr><td>催收应计罚息</td><td></td><td></td></tr><tr><td>应收罚息</td><td></td><td></td></tr><tr><td>催收罚息</td><td></td><td></td></tr><tr><td>应计复息</td><td></td><td></td></tr><tr><td>复息</td><td></td><td></td></tr><tr><td>费用</td><td></td><td></td></tr><tr><td>计提日期</td><td>最后一次计提的日期</td><td></td></tr><tr><td>利息调整</td><td>正数调整</td><td></td></tr><tr><td>罚息调整</td><td></td><td></td></tr><tr><td>复息调整</td><td></td><td></td></tr><tr><td>费用调整</td><td></td><td></td></tr><tr><td>利息抵扣金额</td><td>还款时优惠的金额（延展期、优惠券等会用到）</td><td></td></tr><tr><td>本期状态</td><td>当期期供的状态</td><td>正常<br>逾期<br>呆滞<br>呆账<br>结清</td></tr><tr><td>减值表示</td><td></td><td></td></tr><tr><td>破期表示</td><td>当前借据是否为整期，破期需特殊计提</td><td></td></tr><tr><td>宽限期</td><td>宽限期</td><td></td></tr></tbody></table></div><p>期供信息和借据信息类似，换一种说法，借据信息就是由期供信息组成的。</p><p><strong>上面提到的所有表，都是终态表，我们的目的是为了操作上面的表。但如何科学的操作终态表，就需要有流水表来记录。下面列举重要的流水表。</strong></p><h3 id=交易主流水>交易主流水</h3><blockquote><p>所有都会记录的主要流水，用来同步本次交易的状态</p></blockquote><div class=table-wrapper><table><thead><tr><th>字段</th><th>说明</th><th>枚举</th></tr></thead><tbody><tr><td>客户号</td><td></td><td></td></tr><tr><td>交易日期</td><td></td><td></td></tr><tr><td>交易流水号（重要）</td><td>主流水，账户上锁，解锁，放款，其他表都需要记录本流水。有且只有相同的流水才能操作相同的记录。</td><td></td></tr><tr><td>交易类型</td><td>无论那种类型的交易都需要在主流水表来同步状态，这样设计可以方便流水同步</td><td>放贷<br>收贷<br>核销<br>核销冲正<br>核销回收<br>利息调整<br>提现（虚账户）<br>放款冲正</td></tr><tr><td>交易金额</td><td></td><td></td></tr><tr><td>交易状态（重要）</td><td>本次交易状态的标志（所有交易都以本状态为准）</td><td>初始化<br>记账成功<br>记账失败<br>冲正中<br>已冲正<br>未知（超时）<br>待处理（还款批量）</td></tr><tr><td>处理次数</td><td>本交易尝试的次数（一般在批扣时常用）</td><td></td></tr><tr><td>扣款类型</td><td>当前还款使用的方式</td><td>联机<br>批量<br>人工代扣<br>对公还款<br>批扣零金额还款</td></tr></tbody></table></div><h3 id=贷款交易流水>贷款交易流水</h3><blockquote><p>对客的交易流水，可以变相的理解为超全的paylog，包含放还款等（没有利息计提）每条记录一般都是要向客户展示的。</p></blockquote><div class=table-wrapper><table><thead><tr><th>字段</th><th>说明</th><th>枚举</th></tr></thead><tbody><tr><td>会计日期</td><td>账务时间</td><td></td></tr><tr><td>交易日期</td><td>交易日期只本流水成功的时间（可能会跨日）</td><td></td></tr><tr><td>交易流水号</td><td>同主流水表流水号</td><td></td></tr><tr><td>交易类型</td><td></td><td>放款<br>还款<br>核销<br>核销冲正<br>利息调整<br>虚账户提现<br>放款冲正</td></tr><tr><td>客户号</td><td></td><td></td></tr><tr><td>账户号</td><td></td><td></td></tr><tr><td>借据号</td><td></td><td></td></tr><tr><td>还款状态</td><td></td><td>提前还款<br>正常还款<br>逾期还款<br>期供还款（正常）<br>期供还款（逾期）</td></tr><tr><td>还款期数</td><td>当前还款对应的期数</td><td>提前还款时取最早的一期</td></tr><tr><td>还款金额</td><td>总金额，用来调用支付</td><td></td></tr><tr><td>提前还款本金</td><td></td><td></td></tr><tr><td>提前还款利息</td><td></td><td></td></tr><tr><td>提前还款方式</td><td></td><td>提前还N<br>提前结清<br>提前部分结清<br>提前还当期<br>提前还本<br>提前部分还款</td></tr><tr><td>正常本金</td><td>还款前的本金金额</td><td></td></tr><tr><td>应还本金</td><td>交易后金额</td><td></td></tr><tr><td>本金发生额</td><td>本次交易发生的本金（一般表示当前还款扣减的本金）</td><td></td></tr><tr><td>逾期本金</td><td>还款前的逾期金额</td><td></td></tr><tr><td>逾期本金发生额</td><td>本次交易的本金</td><td></td></tr><tr><td>应还逾期本金</td><td>交易后金额</td><td></td></tr><tr><td>减值本金</td><td></td><td></td></tr><tr><td>减值本金发生额</td><td></td><td></td></tr><tr><td>应还减值本金</td><td></td><td></td></tr><tr><td>已减值本金转正常</td><td>转列金额</td><td></td></tr><tr><td>已减值利息转正常</td><td></td><td></td></tr><tr><td>应收应计利息发生额</td><td>本次计提的利息</td><td></td></tr><tr><td>应收应计利息</td><td>本次交易后应计利息</td><td></td></tr><tr><td>催收应计利息</td><td>本次交易后的减值利息</td><td></td></tr><tr><td>催收应计利息发生额</td><td>本次计提的减值利息</td><td></td></tr><tr><td>应收欠息发生额</td><td>本次还款的利息</td><td></td></tr><tr><td>催收欠息发生额</td><td>本次还款的减值利息</td><td></td></tr><tr><td>应收欠息</td><td>欠息余额</td><td></td></tr><tr><td>催收欠息</td><td></td><td></td></tr><tr><td>应收应计罚息发生额</td><td>本次计提罚息</td><td></td></tr><tr><td>应收应计罚息</td><td>交易后罚息</td><td></td></tr><tr><td>催收应计罚息</td><td>交易后减值罚息</td><td></td></tr><tr><td>催收应计罚息发生额</td><td>本次计提的减值罚息</td><td></td></tr><tr><td>应收罚息发生额</td><td>本次还款的罚息</td><td></td></tr><tr><td>催收罚息发生额</td><td>本次还款的减值罚息</td><td></td></tr><tr><td>四级分类</td><td></td><td>正常、逾期、呆滞、呆账</td></tr><tr><td>五级分类</td><td></td><td>正常、关注、次级、可疑、损失</td></tr><tr><td>减值标识</td><td></td><td></td></tr><tr><td>核销标识</td><td></td><td></td></tr><tr><td>交易状态</td><td>当前交易流水的状态</td><td>初始化（处理中）<br>记账成功<br>记账失败<br>冲正中<br>已冲正<br>未知（超时）<br>待处理（批量还款）</td></tr></tbody></table></div><p>一笔借据绝大多数交易都会在这里展示，对于账务相关字段，大致可分为下面几种</p><ol><li>应收应计金额：本次交易后的金额</li><li>应收应计发生额：本次交易需补计提的金额</li><li>欠息金额：本次交易后去，欠息余额</li><li>欠息发生额：本次还款实际发生的金额</li></ol><ul><li>为什么会有一个总金额？</li></ul><p>因为支付只会用对应的金额去请求对应账户，并不关心这些钱中包含哪些内容。（由哪些金额组成）核心作为事务控制的基准，需有统一管控。</p><h3 id=支付交易流水>支付交易流水</h3><blockquote><p>登记与支付操作相关的流水，支付系统不care资金有哪些内容组成，支付只care本次交易的状态，总额等。</p></blockquote><div class=table-wrapper><table><thead><tr><th>字段</th><th>说明</th><th>枚举</th></tr></thead><tbody><tr><td>会计日期</td><td></td><td></td></tr><tr><td>交易日期</td><td>可能不同</td><td></td></tr><tr><td>交易流水号</td><td>主流水</td><td></td></tr><tr><td>支付流水号</td><td>与资方（银行）交易的流水号</td><td></td></tr><tr><td>支付渠道</td><td></td><td></td></tr><tr><td>客户号</td><td></td><td></td></tr><tr><td>贷款账号</td><td></td><td></td></tr><tr><td>借据号</td><td></td><td></td></tr><tr><td>付款账号</td><td></td><td></td></tr><tr><td>收款账号</td><td></td><td></td></tr><tr><td>交易金额</td><td></td><td></td></tr><tr><td>交易状态（重点）</td><td></td><td>初始化（处理中）<br>记账成功<br>记账失败<br>已冲正<br>未知（超时）</td></tr><tr><td>对账状态</td><td>是否以对账（可能出现跨日对账）</td><td></td></tr></tbody></table></div><blockquote><p>支付账号中存在大量补充校验信息，本文只介绍账务，固不赘述</p></blockquote><h3 id=利息计提流水>利息计提流水</h3><blockquote><p>按日计提的流水单独记录，此部分流水一般不向用户展示</p></blockquote><div class=table-wrapper><table><thead><tr><th>字段</th><th>说明</th><th>枚举</th></tr></thead><tbody><tr><td>客户号</td><td></td><td></td></tr><tr><td>交易日期</td><td></td><td></td></tr><tr><td>交易流水号</td><td></td><td></td></tr><tr><td>借据号</td><td></td><td></td></tr><tr><td>本金调整</td><td>本金一般不涉及调整</td><td></td></tr><tr><td>利息调整</td><td>存在正向和反向调整</td><td></td></tr><tr><td>罚息调整</td><td>反向调整为减免</td><td></td></tr><tr><td>复息调整</td><td></td><td></td></tr></tbody></table></div><p>此流水不存在交易状态，因为一旦登记就是成功。（只有成功才会登记流水）</p><h3 id=期供交易流水表>期供交易流水表</h3><blockquote><p>与期供表相同，增加了本次交易的流水号，记录每次流水交易后，期供的变化情况。</p></blockquote><p>可以用此表来实现回滚。（如需）</p><p>这里不再赘述（只是在期供表上增加了流水号）</p><h2 id=放款>放款</h2><blockquote><p>放款只资金从银行到客户的提现过程。</p><p>客户角度只能看到一笔借据生成了，一笔钱到账了。</p><p>但在银行（核心）角度生意才刚刚开始，本次只列举账务，如开户行，支付用的账号等不再列举范围内。</p></blockquote><p><strong>只列举核心维系一笔账务运行的关键信息</strong></p><p>额度等暂不放入其中，只会偶尔提到，但不深入。</p><h3 id=放款前的准备>放款前的准备</h3><blockquote><p>如果想要开始一笔贷款，必须提前准备的信息</p></blockquote><h4 id=产品信息>产品信息</h4><blockquote><p>每笔借据都必须对应产品，不同产品可能会有各自不同的规则。</p></blockquote><p>产品的目的是尽量让贷款分类，<strong>在有限的种类下给客户不同的选择</strong></p><div class=table-wrapper><table><thead><tr><th>属性</th><th>解释</th><th>枚举</th></tr></thead><tbody><tr><td>计提周期</td><td>借据以什么样的周期来做计提，常见的为按日计提</td><td></td></tr><tr><td>贷款类型</td><td>与账务无关，贷款的补充信息：</td><td>信用类、<br>抵押类、<br>质押类、<br>担保类、<br>保证类</td></tr><tr><td>还款方式（重要）</td><td>可以理解成放款阶段最重要的几个字段之一，<br>本字段直接决定了期供应该如何生成，且每期对应的本金、利息如何分配。<br>放款阶段的试算器，完全就是为了不同的还款方式而定制化的。<br></td><td>利随本清（随借随还）<br>先息后本<br>等额本息<br>等额本金<br>按月复息定期还本<br>等额本息气球贷<br>等额本金气球贷<br>按月付息定期还本气球贷</td></tr><tr><td>还息周期</td><td>定义按什么样的维度来还款利息<br>（周期性还本还息时使用）</td><td></td></tr><tr><td>还本周期</td><td>与上同理</td><td></td></tr><tr><td>还款顺序</td><td>指表内的还款顺序（罚利本）</td><td></td></tr><tr><td>减值还款顺序</td><td>表外的还款顺序（本利罚）</td><td></td></tr><tr><td>宽限期</td><td>借据到期后，可以宽限的天数</td><td></td></tr><tr><td>固定还款日</td><td>有些产品还款日固定（为了方便计算）</td><td></td></tr><tr><td>末期和首期是否同日</td><td>防止出现破期（让每期期供计息天数相同）</td><td></td></tr></tbody></table></div><h4 id=放款基础信息>放款基础信息</h4><blockquote><p>在放款前置操作时准备好的字段，放款前置大部分为渠道、风险等</p></blockquote><div class=table-wrapper><table><thead><tr><th>属性</th><th>解释</th><th>枚举</th></tr></thead><tbody><tr><td>客户号</td><td>本身不属于账务必须，<br>但整个核心系统的事务都是基于账户来设计的<br>一个客户对应一个账户，<br>一个账务同一时间只能进行一个操作</td><td></td></tr><tr><td>产品id</td><td>查询产品信息的依据</td><td></td></tr><tr><td>还款方式</td><td>重要字段，这里不再赘述</td><td></td></tr><tr><td>总期数</td><td>共生成几期还款计划</td><td></td></tr><tr><td>正常利率（重要）</td><td>借据正常状态下的利率</td><td></td></tr><tr><td>逾期利率</td><td>可能存在逾期下与正常利率不同情况</td><td></td></tr><tr><td>折扣率</td><td>如果放款时有优惠，需使用折扣率</td><td></td></tr><tr><td>放款日期</td><td>借据的起始日期</td><td></td></tr></tbody></table></div><ul><li>折扣率</li></ul><blockquote><p>折扣率不一定会直接提供，大部分场景下需要计算得出</p></blockquote><p>固定利率：有些折扣会直接让利率固定，此场景不需要再考虑折扣率（利率已是折扣后的）</p><p>其他情况：需通过折扣率/正常利率，算出折扣率（后面为了得出优惠情况）</p><h3 id=放款试算>放款试算</h3><blockquote><p>所谓放款试算，只预生成借据和期供信息，相当于预放款，给客户一个完整的展示。后续实际贷款流程也会重新调用放款试算。试算更适合单独的展示账务是如何生成的。</p></blockquote><p><strong>放款全程没有事务，不涉及加锁，不涉及入库。</strong></p><ul><li>为什么不入库或加锁？</li></ul><p>放款试算只提现如何生成借据和期供，不一定只有在预放款时调用，可能在延展期，提前部分还款等场景下都会调用。且调用频率较高，如果每次试算都入库，会生成大量无效的数据。</p><blockquote><p>据了解，有些支持预放款的机构（如数禾：借呗），会把放款试算的结果保存在数据库中，来增加放款的响应速度。但放款场景下，试算是非常耗时的一环吗？？</p></blockquote><h4 id=前期准备杂项介绍>前期准备杂项介绍</h4><ul><li>试算时入参</li></ul><p>入参大部分为放款前准备阶段的已知数据，下面列举一些账务较为重要的字段</p><div class=table-wrapper><table><thead><tr><th>字段</th><th>备注</th></tr></thead><tbody><tr><td>借据金额</td><td></td></tr><tr><td>还款方式（重要）</td><td>不同的还款方式会生成不同的期供</td></tr><tr><td>总期数</td><td>生成的期供共有多少期</td></tr><tr><td>正常利率</td><td></td></tr><tr><td>还款日</td><td></td></tr><tr><td>首次还款日</td><td>可能出现首期破期</td></tr></tbody></table></div><ul><li>试算时出参</li></ul><p>目标字段</p><div class=table-wrapper><table><thead><tr><th>字段</th><th>备注</th></tr></thead><tbody><tr><td>本息总额</td><td>总金额：本金+利息（客户必还的钱）</td></tr><tr><td>本金总额</td><td></td></tr><tr><td>利息总额</td><td></td></tr><tr><td>到期日期</td><td></td></tr><tr><td>还款日</td><td></td></tr><tr><td>年利率</td><td></td></tr><tr><td>起始日期</td><td>借据开始的日期（可以理解成起息日）</td></tr><tr><td>下次还款日</td><td>支付系统可能调用</td></tr><tr><td>还款计划&lt;开始></td><td>还款计划是一个集合，下面展示集合中单个元素包含的信息</td></tr><tr><td>开始日期</td><td>当期开始日期</td></tr><tr><td>到期日</td><td>当期结束日期</td></tr><tr><td>当前期数</td><td></td></tr><tr><td>还款总额</td><td>当前期数需还款总金额</td></tr><tr><td>归还本金</td><td>当期应还本金</td></tr><tr><td>归还利息</td><td>当期应还利息</td></tr><tr><td>剩余总本金</td><td>到当期为止的剩余总本金（用来计算利息）</td></tr><tr><td><strong>费用等字段暂不列出</strong></td><td></td></tr><tr><td>还款计划&lt;结束></td><td></td></tr></tbody></table></div><blockquote><p>后面会详细列出上表中每个字段的生成逻辑</p></blockquote><p>根据不同的还款方式使用不同的放款试算器</p><h4 id=等额本金试算器>等额本金试算器</h4><blockquote><p>最简单的贷款生成逻辑，只根据剩余本金、计息天数、日利率来计算</p></blockquote><ol><li><strong>预生成还款计算，并把本金分配到每期上</strong></li></ol><blockquote><p>为什么要拆分本金？如果自定义还本周期，会出现多个不存在应还本金的还款计划，所以本金不一定是会拆分到每一起上的。</p></blockquote><p>总期数：会生成多少期还款计划在产品配置时就已经定义。</p><p><strong>哪些期数会被分配本金</strong>：还本周期/还息周期，后续每次增加 还本周期/还息周期</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=o>=</span><span class=n>还本周期</span><span class=o>/</span><span class=n>还息周期</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;</span><span class=n>总期数</span><span class=p>;</span><span class=n>i</span><span class=o>+=</span><span class=n>还本周期</span><span class=o>/</span><span class=n>还息周期</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>如还本周期为2，还息周期为1，生成的还款计划就是1（只还息）2（还本还息）3（只还息）4（还本还息）&mldr;</p></blockquote><div class=table-wrapper><table><thead><tr><th>字段</th><th>组成逻辑</th></tr></thead><tbody><tr><td>还款计划&lt;开始></td><td>还款计划是一个集合，下面展示集合中单个元素包含的信息</td></tr><tr><td>开始日期</td><td></td></tr><tr><td>到期日</td><td></td></tr><tr><td>当前期数</td><td>当期的期数</td></tr><tr><td>还款总额</td><td></td></tr><tr><td>归还本金</td><td>借据总金额/还本周期=每期应还款金额（除不尽的余额补在最后一期）</td></tr><tr><td>归还利息</td><td></td></tr><tr><td>剩余总本金</td><td></td></tr><tr><td><strong>费用等字段暂不列出</strong></td><td></td></tr><tr><td>还款计划&lt;结束></td><td></td></tr></tbody></table></div><ol start=2><li><strong>利息计算</strong></li></ol><p>计算每期的利息，对于首期有特殊计算逻辑</p><div class=table-wrapper><table><thead><tr><th>字段</th><th>组成逻辑</th></tr></thead><tbody><tr><td>还款计划&lt;开始></td><td>还款计划是一个集合，下面展示集合中单个元素包含的信息</td></tr><tr><td>开始日期</td><td>第一期为：借据放款时提供的起息日<br>其他期数：为上一期的到期日</td></tr><tr><td>到期日</td><td>第一期：放款时传入<br>其他期数：开始日期向后增加一个月</td></tr><tr><td>当期计息天数（内部使用）</td><td>破期（首期）：<br>1、按实际天数算<br>2、按整期算（30天）<br>3、满一个月部分按照30计算，超出部分按照实际天数<br>其他期数：统一按照30天计算</td></tr><tr><td>当前期数</td><td>当期的期数</td></tr><tr><td>还款总额</td><td>当期本金+当期利息</td></tr><tr><td>归还本金</td><td>借据总金额/还本周期=每期应还款金额（除不尽的余额补在最后一期）</td></tr><tr><td>归还利息</td><td>年利率/360*计息天数 *剩余本金</td></tr><tr><td>剩余总本金</td><td>截止目前为止的剩余总本金（包括当期）计算利息使用</td></tr><tr><td><strong>费用等字段暂不列出</strong></td><td></td></tr><tr><td>还款计划&lt;结束></td><td></td></tr></tbody></table></div><blockquote><p>还款计划生成完成！</p></blockquote><ol start=3><li><strong>借据字段补全</strong></li></ol><div class=table-wrapper><table><thead><tr><th>字段</th><th>逻辑</th></tr></thead><tbody><tr><td>本息总额</td><td>总金额：本金+利息（客户必还的钱）</td></tr><tr><td>本金总额</td><td>放款时提供</td></tr><tr><td>利息总额</td><td>计算还款计划时生成的利息和</td></tr><tr><td>到期日期</td><td>最后一期的到期日期</td></tr><tr><td>还款日</td><td>首次还款日</td></tr><tr><td>年利率</td><td>放款时提供</td></tr><tr><td>起始日期</td><td>借据开始的日期（可以理解成起息日）</td></tr><tr><td>下次还款日</td><td>首期到期日</td></tr><tr><td>还款计划&lt;开始></td><td>还款计划是一个集合，下面展示集合中单个元素包含的信息</td></tr><tr><td>开始日期</td><td>第一期为：借据放款时提供的起息日<br>其他期数：为上一期的到期日</td></tr><tr><td>到期日</td><td>第一期：放款时传入<br>其他期数：开始日期向后增加一个月</td></tr><tr><td>当期计息天数（内部使用）</td><td>破期（首期）：<br>1、按实际天数算<br>2、按整期算（30天）<br>3、满一个月部分按照30计算，超出部分按照实际天数<br>其他期数：统一按照30天计算</td></tr><tr><td>当前期数</td><td>当期的期数</td></tr><tr><td>还款总额</td><td>当期本金+当期利息</td></tr><tr><td>归还本金</td><td>借据总金额/还本周期=每期应还款金额（除不尽的余额补在最后一期）</td></tr><tr><td>归还利息</td><td>年利率/360*计息天数 *剩余本金</td></tr><tr><td>剩余总本金</td><td>截止目前为止的剩余总本金（包括当期）计算利息使用</td></tr><tr><td><strong>费用等字段暂不列出</strong></td><td></td></tr><tr><td>还款计划&lt;结束></td><td></td></tr></tbody></table></div><p>等额本金为最简单的贷款生成方式，后续其他还款方式的生成思想与等额本金相同</p><h4 id=等额本息试算器>等额本息试算器</h4><p>等额本金要提前拆分本金，等额本息由于每期还款总金额相同，所以需预拆分每期还款总额</p><ul><li>如何计算每期还款总额</li></ul><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2026-01/1767581897215_1767581897229.png loading=lazy alt=1767581897215.png></p><div class=table-wrapper><table><thead><tr><th>字段</th><th>备注</th></tr></thead><tbody><tr><td>本息总额</td><td>总金额：本金+利息（客户必还的钱）</td></tr><tr><td>本金总额</td><td>放款时提供</td></tr><tr><td>利息总额</td><td>计算还款计划时生成的利息和</td></tr><tr><td>到期日期</td><td>最后一期的到期日期</td></tr><tr><td>还款日</td><td>首次还款日</td></tr><tr><td>年利率</td><td>放款时提供</td></tr><tr><td>起始日期</td><td>借据开始的日期（可以理解成起息日）</td></tr><tr><td>下次还款日</td><td>首期到期日</td></tr><tr><td>还款计划&lt;开始></td><td>还款计划是一个集合，下面展示集合中单个元素包含的信息</td></tr><tr><td>开始日期</td><td>第一期为：借据放款时提供的起息日<br>其他期数：为上一期的到期日</td></tr><tr><td>到期日</td><td>第一期：放款时传入<br>其他期数：开始日期向后增加一个月</td></tr><tr><td>当期计息天数（内部使用）</td><td>破期（首期）：<br>1、按实际天数算<br>2、按整期算（30天）<br>3、满一个月部分按照30计算，超出部分按照实际天数<br>其他期数：统一按照30天计算</td></tr><tr><td>当前期数</td><td>当期的期数</td></tr><tr><td>还款总额</td><td>等额本息计算根据上面列出公式得出</td></tr><tr><td>归还本金</td><td>根据本期还款总额-当期归还利息</td></tr><tr><td>归还利息</td><td>年利率/360*计息天数 *剩余本金</td></tr><tr><td>剩余总本金</td><td>截止目前为止的剩余总本金（包括当期）计算利息使用</td></tr><tr><td><strong>费用等字段暂不列出</strong></td><td></td></tr><tr><td>还款计划&lt;结束></td><td></td></tr></tbody></table></div><blockquote><p>等额本息计算顺序有所改变：1、算出每期还款总额，2、算出当期应还利息，3、根据当期还款总额-当期应还利息=当期应还本金。</p></blockquote><h3 id=放款try>放款try</h3><blockquote><p>放款主要涉及三个服务联通，额度占用，借据期供生成，调用支付。（三个全部成功后才能提交）</p></blockquote><p>主要介绍事务控制，单个小事务和整体分布式事务是如何结合的。</p><blockquote><p>所有分布式事务，都需要考虑三个问题：<strong>幂等性，空回滚，悬挂问题</strong>，下文中会解释每个场景下问题是如何处理的。</p></blockquote><blockquote><p>放款账务部分有两个独立本地事务组成</p></blockquote><h4 id=流水登记事务1>流水登记（事务1）</h4><blockquote><p>登记三大流水</p></blockquote><p>交易主流水、贷款交易流水、支付交易流水。</p><ul><li>为什么使用独立事务登记流水？</li></ul><p>事务回滚触发条件存在两种情况：</p><ol><li><p>流水重复入库失败：当前流水已经入库被处理，不再重复处理。（<strong>幂等性</strong>）</p></li><li><p>代码出现异常，导致事务回滚：独立事务只做流水入库处理，如果和试算开户等计算逻辑放到同一个事务中，如果代码出现异常，登记的流水也会丢失。</p><blockquote><p>虽然下次相同的流水应该也会执行相同的回滚逻辑，但给系统增加了负担，所以让代码异常和流水登记分开。</p></blockquote></li></ol><h4 id=开户放款试算信息落库事务2>开户、放款试算信息落库（事务2）</h4><p>开户时生成账户信息，默认生成的账户信息为上锁状态，上锁流水为当前放款请求流水。（防止没有放款成功，此借据被其他线程消费）</p><p>给当前客户创建客户信息，走放款试算逻辑生成借据、期供。</p><ul><li>落库借据</li></ul><ol><li>落库账户信息</li><li>借据信息</li><li>利率信息</li><li>期供信息</li></ol><p>上述表除账户信息中存在锁状态，其他表无状态</p><blockquote><p>当前阶段并没有特殊逻辑，如果本阶段出现异常回滚，说明流水中存在错误参数，无法放款。之前登记的流水也要提交，遇到相同流水无需重复试算。</p></blockquote><h3 id=放款confirm>放款confirm</h3><blockquote><p>资源占用成功，支付返回成功后，就会提交占用的资源。</p></blockquote><p>由于借据相关信息已在占用阶段生成，所谓提交阶段只需提交流水信息。（把流水状态改成成功）</p><p>更新三大流水表状态为成功：交易主流水、贷款交易流水、支付交易流水。</p><blockquote><p>最后阶段解锁账户</p></blockquote><h3 id=放款取消cancel>放款取消Cancel</h3><blockquote><p>支付返回失败，放款冲正。</p></blockquote><p>取消阶段和提交阶段相同，为了保证事务/锁/资源一定可以释放，所有提交取消都是轻量级原子操作。不附加额外逻辑。</p><ol><li><p>更新三大流水表为失败：交易主流水、贷款交易流水、支付交易流水。</p></li><li><p>最后更新账户状态为放款冲正。（失败）</p></li></ol><blockquote><p>try阶段落库的借据信息、期供信息等不做处理。</p></blockquote><h3 id=放款总结答疑>放款总结答疑</h3><ul><li>为什么只修改流水，不修改借据信息，或者是为什么不在借据信息上也增加类似账户的状态字段？</li></ul><p>只修改流水，是为了保证提交和取消操作一定可以被执行。</p><p>只有账户信息上存在状态，其他所有非流水表都不在事务执行状态字段，是为了保证状态修改的原子性，避免死锁。</p><p>如果借据信息上存在类似账户的事务执行状态字段：加锁操作就不在是原子性的：</p><p>两个线程同时上锁：A线程线对账户加锁，后执行对借据加锁。B线程对借据加锁，后执行账户加锁。<font color=red>产生死锁</font></p><ul><li>幂等性</li></ul><p>try阶段两个独立事务，事务一登记流水，流水一旦登记，就不能再重复登记。</p><p>confirm：只按流水更新流水状态为成功，重复成功where条件中不存在当前流水号且状态为处理中的流水。</p><p>cancel：同提交操作，只更新流水。</p><ul><li>空回滚</li></ul><blockquote><p>在try阶段之前，就执行了cancel逻辑。</p></blockquote><p>cancel只会更新流水，由于try阶段还未执行，三大流水表中不存在流水信息，cancel逻辑只会空跑。</p><ul><li>悬挂问题</li></ul><blockquote><p>额度占用成功，但借据生成执行超时，导致事务管理器已经发起了取消请求后，借据生成执行又成功了。</p></blockquote><p>现有逻辑中没有考虑悬挂问题，对于这种超时后又提示占用成功的流水，会由后面的流水同步任务来让此流水走向终态。</p><h2 id=日切>日切</h2><blockquote><p>日切是信贷核心最重要的功能之一，在整个信贷服务集群中，“第二天”是否开始，部分场景是否可以营业（如还款需等日间处理），都以核心系统日切批量是否执行完成为依据。</p></blockquote><p>日切中关于账务主要存在的处理为：计提、转列、拨备（目前互联网个人信贷核心几乎不涉及拨备，拨备有单独服务处理）。</p><ol><li>日切开始前会先将系统日期切换到系统系统第二天，并关闭流量。（关闭流量只关闭还款流量，后面详细介绍这部分流量如何处理）。</li><li>切换日期后，不会立刻开始计提批量，需等待一段时间让服务中仍在运行的还款交易都走到终态。（理论等待10分钟）</li></ol><h3 id=计提>计提</h3><blockquote><p>对于一个核心系统，其管理的借据量非常大，为了展现出分布式系统的伸缩性，每个节点都处理自己归属的借据。多个节点一起跑批，从而达到分布式跑批的效果。</p></blockquote><ul><li><strong>计提载数（分布式）</strong></li></ul><p>多个节点同时运行，一个节点对应一个数据库，每个节点只处理自己数据库内部的数据。（如果想扩容，可扩展数据库，扩展对应节点）</p><ol><li>清理计提临时表残留的数据。</li><li>把今日为停息的借据存入计提临时表。</li></ol><ul><li><strong>利息计提（流水登记）</strong></li></ul><blockquote><p>计提试算与还款试算相同，两者共用期供试算，这里不详细列出。放到还款里列出。</p></blockquote><ol><li>在作计提试算前，使用当前读查询，锁住当前账户信息</li><li>根据试算结果，登记利息计提流水（借据维度）</li><li>登记期供交易流水（期供维度的利息计提）</li><li>修改借据信息（应计金额、上次计提日期：当天）</li><li>修改临时表状态（修改此表为了记录表中哪些数据已经处理）</li><li>更新期供信息（更新期供维度的利息信息）</li></ol><ul><li><strong>利息计提汇总</strong></li></ul><p>为了给账务系统对账，会把上面做出的利息计提汇总到当前计提总值中。</p><p>表内计提、减值计提、核销计提等</p><h3 id=转列>转列</h3><blockquote><p>日切过程中的转列，一般只涉及“向外”转列。转列批量在计提批量之后，且当日计提登记的流水为转列前状态。</p></blockquote><ul><li><strong>转列载数（分布式）</strong></li></ul><p>同利息计提载数，把借据载入到临时表中，来记录处理状态。</p><ul><li><strong>转列记账</strong></li></ul><blockquote><p>核心日切中涉及三种转列</p></blockquote><ol><li>逾期转减值</li><li>减值转逾期</li><li>正常转逾期</li></ol><p>为什么存在减值转逾期？</p><p>为了满足不同银行的记账方式，逾期单独开设一直转列码，是否使用视情况。</p><ol><li>登记</li></ol></section><footer class=article-footer><section class=article-tags><a href=/tags/%E8%B4%A6%E5%8A%A1/>账务</a>
<a href=/tags/%E5%88%86%E5%B8%83%E5%BC%8F/>分布式</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/%E4%B8%AA%E8%B4%B7%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E4%B8%8E%E6%A0%B8%E7%AE%97%E8%A7%84%E5%88%99%E6%A6%82%E8%A7%88/><div class=article-image><img src=/p/%E4%B8%AA%E8%B4%B7%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E4%B8%8E%E6%A0%B8%E7%AE%97%E8%A7%84%E5%88%99%E6%A6%82%E8%A7%88/1.da5f165a23416bbe84bc098d2746af47_hu_afe1e4bda44d9a56.png width=250 height=150 loading=lazy alt="Featured image of post 个贷核心系统业务与核算规则概览" data-hash="md5-2l8WWiNBa76EvAmNJ0avRw=="></div><div class=article-details><h2 class=article-title>个贷核心系统业务与核算规则概览</h2></div></a></article><article class=has-image><a href=/p/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%85%B1%E8%AF%86%E7%AE%80%E4%BB%8Bbtcethsolana/><div class=article-image><img src=/p/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%85%B1%E8%AF%86%E7%AE%80%E4%BB%8Bbtcethsolana/1.0303970ee7969d0dbfc0f4a3b074385f_hu_b03b77aab492d5cc.png width=250 height=150 loading=lazy alt="Featured image of post 区块链共识简介（BTC、ETH、Solana）" data-hash="md5-AwOXDueWnQ2/wPSjsHQ4Xw=="></div><div class=article-details><h2 class=article-title>区块链共识简介（BTC、ETH、Solana）</h2></div></a></article><article class=has-image><a href=/p/seatatransactional/><div class=article-image><img src=/p/seatatransactional/1.63f3b7c846c21077c3afe5fc869136a2_hu_282ad894616ffc29.png width=250 height=150 loading=lazy alt="Featured image of post 从seata源码入手分布式事务" data-key=seataTransactional data-hash="md5-Y/O3yEbCEHfDr+X8hpE2og=="></div><div class=article-details><h2 class=article-title>从seata源码入手分布式事务</h2></div></a></article><article class=has-image><a href=/p/icyfenix-hoeksteen/><div class=article-image><img src=/p/icyfenix-hoeksteen/1.9ce725d0528cc3b0d5321b62181de3a9_hu_9ac50c4f106c2b5f.png width=250 height=150 loading=lazy alt="Featured image of post 读《凤凰架构》有感--分布式基石" data-key=icyfenix-Hoeksteen data-hash="md5-nOcl0FKMw7DVMhtiGB3jqQ=="></div><div class=article-details><h2 class=article-title>读《凤凰架构》有感--分布式基石</h2></div></a></article><article class=has-image><a href=/p/icyfenix-argitektuur/><div class=article-image><img src=/p/icyfenix-argitektuur/1.ba219af96a0f1cdca5fb92348980d969_hu_2f661c5d754e7fa4.png width=250 height=150 loading=lazy alt="Featured image of post 读《凤凰架构》有感--架构篇" data-key=icyfenix-Argitektuur data-hash="md5-uiGa+WoPHNyl+5I0iYDZaQ=="></div><div class=article-details><h2 class=article-title>读《凤凰架构》有感--架构篇</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//thecoolboyhan.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2026 韩永发的博客</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.33.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>