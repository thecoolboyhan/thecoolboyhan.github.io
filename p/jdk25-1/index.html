<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="JDK25今年年底就要发布了，这次深入了解结构化并发和分代Shenandoah GC垃圾回收器"><title>备战JDK25--垃圾回收器</title><link rel=canonical href=https://thecoolboyhan.github.io/p/jdk25-1/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="备战JDK25--垃圾回收器"><meta property='og:description' content="JDK25今年年底就要发布了，这次深入了解结构化并发和分代Shenandoah GC垃圾回收器"><meta property='og:url' content='https://thecoolboyhan.github.io/p/jdk25-1/'><meta property='og:site_name' content='韩永发的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='java'><meta property='article:tag' content='JVM'><meta property='article:tag' content='GC'><meta property='article:tag' content='垃圾回收器'><meta property='article:published_time' content='2025-06-10T00:00:00+00:00'><meta property='article:modified_time' content='2025-06-10T00:00:00+00:00'><meta property='og:image' content='https://thecoolboyhan.github.io/p/jdk25-1/1.png'><meta name=twitter:title content="备战JDK25--垃圾回收器"><meta name=twitter:description content="JDK25今年年底就要发布了，这次深入了解结构化并发和分代Shenandoah GC垃圾回收器"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://thecoolboyhan.github.io/p/jdk25-1/1.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_3d339d0f8c590cc9.png width=300 height=400 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>韩永发的博客</a></h1><h2 class=site-description>目前人在上海，20年毕业，普通muggle，java开发。邮箱：hanyongfa2013@163.com 。</h2></div></header><ol class=menu-social><li><a href=https://github.com/thecoolboyhan target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://leetcode.cn/u/thecoolboy/ target=_blank title=力扣 rel=me><svg role="img" viewBox="0 0 24 24"><title>LeetCode</title><path d="M13.483.0a1.374 1.374.0 00-.961.438L7.116 6.226l-3.854 4.126a5.266 5.266.0 00-1.209 2.104 5.35 5.35.0 00-.125.513 5.527 5.527.0 00.062 2.362 5.83 5.83.0 00.349 1.017 5.938 5.938.0 001.271 1.818l4.277 4.193.039.038c2.248 2.165 5.852 2.133 8.063-.074l2.396-2.392c.54-.54.54-1.414.003-1.955a1.378 1.378.0 00-1.951-.003l-2.396 2.392a3.021 3.021.0 01-4.205.038l-.02-.019-4.276-4.193c-.652-.64-.972-1.469-.948-2.263a2.68 2.68.0 01.066-.523 2.545 2.545.0 01.619-1.164L9.13 8.114c1.058-1.134 3.204-1.27 4.43-.278l3.501 2.831c.593.48 1.461.387 1.94-.207a1.384 1.384.0 00-.207-1.943l-3.5-2.831c-.8-.647-1.766-1.045-2.774-1.202l2.015-2.158A1.384 1.384.0 0013.483.0zm-2.866 12.815a1.38 1.38.0 00-1.38 1.382 1.38 1.38.0 001.38 1.382H20.79a1.38 1.38.0 001.38-1.382 1.38 1.38.0 00-1.38-1.382z"/></svg></a></li><li><a href=mailto:hanyongfa2013@163.com target=_blank title=邮箱 rel=me><svg id="mdi-email-arrow-right-outline" viewBox="0 0 24 24"><path d="M13 19C13 18.66 13.04 18.33 13.09 18H4V8l8 5 8-5v5.09C20.72 13.21 21.39 13.46 22 13.81V6C22 4.9 21.1 4 20 4H4C2.9 4 2 4.9 2 6V18c0 1.1.9 2 2 2h9.09C13.04 19.67 13 19.34 13 19M20 6l-8 5L4 6H20m0 16V20H16V18h4V16l3 3-3 3z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#垃圾回收部分>垃圾回收部分</a></li><li><a href=#g1高吞吐量>G1(高吞吐量)</a><ol><li><a href=#简介>简介</a></li><li><a href=#垃圾回收过程>垃圾回收过程</a></li><li><a href=#特性>特性</a></li><li><a href=#对比>对比</a><ol><li><a href=#缺点>缺点</a></li></ol></li></ol></li><li><a href=#zgc低延迟>ZGC（低延迟）</a><ol><li><a href=#垃圾回收过程-1>垃圾回收过程</a></li><li><a href=#特性-1>特性</a><ol><li><a href=#彩色指针>彩色指针</a></li><li><a href=#加载屏障load-barrier>加载屏障（load barrier）</a></li><li><a href=#虚拟内存重映射同时也是cpu零拷贝的重要手段之一>虚拟内存重映射（同时也是CPU零拷贝的重要手段之一）</a></li></ol></li><li><a href=#对比-1>对比</a><ol><li></li></ol></li></ol></li><li><a href=#shenandoah非分代>Shenandoah（非分代）</a><ol><li><a href=#垃圾回收过程-2>垃圾回收过程</a></li><li><a href=#对比-2>对比</a></li></ol></li><li><a href=#分代shenandoah>分代Shenandoah</a><ol><li><a href=#新生代gcminor-gc>新生代GC(Minor GC)</a></li><li><a href=#老年代gcmajor-gc>老年代GC（Major GC）</a></li><li><a href=#特点>特点</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/jdk25-1/><img src=/p/jdk25-1/1_hu_6719b7595954acff.png srcset="/p/jdk25-1/1_hu_6719b7595954acff.png 800w, /p/jdk25-1/1_hu_3b23c2e9732ffa14.png 1600w" width=800 height=533 loading=lazy alt="Featured image of post 备战JDK25--垃圾回收器"></a></div><div class=article-details><header class=article-category><a href=/categories/java/>Java
</a><a href=/categories/%E7%B2%BE%E9%80%89/>精选</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/jdk25-1/>备战JDK25--垃圾回收器</a></h2><h3 class=article-subtitle>JDK25今年年底就要发布了，这次深入了解结构化并发和分代Shenandoah GC垃圾回收器</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jun 10, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 8 分钟</time></div></footer></div></header><section class=article-content><blockquote><p>阅读本文前，强烈建议先看看我之前的<a class=link href=https://thecoolboyhan.github.io/p/jvm%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8/ target=_blank rel=noopener>关于各种垃圾回收的介绍文章</a></p></blockquote><h2 id=垃圾回收部分>垃圾回收部分</h2><p>由于JDK25会将Shenandoah最为默认垃圾回收器，本次将再次详细研究一下本时代的垃圾回收器。</p><blockquote><p>本次只提目前仍可能存活在市场上的三种垃圾回收器（G1，ZGC，Shenandoah GC）</p></blockquote><h2 id=g1高吞吐量>G1(高吞吐量)</h2><blockquote><p>现在看来G1已经是老古董了，当初的出现只是为了取代CMS。但后续两种垃圾回收器都是基于G1的思想来做的。</p></blockquote><h3 id=简介>简介</h3><p>从JDK9开始，成为默认的垃圾回收器，低延迟、高吞吐，适用于10G以上的大内存。只优先回收垃圾最多的区，因此叫做<strong>Garbage-First</strong></p><p>引入了区（Region）的概念，区在创建时没有定义属性。在程序的运行过程中，会被分成不同的类型。</p><ul><li>区分类</li></ul><div class=table-wrapper><table><thead><tr><th>区类型</th><th>作用</th></tr></thead><tbody><tr><td><strong>Eden Regions</strong></td><td>存放新创建的对象</td></tr><tr><td><strong>Survivor Regions</strong></td><td>存放从 Eden 晋升的对象</td></tr><tr><td><strong>Old Regions</strong></td><td>存放长期存活的对象</td></tr><tr><td><strong>Humongous Regions</strong></td><td>存放大对象（超过 Region 一半大小）</td></tr><tr><td><strong>Free Regions</strong></td><td>未被使用、等待分配</td></tr></tbody></table></div><h3 id=垃圾回收过程>垃圾回收过程</h3><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-06/2023-2-2319_13_12-1677150791924_1749448480478.png loading=lazy alt=2023-2-2319_13_12-1677150791924.png></p><ol><li><strong>初始标记</strong>（Short STW）</li></ol><p>标记所有可以直接从GC Roots可达的对象。此阶段只对新生代Eden区进行标记。</p><ol start=2><li><strong>并发标记</strong>（与用户线程并行）</li></ol><p>从初始标记的结果出发，遍历整个堆，并标记所有可达对象。</p><p>创建一份全堆的对象存活快照。</p><ol start=3><li><strong>重新标记</strong>（也叫最终标记，较短的STW）</li></ol><p>纠正并发标记期间因修改产生的不一致。确保垃圾回收器有准确的存活集信息。</p><ol start=4><li><strong>混合回收</strong>（并行）</li></ol><p>完整的回收（年轻代和老年代都回收）。调度器会选择垃圾最多的区来进行清理。</p><ol start=5><li>清理</li></ol><p>重新构建各区块的元素，更新各区的分类，更新记忆集，管理跨区之间的引用。</p><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-06/b47f048fb6844ecc90b80aff88117a04_1749519287352.png loading=lazy alt=b47f048fb6844ecc90b80aff88117a04.png></p><h3 id=特性>特性</h3><ul><li>卡表</li></ul><p>用来记录哪些区发生了修改。每个区都有对应的卡表，当需要写入对象时，写入屏障会把对应的卡表标记为脏，GC遍历时只需要遍历脏卡表。</p><blockquote><p>但是会占用额外的空间，而且写操作受到了影响。</p></blockquote><ul><li>记忆集</li></ul><p>在区之间进行回收时，记忆集用来记录跨区的引用，这样每个区只需要扫描局部被修改的部分。跨区部分信息记录在记忆集中。</p><blockquote><p>也会占用额外的空间</p></blockquote><ul><li>动态调整区类型</li></ul><p>动态的调整区类型，来避免full GC</p><h3 id=对比>对比</h3><p>G1是在垃圾回收效率和停顿延迟上取平衡的回收器。</p><h4 id=缺点>缺点</h4><ul><li>垃圾回收仍然STW</li></ul><p>当堆内存特别大时（上T级别），初始标记和remark阶段的STW会非常明显。</p><p>ZGC和Shenandoah更优</p><ul><li><p>大内存支持不好（T级别内存）</p></li><li><p>回收调度和标记开销</p></li></ul><p>由于在写入时会向卡表写入数据，且还维护着记忆集，都会带来大量内存开销和算法开销。</p><ul><li>调优难</li></ul><p>由于可以预先设置区大小等，且区是动态变化的，各方面想找到平衡难。</p><h2 id=zgc低延迟>ZGC（低延迟）</h2><blockquote><p>又一个CMS，一直在优化，一直很nb，但没有当过真正的默认垃圾回收器</p></blockquote><p>JDK11被引入。主打极低的停顿时间（一般停顿时间都小于10毫米）</p><p>同时支持多TB级别的堆内存</p><p>完全取消了年轻代老年代的划分，直接根据分区来管理内存。</p><h3 id=垃圾回收过程-1>垃圾回收过程</h3><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-06/c84674f0f2f94702af64b7dd51f99e1d_1749541261705.png loading=lazy alt=c84674f0f2f94702af64b7dd51f99e1d.png></p><ol><li><strong>初始标记</strong>（极短的STW）</li></ol><p>扫描所有GC Roots可达对象</p><blockquote><p>只处理直接引用，工作十分轻量，STW时间非常短</p></blockquote><ol start=2><li><strong>并发标记</strong></li></ol><p>在初始标记的基础上，并发遍历整个堆，从根出发标记所有可达的存活对象</p><ul><li><strong>load barrier协议来准确的标记对象状态</strong></li></ul><blockquote><p>通过 load barrier的协议，使得对象状态可以被准确的确定，同时不影响应用程序的执行</p></blockquote><ol start=3><li><strong>并发迁移</strong></li></ol><p>根据标记的结果，将存活对象从原区域搬迁到新的区域</p><ul><li><strong>通过虚拟内存地址更换迁移</strong></li></ul><blockquote><p>利用虚拟内存重映射技术，通过调整对象的虚拟地址完成迁移，不需要做大量的复制</p></blockquote><ul><li><strong>彩色指针来实现引用升级</strong></li></ul><blockquote><p>利用加载屏障和彩色指针，实现用户线程加载对象时，判断彩色指针去迁移后的地址读取对象，同时更新对象的引用</p></blockquote><ol start=4><li><strong>最终更新/修正阶段（Final Update）STW</strong></li></ol><p>快速修改遗漏或不一致的引用，确保整个堆中所有对象引用都正确的指向了新地址</p><h3 id=特性-1>特性</h3><h4 id=彩色指针>彩色指针</h4><p>64位操作系统中的对象空间是64位，但实际对象的有效地址位数远低于64位。ZGC利用未使用的高位，将部分位“涂色”，用来存储额外的元数据信息。</p><ul><li>避免额外的数据结构</li></ul><p>与G1标记对象是否可以回收（通过卡表）不同，不需要占用额外的空间，且不需要进行多余的随机读写，直接通过对象的地址来判断对象是否有效。</p><h4 id=加载屏障load-barrier>加载屏障（load barrier）</h4><p>在对象引用加载时，自动插入一段代码（有点类似于AOP的概念）</p><ul><li><p>动态的检测颜色</p><p>判断上面的彩色指针位的颜色，来判断对象是否被移动。</p></li><li><p>透明指针重定向</p><p>检测到对象已迁移，主动修改元数据中的新地址（新地址通过内部的转发表或基于虚拟内存映射的信息来确认）。并加载重定位的新地址。</p></li><li><p>并发容忍性</p><p>通过上面两项，可以保证用户线程看到的总是最新且正确的对象引用。从而实现了无暂停的迁移与回收。</p></li></ul><h4 id=虚拟内存重映射同时也是cpu零拷贝的重要手段之一>虚拟内存重映射（同时也是CPU零拷贝的重要手段之一）</h4><p>ZGC降低复制开销的主要手段</p><ul><li>通过修改操作数据页表项，来改变虚拟地址与物理内存之间的映射关系。</li></ul><h3 id=对比-1>对比</h3><div class=table-wrapper><table><thead><tr><th>垃圾回收器</th><th>目标</th><th>实现手段</th></tr></thead><tbody><tr><td>ZGC</td><td>极低停顿（10毫秒）<br>支持大内存（TB）超级大内存支持情况比Shenandoah好</td><td>并发执行<br>彩色指针<br>加载屏障<br>虚拟内存映射</td></tr><tr><td>G1</td><td>均衡的吞吐量与停顿时间<br>可以通过修改最大停顿时间参数来动态分配区</td><td>利用区来划分堆<br>按垃圾率决定优先回收的区<br>采用复制算法减少内存碎片<br>部分场景STW，但STW时间可预测</td></tr><tr><td>Shenandoah</td><td>极低停顿时间（几毫秒内）<br>支持大堆内存</td><td>与ZGC类似，并发压缩<br>大部分垃圾回收工作与应用内存并发执行</td></tr></tbody></table></div><h5 id=优点>优点</h5><ul><li>极低暂停时间（10毫秒）</li><li>高扩展性：可以适配超大堆，停顿时间与堆大小无关</li><li>并发对象搬迁与透明更新：极大的降低了实时数据迁移产生不一致的风险</li><li>较低的内存复制开销：利用虚拟内存映射减少内存复制</li></ul><h5 id=缺点-1>缺点</h5><ul><li>加载屏障需要额外开销：每次对象被访问时，都需要通过加载屏障，会带来额外的开销</li><li>平台支持有限：ZGC主要是为64为Linux操作系统设计，对其他平台支持不成熟</li><li>吞吐量有限：由于设计之初是为了更低的停顿时间，因此在极端吞吐量的场景下，效果不如传统垃圾回收器（Parallel GC）</li></ul><blockquote><p>ZGC为了提高CPU利用率而放弃了部分吞吐量</p></blockquote><ul><li>为什么放弃ZGC？</li></ul><p>个人认为，ZGC的延迟和大堆表现真的很棒。但大部分企业根据没有几十TB的堆。且ZGC需要太多的CPU开销，牺牲了部分的吞吐量（相当于没有高效的利用内存空间）这些部份甚至开了倒车。</p><blockquote><p>总结就是有点偏科，且擅长的方向现实生活还没有跟上。</p></blockquote><h2 id=shenandoah非分代>Shenandoah（非分代）</h2><p>JDK12开始引入（社区可以支持到JDK8），通用采取分区概念，全堆并发标记、并发搬迁、并发更新引用。</p><p>只有几毫秒的STW，不区分新生代、老年代。所有对象都是同一套并发处理流程。</p><h3 id=垃圾回收过程-2>垃圾回收过程</h3><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-07/1751436527413_1751436527436.png loading=lazy alt=1751436527413.png></p><ol><li><p>初始标记（STW）</p><p>扫描GC Roots中直接引用的对象</p></li><li><p>并发标记</p><p>遍历整个堆，从根对象出发将所有可达对象标记出来。</p><blockquote><p>此过程中类似G1，使用了卡表、记忆集技术，来限制每次扫描的范围。避免出现全堆扫描</p></blockquote></li><li><p>重新标记（STW）</p><p>几毫秒的STW，重新扫描并发标记中的引用变化</p></li><li><p>并发整理/搬迁</p><p>和ZGC类似，采用“彩色指针”、“加载屏障”、“虚拟内存映射”技术来实现并发的对象整理</p></li><li><p>最终引用更新（STW）</p><p>更新上一步中未更新的引用</p></li></ol><h3 id=对比-2>对比</h3><p>非分代Shenandoah和ZGC大部分场景都是相同的，不同点很少</p><div class=table-wrapper><table><thead><tr><th>阶段</th><th>ZGC</th><th>非分代Shenandoah</th></tr></thead><tbody><tr><td>并发标记</td><td>利用加载屏障，实现标记过程中实时捕获对象状态，在超大堆上支持更好（TB）</td><td>利用卡表、记忆集来并发标记，最后有短暂的暂停（再标记阶段），支持上百G的内存</td></tr><tr><td>迁移过程</td><td>利用虚拟内存映射，强调零拷贝，几乎无复制</td><td>虽然同样采用了彩色指针、加载屏障来保证迁移的准确，但还是存在部分的实际对象复制，所以效率不如ZGC</td></tr></tbody></table></div><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-07/1751436709608_1751436709649.png loading=lazy alt=1751436709608.png></p><ul><li>为什么选择Shenandoah而不是ZGC？</li></ul><p>从上面的比较感觉，好像ZGC要比Shenandoah更好，但这只是部份场景的比较。</p><p>选择Shenandoah主要原因是<strong>CPU开销</strong>和<strong>成熟的应用</strong>经验，ZGC强调的零拷贝，但可能带来更大的CPU开销。</p><h2 id=分代shenandoah>分代Shenandoah</h2><p>JDK21引入，又重新引入了分代思想，利用对象年轻即死的假设，把堆重新分成了新生代和老年代。不同代采用不同的回收策略</p><h3 id=新生代gcminor-gc>新生代GC(Minor GC)</h3><ol><li><p>分配</p><p>对象首先在新生代Eden区分配。由于新生代区域小、生命周期短，分配速度块。</p></li><li><p>复制收集</p><p>当Eden区达到一定阈值，会触发STW，针对新生代单独回收。</p><p>回收方式采用复制法，把存活的对象复制到幸存者区（Survivor），如果达到一定标准，会直接晋升到老年代。</p><p>复制过程采用加载屏障，保证数据不会在搬迁过程中不可用。</p></li></ol><ul><li>晋升标准</li></ul><p>普通对象晋升到幸存者区。</p><p>如果幸存者区内存不足时，就会直接晋升到老年代。</p><h3 id=老年代gcmajor-gc>老年代GC（Major GC）</h3><blockquote><p>老年代GC是全堆的GC</p></blockquote><ol><li><strong>初始标记</strong>（STW，非常短）：类似非分代模式，标记GC Roots直接可达的对象。</li><li><strong>并发标记</strong>：然后多个线程遍历整个老年代。利用记忆集和卡表来减少扫描范围。</li><li><strong>并发整理（搬迁）</strong>：把存活的对象搬迁到连续的区域。利用彩色指针记录搬迁的信息，利用加载屏障并行搬迁。（有可能会用到虚拟内存映射）</li><li><strong>最终更新</strong>（STW)：对未完全更新的引用做最后的修正，保证全堆一致。</li></ol><h3 id=特点>特点</h3><ul><li>新生代的轻量复制</li></ul><p>所谓的轻量复制，只新生代空间小。GC频繁，且只复制存活的对象。复制过程中有加载屏障。只会在初始标记GC Roots阶段产生短暂的STW。</p><p>这样提高GC频率，从而快速回收大部分垃圾。</p><ul><li>通过记忆集实现跨代引用</li></ul><p>由于存在分代晋升，当新生代对象进入老年代时，回收规则发生变化。</p><p>通过记忆集来传递这样的引用信息。每次进入老年代更新记忆集。这样就不用每次扫描整个堆来确认老年代新增的对象。</p><ul><li><strong>为什么选择分代 Shenandoah GC</strong></li></ul><p>目前看来，分代 Shenandoah GC 是垃圾回收效率，STW时间，吞吐量上保证了平衡。</p><p>新生代采用”G1 PRO“的方式来保证大部分垃圾可以被快速的回收。（吞吐量）</p><p>老年代采用传统Shenandoah来保证大内存（小于等于TB）的STW时间缩短。属于低延迟和高吞吐的融合。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/java/>Java</a>
<a href=/tags/jvm/>JVM</a>
<a href=/tags/gc/>GC</a>
<a href=/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8/>垃圾回收器</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 Jun 10, 2025 00:00 UTC</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/jvm%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8/><div class=article-details><h2 class=article-title>JVM垃圾回收器</h2></div></a></article><article class=has-image><a href=/p/jdk25-2/><div class=article-image><img src=/p/jdk25-2/1.1ba2120bdc98acfe6bad936098ca47e2_hu_3cfcf258c0c980ae.png width=250 height=150 loading=lazy alt="Featured image of post 备战JDK25--并发" data-key=JDK25-2 data-hash="md5-G6ISC9yYrP5rrZNgmMpH4g=="></div><div class=article-details><h2 class=article-title>备战JDK25--并发</h2></div></a></article><article class=has-image><a href=/p/%E8%AF%BB%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA2019%E7%89%88%E6%9C%89%E6%84%9F/><div class=article-image><img src=/p/%E8%AF%BB%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA2019%E7%89%88%E6%9C%89%E6%84%9F/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BAv3.7a938c68cb8d638aedb4ae81627b8f0b_hu_9bb77bf9d1481dbf.png width=250 height=150 loading=lazy alt="Featured image of post 读《深入理解java虚拟机2019版》有感" data-hash="md5-epOMaMuNY4rttK6BYnuPCw=="></div><div class=article-details><h2 class=article-title>读《深入理解java虚拟机2019版》有感</h2></div></a></article><article class=has-image><a href=/p/spring%E4%B8%AD%E6%96%87%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3v6%E6%9C%89%E6%84%9F/><div class=article-image><img src=/p/spring%E4%B8%AD%E6%96%87%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3v6%E6%9C%89%E6%84%9F/springFrameworkV6.45c4949ea90685e7afd2cf20ba4c38ce_hu_f0359f2a328cfc6b.png width=250 height=150 loading=lazy alt="Featured image of post spring中文说明文档v6有感" data-hash="md5-RcSUnqkGheev0s8gukw4zg=="></div><div class=article-details><h2 class=article-title>spring中文说明文档v6有感</h2></div></a></article><article class=has-image><a href=/p/nettyio%E6%A8%A1%E5%9E%8B/><div class=article-image><img src=/p/nettyio%E6%A8%A1%E5%9E%8B/20205-05-29.332e46be036aa4d6e58c13a2bf201374_hu_2cc0139b4e7ec47e.png width=250 height=150 loading=lazy alt="Featured image of post NettyIO模型" data-hash="md5-My5GvgNqpNbljBOivyATdA=="></div><div class=article-details><h2 class=article-title>NettyIO模型</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//thecoolboyhan.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 韩永发的博客</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.31.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>