<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="深入介绍NettyIO模型"><title>NettyIO模型</title><link rel=canonical href=https://thecoolboyhan.github.io/p/nettyio%E6%A8%A1%E5%9E%8B/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="NettyIO模型"><meta property='og:description' content="深入介绍NettyIO模型"><meta property='og:url' content='https://thecoolboyhan.github.io/p/nettyio%E6%A8%A1%E5%9E%8B/'><meta property='og:site_name' content='韩永发的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='netty'><meta property='article:tag' content='java'><meta property='article:tag' content='io模型'><meta property='article:published_time' content='2025-07-02T00:00:00+00:00'><meta property='article:modified_time' content='2025-07-02T00:00:00+00:00'><meta property='og:image' content='https://thecoolboyhan.github.io/p/nettyio%E6%A8%A1%E5%9E%8B/20205-05-29.png'><meta name=twitter:title content="NettyIO模型"><meta name=twitter:description content="深入介绍NettyIO模型"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://thecoolboyhan.github.io/p/nettyio%E6%A8%A1%E5%9E%8B/20205-05-29.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_3d339d0f8c590cc9.png width=300 height=400 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>韩永发的博客</a></h1><h2 class=site-description>目前人在上海，20年毕业，普通muggle，java开发。邮箱：hanyongfa2013@163.com 。</h2></div></header><ol class=menu-social><li><a href=https://github.com/thecoolboyhan target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://leetcode.cn/u/thecoolboy/ target=_blank title=力扣 rel=me><svg role="img" viewBox="0 0 24 24"><title>LeetCode</title><path d="M13.483.0a1.374 1.374.0 00-.961.438L7.116 6.226l-3.854 4.126a5.266 5.266.0 00-1.209 2.104 5.35 5.35.0 00-.125.513 5.527 5.527.0 00.062 2.362 5.83 5.83.0 00.349 1.017 5.938 5.938.0 001.271 1.818l4.277 4.193.039.038c2.248 2.165 5.852 2.133 8.063-.074l2.396-2.392c.54-.54.54-1.414.003-1.955a1.378 1.378.0 00-1.951-.003l-2.396 2.392a3.021 3.021.0 01-4.205.038l-.02-.019-4.276-4.193c-.652-.64-.972-1.469-.948-2.263a2.68 2.68.0 01.066-.523 2.545 2.545.0 01.619-1.164L9.13 8.114c1.058-1.134 3.204-1.27 4.43-.278l3.501 2.831c.593.48 1.461.387 1.94-.207a1.384 1.384.0 00-.207-1.943l-3.5-2.831c-.8-.647-1.766-1.045-2.774-1.202l2.015-2.158A1.384 1.384.0 0013.483.0zm-2.866 12.815a1.38 1.38.0 00-1.38 1.382 1.38 1.38.0 001.38 1.382H20.79a1.38 1.38.0 001.38-1.382 1.38 1.38.0 00-1.38-1.382z"/></svg></a></li><li><a href=mailto:hanyongfa2013@163.com target=_blank title=邮箱 rel=me><svg id="mdi-email-arrow-right-outline" viewBox="0 0 24 24"><path d="M13 19C13 18.66 13.04 18.33 13.09 18H4V8l8 5 8-5v5.09C20.72 13.21 21.39 13.46 22 13.81V6C22 4.9 21.1 4 20 4H4C2.9 4 2 4.9 2 6V18c0 1.1.9 2 2 2h9.09C13.04 19.67 13 19.34 13 19M20 6l-8 5L4 6H20m0 16V20H16V18h4V16l3 3-3 3z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#bio>BIO</a><ol><li><a href=#问题>问题</a></li><li><a href=#使用池化技术来优化>使用池化技术来优化</a></li><li><a href=#使用虚拟线程>使用虚拟线程</a></li></ol></li><li><a href=#nio>NIO</a><ol><li><a href=#问题-1>问题</a></li></ol></li><li><a href=#io多路复用>IO多路复用</a><ol><li><a href=#selector>Selector</a></li><li><a href=#linuxepoll>linux：epoll</a></li><li><a href=#macos和bsdkqueue>macOS和BSD：kqueue</a></li><li><a href=#windowsiocp>Windows：IOCP</a></li><li><a href=#其他系统select或poll>其他系统：select或poll</a></li><li><a href=#总结>总结</a></li><li><a href=#依然有缺点>依然有缺点</a></li></ol></li><li><a href=#反应器模式reactor>反应器模式（Reactor）</a><ol><li><a href=#工作原理>工作原理</a></li><li><a href=#优势>优势</a></li><li><a href=#缺点>缺点</a></li></ol></li><li><a href=#netty-io模型单机处理百万级并发>Netty IO模型（单机处理百万级并发）</a><ol><li><a href=#主要组件>主要组件</a></li><li><a href=#工作原理-1>工作原理</a></li><li><a href=#优点>优点</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/nettyio%E6%A8%A1%E5%9E%8B/><img src=/p/nettyio%E6%A8%A1%E5%9E%8B/20205-05-29_hu_a8eb5aa3bfdfe6fe.png srcset="/p/nettyio%E6%A8%A1%E5%9E%8B/20205-05-29_hu_a8eb5aa3bfdfe6fe.png 800w, /p/nettyio%E6%A8%A1%E5%9E%8B/20205-05-29_hu_ba1876e948d03f21.png 1600w" width=800 height=533 loading=lazy alt="Featured image of post NettyIO模型"></a></div><div class=article-details><header class=article-category><a href=/categories/%E7%B2%BE%E9%80%89/>精选</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/nettyio%E6%A8%A1%E5%9E%8B/>NettyIO模型</a></h2><h3 class=article-subtitle>深入介绍NettyIO模型</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jul 02, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 12 分钟</time></div></footer></div></header><section class=article-content><h1 id=nettyio模型>nettyIO模型</h1><h2 id=bio>BIO</h2><p>先上代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//所有的操作都是阻塞的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SocketServer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerSocket</span><span class=w> </span><span class=n>serverSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServerSocket</span><span class=p>(</span><span class=n>9000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;等待连接&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//            阻塞的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Socket</span><span class=w> </span><span class=n>clientSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>serverSocket</span><span class=p>.</span><span class=na>accept</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;有客户端连接了。。&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         		</span><span class=n>handler</span><span class=p>(</span><span class=n>clientSocket</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handler</span><span class=p>(</span><span class=n>Socket</span><span class=w> </span><span class=n>clientSocket</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>1024</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;准备read。。。&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        接收客户端的数据，阻塞方法，没有数据可读时就阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>read</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>clientSocket</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>().</span><span class=na>read</span><span class=p>(</span><span class=n>bytes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;read完毕&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>read</span><span class=o>!=-</span><span class=n>1</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;接收到客户端的数据：&#34;</span><span class=o>+</span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>bytes</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>read</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;end&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>目前的缺陷</li></ul><p>主程序采用单线程阻塞处理。同一时间只能处理一个连接，如果此连接没有处理结束，其他的客户端也无法连接。</p><ul><li>如何优化？</li></ul><p>在BIO的基础上，增加多线程操作，每次来一个线程就启动一个新的线程来处理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//所有的操作都是阻塞的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SocketServer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerSocket</span><span class=w> </span><span class=n>serverSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServerSocket</span><span class=p>(</span><span class=n>9000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;等待连接&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//            阻塞的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Socket</span><span class=w> </span><span class=n>clientSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>serverSocket</span><span class=p>.</span><span class=na>accept</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;有客户端连接了。。&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//            在单线程上做优化，每接收的一个连接，就开启一个新的线程来处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>ofPlatform</span><span class=p>().</span><span class=na>start</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>handler</span><span class=p>(</span><span class=n>clientSocket</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handler</span><span class=p>(</span><span class=n>Socket</span><span class=w> </span><span class=n>clientSocket</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>1024</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;准备read。。。&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        接收客户端的数据，阻塞方法，没有数据可读时就阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>read</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>clientSocket</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>().</span><span class=na>read</span><span class=p>(</span><span class=n>bytes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;read完毕&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>read</span><span class=o>!=-</span><span class=n>1</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;接收到客户端的数据：&#34;</span><span class=o>+</span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>bytes</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>read</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;end&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=问题>问题</h3><p>虽然可以同时处理多个请求了，但是当“C10K”时。会同时创建大量的线程，会占用大量的内存。</p><blockquote><p>C10K：同时有1万请求打到服务器</p><p>C10M：同时有1千万请求打到服务器</p></blockquote><h3 id=使用池化技术来优化>使用池化技术来优化</h3><p>如果使用线程池来处理请求，虽然可以同时处理部分请求，但是如果线程池的核心线程都被阻塞，就无法再处理其他请求了。（全部在阻塞队列中等待）</p><h3 id=使用虚拟线程>使用虚拟线程</h3><p>其实上面所有的问题就可以在BIO的基础上直接使用虚拟线程技术来解决，但今天的重点不是这个下面只给出优化代码。</p><blockquote><p>但虚拟线程不适合则长时间的处理，尽量处理小任务，如果存在大量复杂的处理。虚拟线程仍然有问题。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Thread</span><span class=p>.</span><span class=na>ofVirtual</span><span class=p>().</span><span class=na>start</span><span class=p>(()</span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>handler</span><span class=p>(</span><span class=n>clientSocket</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>接下来就需要使用NIO了</p></blockquote><h2 id=nio>NIO</h2><p>先上代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>NioServer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;</span><span class=w> </span><span class=n>channelList</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        Nio的服务channel，类似于BIO的ServerSocket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>ServerSocketChannel</span><span class=w> </span><span class=n>serverSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ServerSocketChannel</span><span class=p>.</span><span class=na>open</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//            将此ServerSocket绑定到9000端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serverSocket</span><span class=p>.</span><span class=na>socket</span><span class=p>().</span><span class=na>bind</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InetSocketAddress</span><span class=p>(</span><span class=n>9000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//            将channel设置成非阻塞的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serverSocket</span><span class=p>.</span><span class=na>configureBlocking</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;服务器启动成功&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                NIO的非阻塞操作由操作系统实现的，底层调用了linux的accept函数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>SocketChannel</span><span class=w> </span><span class=n>socketChannel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>serverSocket</span><span class=p>.</span><span class=na>accept</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                检测到连接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>socketChannel</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;连接成功&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                    设置soocketChannel也是非阻塞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>socketChannel</span><span class=p>.</span><span class=na>configureBlocking</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                    把当前SocketChannel入队，方便后面轮询处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>channelList</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>socketChannel</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//            处理连接的请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;</span><span class=w> </span><span class=n>iterator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channelList</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>iterator</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>SocketChannel</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>iterator</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                    利用直接内存来处理请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ByteBuffer</span><span class=w> </span><span class=n>byteBuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ByteBuffer</span><span class=p>.</span><span class=na>allocate</span><span class=p>(</span><span class=n>6</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sc</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>byteBuffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>len</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;接收的消息：&#34;</span><span class=o>+</span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>byteBuffer</span><span class=p>.</span><span class=na>array</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>len</span><span class=o>==-</span><span class=n>1</span><span class=p>){</span><span class=c1>//如果断开连接，就出队</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>iterator</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;客户端断开了连接&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>虽然是一个线程来处理了所有的请求，且请求的处理理论没有数量限制。</p><p>但依然存在一些问题</p><h3 id=问题-1>问题</h3><ol><li>while（true）一直占用CPU，CPU的一个核心被占用了。</li><li>存在过多无用处理：如果暂存集合中数量特别多，且真正需要处理的请求可能只有一两个。但如果想要处理仍然需要遍历整个集合。</li></ol><ul><li>优化剪枝</li></ul><h2 id=io多路复用>IO多路复用</h2><p>直接上代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>NioSelectorServer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>ServerSocketChannel</span><span class=w> </span><span class=n>serverSocketChannel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ServerSocketChannel</span><span class=p>.</span><span class=na>open</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//            打开系统Selector处理Channel，创建epoll</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>Selector</span><span class=w> </span><span class=n>selector</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Selector</span><span class=p>.</span><span class=na>open</span><span class=p>();)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serverSocketChannel</span><span class=p>.</span><span class=na>socket</span><span class=p>().</span><span class=na>bind</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InetSocketAddress</span><span class=p>(</span><span class=n>9000</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serverSocketChannel</span><span class=p>.</span><span class=na>configureBlocking</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//            把Channel注册到Selector上，并让Selector选择连接事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>serverSocketChannel</span><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>selector</span><span class=p>,</span><span class=w> </span><span class=n>SelectionKey</span><span class=p>.</span><span class=na>OP_ACCEPT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;服务器启动成功&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                阻塞等待需要处理的事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>selector</span><span class=p>.</span><span class=na>select</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                返回有事件的key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span><span class=w> </span><span class=n>selectionKeys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selector</span><span class=p>.</span><span class=na>selectedKeys</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span><span class=w> </span><span class=n>iterator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selectionKeys</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                遍历处理有事件的请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=p>(</span><span class=n>iterator</span><span class=p>.</span><span class=na>hasNext</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>iterator</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                    如果是连接事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>isAcceptable</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>ServerSocketChannel</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ServerSocketChannel</span><span class=p>)</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>channel</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>SocketChannel</span><span class=w> </span><span class=n>socketChannel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>server</span><span class=p>.</span><span class=na>accept</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>socketChannel</span><span class=p>.</span><span class=na>configureBlocking</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                            给当前连接注册读取时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>socketChannel</span><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>selector</span><span class=p>,</span><span class=w> </span><span class=n>SelectionKey</span><span class=p>.</span><span class=na>OP_READ</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;客户端连接成功了&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                        如果是读事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>isReadable</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>SocketChannel</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>SocketChannel</span><span class=p>)</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>channel</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>ByteBuffer</span><span class=w> </span><span class=n>byteBuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ByteBuffer</span><span class=p>.</span><span class=na>allocate</span><span class=p>(</span><span class=n>6</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>server</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>byteBuffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=p>(</span><span class=n>len</span><span class=w> </span><span class=o>&gt;</span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;接收的请求:&#34;</span><span class=o>+</span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>byteBuffer</span><span class=p>.</span><span class=na>array</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>len</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;客户端连接断开&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>server</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                        当前事件已经被处理，删除当前数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>iterator</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>通过上面的方式，可以完美解决普通NIO中的问题</p><p>如果selector检测不到事件，就处于阻塞状态。不会占用CPU</p><p>不会存在多余处理，只有有事件的请求才会被程序处理。没有事件的连接都处于挂起状态。</p><h3 id=selector>Selector</h3><blockquote><p>允许一个线程同时管理多个Channel，选择器可以在非阻塞的模式下高效处理多个连接，减少线程切换的开销。</p></blockquote><ul><li>选择器的核心作用</li></ul><ol><li>监控多个通道的状态（监听事件）</li><li>减少线程数量，一个线程可以管理多个IO连接</li><li>提高性能，避免传统阻塞IO为每个连接创建线程的开销</li></ol><ul><li>工作原理</li></ul><ol><li><p><strong>注册通道</strong>：将 <code>SelectableChannel</code>（如 <code>SocketChannel</code>）注册到 <code>Selector</code>，并指定感兴趣的事件（如 <code>OP_READ</code>、<code>OP_WRITE</code>）。</p></li><li><p><strong>监听事件</strong>：调用 <code>select()</code> 方法，阻塞直到至少有一个通道就绪。</p></li><li><p><strong>处理事件</strong>：遍历 <code>SelectionKey</code> 集合，执行相应的 I/O 操作。</p></li></ol><ul><li>事件</li></ul><div class=table-wrapper><table><thead><tr><th>事件类型事件类型</th><th>描述描述</th></tr></thead><tbody><tr><td><code>OP_ACCEPT</code></td><td>服务器端 <code>ServerSocketChannel</code> 接收到新的连接请求</td></tr><tr><td><code>OP_CONNECT</code></td><td>客户端 <code>SocketChannel</code> 连接成功</td></tr><tr><td><code>OP_READ</code></td><td>通道中有数据可读</td></tr><tr><td><code>OP_WRITE</code></td><td>通道可以写入数据</td></tr></tbody></table></div><p>由java.nio.channels.spi类中创建，取系统默认的java.nio.channels.spi.SelectorProvider。</p><h3 id=linuxepoll>linux：epoll</h3><ul><li>工作原理</li></ul><p><code>epoll_create()</code>：创建 <code>epoll</code> 实例，返回一个文件描述符（FD）。</p><p><code>epoll_ctl()</code>：向 <code>epoll</code> 实例中添加、修改或删除文件描述符（FD）。</p><p><code>epoll_wait()</code>：等待事件发生，并返回就绪的文件描述符。</p><ul><li>相比传统的优点</li></ul><ol><li>事件驱动：相比 <code>select</code> 和 <code>poll</code>，<code>epoll</code> 采用 <strong>事件驱动</strong> 机制，避免了轮询所有文件描述符的开销。</li><li>就绪列表：<code>epoll</code> 维护一个 <strong>就绪列表</strong>，只返回发生事件的文件描述符，而不是遍历整个 FD 集合。</li><li><strong>支持大规模连接</strong>：<code>epoll</code> 可以处理 <strong>百万级别</strong> 的连接，而不会因为 FD 数量增加而导致性能下降。</li></ol><h3 id=macos和bsdkqueue>macOS和BSD：kqueue</h3><ul><li>工作原理：</li></ul><p><code>kqueue()</code>：创建一个事件队列。</p><p><code>kevent()</code>：用于注册、修改或删除事件，并等待事件发生。</p><ul><li>优点：</li></ul><ol><li><strong>低开销</strong>：<code>kqueue</code> 采用 <strong>事件驱动</strong> 机制，减少了 CPU 轮询开销。</li><li><strong>支持多种事件类型</strong>：不仅支持 <strong>I/O 事件</strong>，还支持 <strong>进程、信号、定时器</strong> 等事件。</li></ol><h3 id=windowsiocp>Windows：IOCP</h3><ul><li>工作原理：</li></ul><p><code>CreateIoCompletionPort()</code>：创建一个完成端口（Completion Port）。</p><p><code>PostQueuedCompletionStatus()</code>：用于提交 I/O 任务。</p><p><code>GetQueuedCompletionStatus()</code>：用于获取完成的 I/O 任务。</p><ul><li>优点：</li></ul><ol><li><strong>异步 I/O</strong>：IOCP 采用 <strong>异步事件驱动</strong> 机制，减少了线程切换开销。</li><li><strong>高吞吐量</strong>：IOCP 适用于 <strong>高并发服务器</strong>，如 Windows Server 上的 Web 服务器。</li></ol><h3 id=其他系统select或poll>其他系统：select或poll</h3><ul><li>工作原理</li></ul><p><code>select()</code>：遍历所有文件描述符，检查哪些是可读、可写或有异常。</p><p><code>poll()</code>：采用类似 <code>select</code> 的方式，但使用 <strong>动态数组</strong> 代替固定大小的 FD 集合。</p><ul><li>缺点：</li></ul><ol><li><strong>性能较低</strong>：<code>select</code> 需要遍历整个 FD 集合，导致 <strong>O(n)</strong> 级别的时间复杂度。</li><li><strong>FD 限制</strong>：<code>select</code> 只能处理 <strong>1024</strong> 个文件描述符，而 <code>poll</code> 没有这个限制。</li></ol><h3 id=总结>总结</h3><p>Java NIO 选择器的实现位于 <code>sun.nio.ch</code> 包中，不同操作系统会加载不同的 SelectorProvider：</p><ul><li><strong>Linux</strong>：<code>sun.nio.ch.EPollSelectorImpl</code></li><li><strong>macOS / BSD</strong>：<code>sun.nio.ch.KQueueSelectorImpl</code></li><li><strong>Windows</strong>：<code>sun.nio.ch.WindowsSelectorImpl</code></li><li><strong>其他系统</strong>：<code>sun.nio.ch.PollSelectorImpl</code></li></ul><p>当 Java 程序调用 <code>Selector.open()</code> 时，JVM 会根据操作系统自动选择合适的实现。</p><ul><li>性能对比</li></ul><div class=table-wrapper><table><thead><tr><th>操作系统</th><th>底层实现</th><th>主要特点</th></tr></thead><tbody><tr><td><strong>Linux</strong></td><td><code>epoll</code></td><td>高效事件驱动，适用于大规模连接</td></tr><tr><td><strong>macOS / BSD</strong></td><td><code>kqueue</code></td><td>低开销，支持多种事件类型</td></tr><tr><td><strong>Windows</strong></td><td><code>IOCP</code></td><td>异步 I/O，适用于高吞吐量服务器</td></tr><tr><td><strong>其他系统</strong></td><td><code>select</code> / <code>poll</code></td><td>适用于较旧系统，但性能较低</td></tr></tbody></table></div><blockquote><p>10万级别的请求IO多路可以勉强处理</p></blockquote><h3 id=依然有缺点>依然有缺点</h3><p>当连接数量建立的比较多，且每个连接收发都相当频繁时，一次selectkey操作可能就会出现上万个事件需要处理。大部分请求处理慢，造成用户体验极差，且可能导致服务器暂时无法处理，</p><h2 id=反应器模式reactor>反应器模式（Reactor）</h2><blockquote><p>用于处理并发请求的事件设计模式。通过一个中央事件处理器（Reactor）来监听资源上的事件，在事件发生时将这些事件分派到注册的事件处理器，从而实现高效的并发处理。能够在单线程中管理大量连接，提高系统的吞吐量和响应性。</p></blockquote><ol><li>资源（Resources）<ul><li>资源是生成事件的实体，如网络连接（Socket Handle）或文件描述符。</li><li>例如，在网络服务器中，资源可能是客户端的 TCP 连接。</li></ul></li><li>同步事件解多路器（Synchronous Event Demultiplexer）<ul><li>使用事件循环（event loop）来阻塞等待所有资源的事件。</li><li>当资源准备好进行同步操作且不会阻塞时，解多路器将资源发送到分发器。</li><li>CSDN 文章（web:3）提到，这部分通常通过 select、poll 或 epoll 等系统调用实现。</li></ul></li><li>分发器（Dispatcher）<ul><li>负责处理请求处理器的注册和注销。</li><li>将资源分发到相关的请求处理器，确保事件被正确处理。</li><li>例如，分发器可能根据事件类型（如读、写、关闭）调用不同的处理器。</li></ul></li><li>请求处理器（Request Handlers）<ul><li>应用程序定义的请求处理程序，负责处理与资源相关联的请求。</li><li>处理器通常是同步调用的，处理业务逻辑，如读取数据或发送响应。</li></ul></li></ol><h3 id=工作原理>工作原理</h3><p>反应器模式的工作流程如下：</p><ul><li>事件循环持续监听资源上的事件（如连接建立、数据到达）。</li><li>当事件发生时，同步事件解多路器通知分发器。</li><li>分发器根据事件类型调用注册的请求处理器。</li><li>请求处理器同步地处理事件，例如读取数据或执行业务逻辑。</li><li>整个过程通常在单线程中完成，但可以结合线程池处理复杂任务。</li></ul><h3 id=优势>优势</h3><p><strong>模块化和可重用性</strong>：将程序特定代码分离为模块化、可重用的组件，便于维护和扩展。</p><p><strong>简化并发</strong>：通过同步调用处理器，避免了多线程系统的复杂性，减少了线程创建、销毁和切换的开销。</p><p><strong>高效处理高并发</strong>：单个线程可以处理大量连接，适合高吞吐量场景，如 Web 服务器。</p><p>例如，博客园文章（web:9）提到，反应器模式代替多线程处理方式，节省系统资源，提高吞吐量。</p><h3 id=缺点>缺点</h3><p><strong>调试困难</strong>：由于控制流的反转（好莱坞原则：不要打电话给我们，我们会打电话给你），调试可能更复杂。</p><p><strong>并发限制</strong>：同步调用处理器可能限制最大并发性，尤其在对称多处理（SMP）硬件上。</p><p><strong>可扩展性</strong>：受同步调用和解多路器的限制，扩展到大规模并发可能需要额外的优化。</p><h2 id=netty-io模型单机处理百万级并发>Netty IO模型（单机处理百万级并发）</h2><blockquote><p>主从Reactor模式，在反应器单线程的基础上提供并发能力。</p></blockquote><h3 id=主要组件>主要组件</h3><ol><li><strong>BossGroup</strong></li></ol><ul><li>负责接收客户端的连接请求，相当于主Reactor。</li><li>有新连接时，创建NioSocketChannel并将其注册到WorkerGroup的某个NioEventLoop上。</li><li>常规默认为单线程（可配置）</li></ul><ol start=2><li><p><strong>WorkerGroup</strong></p><ul><li>负责处理已建立连接的IO事件，如读写操作，相当于从Reactor。</li><li>可以有多个线程，默认为CPU核心数的两倍。</li><li>每个WorkerGroup中的NioEventLoop轮询其selector，处理注册的Channel事件</li></ul></li><li><p><strong>NioEventLoop</strong></p><ul><li>每个NioEventLoop包含一个Selector，用于监听绑定在其上的SocketChannel的网络通讯。<ul><li>轮询read/write事件</li><li>处理IO事件和业务逻辑</li><li>执行任务队列（runAllTasks），处理耗时的任务。</li></ul></li></ul></li><li><p><strong>ChannelPipeline</strong></p><ul><li>抽象数据管道，包含双向链表的ChannelHandler，用于拦截和处理IO事件。</li><li>支持添加、删除handler，处理入站和出站事件。</li></ul><blockquote><p>入站事件从头到尾走handler，出站事件从尾到头走handler</p></blockquote></li></ol><h3 id=工作原理-1>工作原理</h3><ol><li>BossGroup监听accept事件，当有新连接时，生成NioSocketChannel，并将其注册到WorkerGroup的某个NioEventLoop的Selector上。</li><li>WorkerGroup的NioEventLoop轮询Selector，处理注册的Channel上的读写事件。</li><li>当有IO事件发生时，通过ChannelPipline中的handler链处理数据，确保数据流的连续性和高效性。</li></ol><h3 id=优点>优点</h3><ul><li><strong>非阻塞IO</strong>：IO操作不会阻塞线程，线程可以在等待IO完成时处理其他任务。（读写操作异步通知业务线程，无需阻塞）</li><li><strong>高并发</strong>：通过少量线程管理大量并发，减少线程创建和上下文切换的开销。（支持百万级并发）</li><li><strong>可扩展(伸缩性)</strong>：主从Reactor模式允许配置“多主多从”，通过启动参数调整线程池大小。</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/netty/>Netty</a>
<a href=/tags/java/>Java</a>
<a href=/tags/io%E6%A8%A1%E5%9E%8B/>Io模型</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/%E8%AF%BBnetty-in-action%E6%9C%89%E6%84%9F/><div class=article-image><img src=/p/%E8%AF%BBnetty-in-action%E6%9C%89%E6%84%9F/nettyinac.4b936fec8eb554f2dfbdc656bbb2818e_hu_bf0c94b3d41e84a8.png width=250 height=150 loading=lazy alt="Featured image of post 读《netty in action》有感" data-hash="md5-S5Nv7I61VPLfvcZWu7KBjg=="></div><div class=article-details><h2 class=article-title>读《netty in action》有感</h2></div></a></article><article class=has-image><a href=/p/jdk25-2/><div class=article-image><img src=/p/jdk25-2/1.1ba2120bdc98acfe6bad936098ca47e2_hu_3cfcf258c0c980ae.png width=250 height=150 loading=lazy alt="Featured image of post 备战JDK25--并发" data-key=JDK25-2 data-hash="md5-G6ISC9yYrP5rrZNgmMpH4g=="></div><div class=article-details><h2 class=article-title>备战JDK25--并发</h2></div></a></article><article class=has-image><a href=/p/jdk25-1/><div class=article-image><img src=/p/jdk25-1/1.a1fcd903c65bcaf940dee4edad9ec466_hu_d49195ca74ba2daf.png width=250 height=150 loading=lazy alt="Featured image of post 备战JDK25--垃圾回收器" data-key=JDK25-1 data-hash="md5-ofzZA8ZbyvlA3uTtrZ7EZg=="></div><div class=article-details><h2 class=article-title>备战JDK25--垃圾回收器</h2></div></a></article><article class=has-image><a href=/p/java21%E6%A0%B8%E5%BF%83%E5%BA%93--%E5%B9%B6%E5%8F%91/><div class=article-image><img src=/p/java21%E6%A0%B8%E5%BF%83%E5%BA%93--%E5%B9%B6%E5%8F%91/java21c.1b7f460a3c98bdb0e29c2b301cbb9563_hu_37de794d9adf1c0f.png width=250 height=150 loading=lazy alt="Featured image of post JAVA21核心库--并发" data-hash="md5-G39GCjyYvbDinCswHLuVYw=="></div><div class=article-details><h2 class=article-title>JAVA21核心库--并发</h2></div></a></article><article class=has-image><a href=/p/%E8%AF%BB%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA2019%E7%89%88%E6%9C%89%E6%84%9F/><div class=article-image><img src=/p/%E8%AF%BB%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA2019%E7%89%88%E6%9C%89%E6%84%9F/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BAv3.7a938c68cb8d638aedb4ae81627b8f0b_hu_9bb77bf9d1481dbf.png width=250 height=150 loading=lazy alt="Featured image of post 读《深入理解java虚拟机2019版》有感" data-hash="md5-epOMaMuNY4rttK6BYnuPCw=="></div><div class=article-details><h2 class=article-title>读《深入理解java虚拟机2019版》有感</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//thecoolboyhan.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 韩永发的博客</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.31.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>