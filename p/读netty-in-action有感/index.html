<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="éå¸¸niceçš„nettyä¹¦ç±"><title>è¯»ã€Šnetty in actionã€‹æœ‰æ„Ÿ</title><link rel=canonical href=https://thecoolboyhan.github.io/p/%E8%AF%BBnetty-in-action%E6%9C%89%E6%84%9F/><link rel=stylesheet href=/scss/style.min.833d6eed45de56f48306bf57268d5b8cdfc8a60e8e7bdc99810464fcd033f7c6.css><meta property='og:title' content="è¯»ã€Šnetty in actionã€‹æœ‰æ„Ÿ"><meta property='og:description' content="éå¸¸niceçš„nettyä¹¦ç±"><meta property='og:url' content='https://thecoolboyhan.github.io/p/%E8%AF%BBnetty-in-action%E6%9C%89%E6%84%9F/'><meta property='og:site_name' content='éŸ©æ°¸å‘çš„åšå®¢'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='netty'><meta property='article:tag' content='java'><meta property='article:tag' content='è¯»åæ„Ÿ'><meta property='article:tag' content='rpc'><meta property='article:published_time' content='2024-10-15T00:00:00+00:00'><meta property='article:modified_time' content='2024-10-15T00:00:00+00:00'><meta property='og:image' content='https://thecoolboyhan.github.io/p/%E8%AF%BBnetty-in-action%E6%9C%89%E6%84%9F/nettyinac.png'><meta name=twitter:title content="è¯»ã€Šnetty in actionã€‹æœ‰æ„Ÿ"><meta name=twitter:description content="éå¸¸niceçš„nettyä¹¦ç±"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://thecoolboyhan.github.io/p/%E8%AF%BBnetty-in-action%E6%9C%89%E6%84%9F/nettyinac.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_63165f4306fe5eb3.png width=300 height=400 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¥</span></figure><div class=site-meta><h1 class=site-name><a href=/>éŸ©æ°¸å‘çš„åšå®¢</a></h1><h2 class=site-description>ç›®å‰äººåœ¨ä¸Šæµ·ï¼Œ20å¹´æ¯•ä¸šï¼Œæ™®é€šmuggleï¼Œjavaå¼€å‘ã€‚é‚®ç®±ï¼šhanyongfa2013@163.com ã€‚</h2></div></header><ol class=menu-social><li><a href=https://github.com/thecoolboyhan target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://leetcode.cn/u/thecoolboy/ target=_blank title=åŠ›æ‰£ rel=me><svg role="img" viewBox="0 0 24 24"><title>LeetCode</title><path d="M13.483.0a1.374 1.374.0 00-.961.438L7.116 6.226l-3.854 4.126a5.266 5.266.0 00-1.209 2.104 5.35 5.35.0 00-.125.513 5.527 5.527.0 00.062 2.362 5.83 5.83.0 00.349 1.017 5.938 5.938.0 001.271 1.818l4.277 4.193.039.038c2.248 2.165 5.852 2.133 8.063-.074l2.396-2.392c.54-.54.54-1.414.003-1.955a1.378 1.378.0 00-1.951-.003l-2.396 2.392a3.021 3.021.0 01-4.205.038l-.02-.019-4.276-4.193c-.652-.64-.972-1.469-.948-2.263a2.68 2.68.0 01.066-.523 2.545 2.545.0 01.619-1.164L9.13 8.114c1.058-1.134 3.204-1.27 4.43-.278l3.501 2.831c.593.48 1.461.387 1.94-.207a1.384 1.384.0 00-.207-1.943l-3.5-2.831c-.8-.647-1.766-1.045-2.774-1.202l2.015-2.158A1.384 1.384.0 0013.483.0zm-2.866 12.815a1.38 1.38.0 00-1.38 1.382 1.38 1.38.0 001.38 1.382H20.79a1.38 1.38.0 001.38-1.382 1.38 1.38.0 00-1.38-1.382z"/></svg></a></li><li><a href=mailto:hanyongfa2013@163.com target=_blank title=é‚®ç®± rel=me><svg id="mdi-email-arrow-right-outline" viewBox="0 0 24 24"><path d="M13 19C13 18.66 13.04 18.33 13.09 18H4V8l8 5 8-5v5.09C20.72 13.21 21.39 13.46 22 13.81V6C22 4.9 21.1 4 20 4H4C2.9 4 2 4.9 2 6V18c0 1.1.9 2 2 2h9.09C13.04 19.67 13 19.34 13 19M20 6l-8 5L4 6H20m0 16V20H16V18h4V16l3 3-3 3z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#ç¬¬ä¸€éƒ¨åˆ†nettyçš„æ¦‚å¿µåŠä½“ç³»ç»“æ„>ç¬¬ä¸€éƒ¨åˆ†ã€Nettyçš„æ¦‚å¿µåŠä½“ç³»ç»“æ„</a><ol><li><a href=#ç¬¬ä¸€ç« nettyå¼‚æ­¥å’Œäº‹ä»¶é©±åŠ¨>ç¬¬ä¸€ç« ã€Netty&ndash;å¼‚æ­¥å’Œäº‹ä»¶é©±åŠ¨</a><ol><li><a href=#javaæ—©æœŸbioå¤„ç†è¯·æ±‚æ–¹å¼>javaæ—©æœŸBIOå¤„ç†è¯·æ±‚æ–¹å¼</a></li><li><a href=#java-nio>java NIO</a></li><li><a href=#nettyç®€ä»‹>Nettyç®€ä»‹</a></li></ol></li><li><a href=#ç¬¬äºŒç« ä½ çš„ç¬¬ä¸€ä¸ªnettyåº”ç”¨ç¨‹åº>ç¬¬äºŒç« ã€ä½ çš„ç¬¬ä¸€ä¸ªNettyåº”ç”¨ç¨‹åº</a><ol><li><a href=#ä¸åŒçš„äº‹ä»¶å¤„ç†è¯»å–æ•°æ®çš„ç¤ºä¾‹>ä¸åŒçš„äº‹ä»¶å¤„ç†ï¼Œè¯»å–æ•°æ®çš„ç¤ºä¾‹</a></li><li><a href=#æœåŠ¡ç«¯ä»£ç >æœåŠ¡ç«¯ä»£ç </a></li><li><a href=#å®¢æˆ·ç«¯ä»£ç >å®¢æˆ·ç«¯ä»£ç </a></li></ol></li><li><a href=#ç¬¬ä¸‰ç« nettyçš„ç»„ä»¶å’Œè®¾è®¡>ç¬¬ä¸‰ç« ã€Nettyçš„ç»„ä»¶å’Œè®¾è®¡</a><ol><li><a href=#channeleventloopå’Œchannelfuture>Channelã€EventLoopå’ŒChannelFuture</a></li><li><a href=#channelhandlerå’Œchannelpipeline>ChannelHandlerå’ŒChannelPipeline</a></li><li><a href=#å¼•å¯¼>å¼•å¯¼</a></li></ol></li><li><a href=#ç¬¬å››ç« ä¼ è¾“>ç¬¬å››ç« ã€ä¼ è¾“</a><ol><li><a href=#æ¡ˆä¾‹ç ”ç©¶ä¼ è¾“è¿ç§»>æ¡ˆä¾‹ç ”ç©¶ï¼šä¼ è¾“è¿ç§»</a></li><li><a href=#ä¼ è¾“api>ä¼ è¾“API</a></li><li><a href=#å†…ç½®çš„ä¼ è¾“>å†…ç½®çš„ä¼ è¾“</a></li><li><a href=#ä¼ è¾“çš„ç”¨ä¾‹>ä¼ è¾“çš„ç”¨ä¾‹</a></li></ol></li><li><a href=#ç¬¬äº”ç« bytebuf>ç¬¬äº”ç« ã€Bytebuf</a><ol><li><a href=#bytebufçš„api>ByteBufçš„API</a></li><li><a href=#bytebufç±»nettyçš„æ•°æ®å®¹å™¨>ByteBufç±»&ndash;Nettyçš„æ•°æ®å®¹å™¨</a></li><li><a href=#å­—èŠ‚çº§æ“ä½œ-bytebufç›¸å…³çš„æ“ä½œ>å­—èŠ‚çº§æ“ä½œ ByteBufç›¸å…³çš„æ“ä½œ</a></li><li><a href=#bytebufholderæ¥å£>ByteBufHolderæ¥å£</a></li><li><a href=#bytebufåˆ†é…å’Œç®¡ç†>ByteBufåˆ†é…å’Œç®¡ç†</a></li><li><a href=#å¼•ç”¨è®¡æ•°>å¼•ç”¨è®¡æ•°</a></li></ol></li><li><a href=#ç¬¬å…­ç« channelhandlerå’Œchannelpipeline>ç¬¬å…­ç« ã€ChannelHandlerå’ŒChannelPipeline</a><ol><li><a href=#channelhandlerå®¶æ—>Channelhandlerå®¶æ—</a></li><li><a href=#channelpipelineæ¥å£>ChannelPipelineæ¥å£</a></li><li><a href=#channelhandlercontextæ¥å£>ChannelHandlerContextæ¥å£</a></li><li><a href=#å¼‚å¸¸å¤„ç†>å¼‚å¸¸å¤„ç†</a></li></ol></li><li><a href=#ç¬¬ä¸ƒç« eventloopå’Œçº¿ç¨‹æ¨¡å‹>ç¬¬ä¸ƒç« ã€EventLoopå’Œçº¿ç¨‹æ¨¡å‹</a><ol><li><a href=#eventloopæ¥å£>EventLoopæ¥å£</a></li><li><a href=#ä»»åŠ¡è°ƒåº¦>ä»»åŠ¡è°ƒåº¦</a></li><li><a href=#å®ç°ç»†èŠ‚>å®ç°ç»†èŠ‚</a></li><li><a href=#æ€»ç»“-2>æ€»ç»“</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/%E8%AF%BBnetty-in-action%E6%9C%89%E6%84%9F/><img src=/p/%E8%AF%BBnetty-in-action%E6%9C%89%E6%84%9F/nettyinac_hu_d6cc53085e36d50e.png srcset="/p/%E8%AF%BBnetty-in-action%E6%9C%89%E6%84%9F/nettyinac_hu_d6cc53085e36d50e.png 800w, /p/%E8%AF%BBnetty-in-action%E6%9C%89%E6%84%9F/nettyinac_hu_c96dfdac77347ebf.png 1600w" width=800 height=533 loading=lazy alt="Featured image of post è¯»ã€Šnetty in actionã€‹æœ‰æ„Ÿ"></a></div><div class=article-details><header class=article-category><a href=/categories/%E7%B2%BE%E9%80%89/>ç²¾é€‰
</a><a href=/categories/netty/>Netty</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E8%AF%BBnetty-in-action%E6%9C%89%E6%84%9F/>è¯»ã€Šnetty in actionã€‹æœ‰æ„Ÿ</a></h2><h3 class=article-subtitle>éå¸¸niceçš„nettyä¹¦ç±</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2024-10-15T00:00:00Z>Oct 15, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 28 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h2 id=ç¬¬ä¸€éƒ¨åˆ†nettyçš„æ¦‚å¿µåŠä½“ç³»ç»“æ„>ç¬¬ä¸€éƒ¨åˆ†ã€Nettyçš„æ¦‚å¿µåŠä½“ç³»ç»“æ„</h2><h3 id=ç¬¬ä¸€ç« nettyå¼‚æ­¥å’Œäº‹ä»¶é©±åŠ¨>ç¬¬ä¸€ç« ã€Netty&ndash;å¼‚æ­¥å’Œäº‹ä»¶é©±åŠ¨</h3><h4 id=javaæ—©æœŸbioå¤„ç†è¯·æ±‚æ–¹å¼>javaæ—©æœŸBIOå¤„ç†è¯·æ±‚æ–¹å¼</h4><p>æ—©æœŸjavaé˜»å¡å‡½æ•°å¤„ç†è¯·æ±‚çš„æ–¹å¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        åˆ›å»ºä¸€ä¸ªæ–°çš„ServerSocket,ç”¨æ¥ç›‘å¬æŒ‡å®šç«¯å£ä¸Šçš„è¿æ¥è¯·æ±‚ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerSocket</span><span class=w> </span><span class=n>serverSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServerSocket</span><span class=p>(</span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        å¯¹accept()çš„è°ƒç”¨å°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°ä¸€ä¸ªè¿æ¥å»ºç«‹ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Socket</span><span class=w> </span><span class=n>clientSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>serverSocket</span><span class=p>.</span><span class=na>accept</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BufferedReader</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BufferedReader</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InputStreamReader</span><span class=p>(</span><span class=n>clientSocket</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PrintWriter</span><span class=w> </span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PrintWriter</span><span class=p>(</span><span class=n>clientSocket</span><span class=p>.</span><span class=na>getOutputStream</span><span class=p>(),</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>((</span><span class=n>request</span><span class=o>=</span><span class=n>in</span><span class=p>.</span><span class=na>readLine</span><span class=p>())</span><span class=o>!=</span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            å¦‚æœå®¢æˆ·ç«¯ä¼ é€’äº†doneè¡¨ç¤ºå¤„ç†ç»“æŸï¼Œé€€å‡ºå¾ªç¯ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=s>&#34;Done&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>request</span><span class=p>))</span><span class=w> </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            å¤„ç†è¢«ä¼ é€’ç»™æœåŠ¡å™¨çš„å¤„ç†æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            response=processRequest(request);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            æœåŠ¡å™¨ç»™å®¢æˆ·ç«¯å“åº”å¤„ç†ç»“æœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-05/2024-7-1015_46_08-1720597567759_1747187950026.png loading=lazy alt=2024-7-1015_46_08-1720597567759.png></p><p>ä¸Šæ–¹ä»£ç åªèƒ½åŒæ—¶å¤„ç†ä¸€ä¸ªè¿æ¥ï¼Œè¦ç®¡ç†å¤šä¸ªå¹¶å‘å®¢æˆ·ç«¯ï¼Œéœ€è¦ä¸ºæ¯ä¸ªæ–°çš„å®¢æˆ·ç«¯Socketåˆ›å»ºä¸€ä¸ªæ–°çš„Threadã€‚</p><ul><li>ç¼ºç‚¹ï¼š</li></ul><ol><li><p>å¤§éƒ¨åˆ†çº¿ç¨‹å‡ ä¹éƒ½å¤„äºä¼‘çœ çŠ¶æ€ã€‚</p></li><li><p>åˆ›å»ºçš„æ¯ä¸ªçº¿ç¨‹éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªæ ˆï¼Œæ¯ä¸ªæ ˆè‡³å°‘éƒ½è¦ç››æƒ…é»˜è®¤ç©ºé—´çš„å†…å­˜ã€‚</p></li><li><p>å¦‚æœçº¿ç¨‹å¤šï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬é«˜ã€‚</p></li></ol><h4 id=java-nio>java NIO</h4><blockquote><p>new or Non-blocking</p><p>NIOæœ€å¼€å§‹æ˜¯æ–°çš„è¾“å…¥/è¾“å‡ºï¼ˆnew Input/output)çš„è‹±æ–‡ç¼©å†™ï¼Œä½†è¯¥APIå·²ç»å‡ºç°è¶³å¤Ÿé•¿çš„æ—¶é—´ï¼Œä¸å†æ˜¯â€œæ–°çš„â€äº†ï¼Œå› æ­¤ï¼Œå¦‚ä»Šå¤§å¤šæ•°çš„ç”¨æˆ·è®¤ä¸ºNIOä»£è¡¨éé˜»å¡I/Oï¼Œè€Œé˜»å¡IOæ˜¯æ—§çš„è¾“å…¥/è¾“å‡ºã€‚</p></blockquote><ul><li>NIOçš„ä¸¤ä¸ªä¼˜åŒ–</li></ul><ol><li>ä½¿ç”¨setsockopt()æ–¹æ³•é…ç½®å¥—æ¥å­—ï¼Œå¦‚æœæ²¡æœ‰è¯»å†™è°ƒç”¨çš„æ—¶å€™å°±ä¼šç«‹åˆ»è¿”å›ã€‚</li><li>å¯ä»¥ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„æ—¶é—´é€šçŸ¥APIæ³¨å†Œä¸€ç»„éé˜»å¡å¥—æ¥å­—ï¼Œä»¥ç¡®å®šå®ƒä»¬ä¸­æ˜¯å¦æœ‰ä»»ä½•çš„å¥—æ¥å­—å·²ç»æœ‰æ•°æ®å¯ä¾›è¯»å†™ã€‚ï¼ˆIOå¤šè·¯å¤ç”¨ï¼‰ã€‚</li></ol><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-05/2024-7-1016_00_49-1720598448120_1747187990455.png loading=lazy alt=2024-7-1016_00_49-1720598448120.png></p><p>java.nio.channels.Selectoræ˜¯javaçš„éé˜»å¡IOå®ç°çš„å…³é”®ã€‚å®ƒä½¿ç”¨äº†äº‹ä»¶é€šçŸ¥APIï¼ˆIOå¤šè·¯å¤ç”¨ï¼‰ä»¥ç¡®è®¤ä¸€ç»„éé˜»å¡å¥—æ¥å­—ä¸­æœ‰å“ªäº›å·²ç»å°±ç»ªèƒ½å¤Ÿè¿›è¡ŒIOç›¸å…³çš„æ“ä½œã€‚å› æ­¤å¯ä»¥åœ¨ä»»ä½•çš„æ—¶é—´æ£€æŸ¥ä»»æ„çš„è¯»å†™æ“ä½œçš„å®ŒæˆçŠ¶æ€ã€‚æ‰€ä»¥å¯ä»¥å®ç°ä¸€ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªå¹¶å‘çš„è¿æ¥ã€‚</p><ul><li>ä¼˜ç‚¹ï¼š</li></ul><ol><li>ä½¿ç”¨è¾ƒå°‘çš„çº¿ç¨‹å¯ä»¥å¤„ç†è®¸å¤šçš„è¿æ¥ï¼Œå‡å°‘äº†å†…å­˜ç®¡ç†å’Œä¸Šä¸‹æ–‡åˆ‡æ¢å¸¦æ¥çš„å¼€é”€ã€‚</li><li>å½“æ²¡æœ‰IOæ“ä½œéœ€è¦å¤„ç†çš„æ—¶å€™ï¼Œçº¿ç¨‹ä¹Ÿå¯ä»¥è¢«ç”¨äºå…¶ä»–ä»»åŠ¡ã€‚</li></ol><h4 id=nettyç®€ä»‹>Nettyç®€ä»‹</h4><p>Nettyçš„ç‰¹æ€§æ€»ç»“</p><div class=table-wrapper><table><thead><tr><th>åˆ†ç±»</th><th>Nettyçš„ç‰¹æ€§</th></tr></thead><tbody><tr><td>è®¾è®¡</td><td>ç»Ÿä¸€çš„APIï¼Œæ”¯æŒå¤šç§ä¼ è¾“ç±»å‹ï¼Œé˜»å¡å’Œéé˜»å¡çš„ \n ç®€å•è€Œå¼ºå¤§çš„çº¿ç¨‹æ¨¡å‹ \n çœŸæ­£çš„æ— è¿æ¥æ•°æ®æŠ¥å¥—æ¥å­—æ”¯æŒ \n é“¾æ¥é€»è¾‘ç»„ä»¶ä»¥æ”¯æŒå¤ç”¨</td></tr><tr><td>æ˜“äºä½¿ç”¨</td><td>è¯¦ç»†çš„javadocå’Œå¤§é‡çš„ç¤ºä¾‹é›† \n</td></tr><tr><td>æ€§èƒ½</td><td>æ‹¥æœ‰æ¯”javaçš„æ ¸å¿ƒAPIæ›´é«˜çš„ååé‡ä»¥åŠæ›´ä½çš„å»¶è¿Ÿ\n å¾—ç›Šäºæ± åŒ–å’Œå¤ç”¨ï¼Œæ‹¥æœ‰æ›´ä½çš„èµ„æºæ¶ˆè€—\n æ›´å°çš„å†…å­˜å¤åˆ¶</td></tr><tr><td>å¥å£®æ€§</td><td>ä¸ä¼šå› ä¸ºæ…¢é€Ÿã€å¿«é€Ÿæˆ–è€…è¶…è½½çš„è¿æ¥è€Œå¯¼è‡´OutOfMemoryError \n æ¶ˆé™¤åœ¨é«˜é€Ÿç½‘ç»œä¸­NIOåº”ç”¨ç¨‹åºå¸¸è§çš„ä¸å…¬å¹³è¯»å†™æ¯”ç‡</td></tr><tr><td>å®‰å…¨æ€§</td><td>å®Œæ•´çš„SSL/TLS ä»¥åŠStartTLSæ”¯æŒ \n å¯ç”¨äºå—é™åˆ¶ç¯å¢ƒä¸‹</td></tr><tr><td>ç¤¾åŒºé©±åŠ¨</td><td>å‘å¸ƒå¿«é€Ÿè€Œä¸”é¢‘ç¹</td></tr></tbody></table></div><ul><li>å¼‚æ­¥å’Œå¯ä¼¸ç¼©æ€§</li></ul><p>å¼‚æ­¥ï¼šæˆ‘ä»¬ä¸å¿…ç­‰å¾…ä¸€ä¸ªæ“ä½œçš„å®Œæˆã€‚å¼‚æ­¥æ–¹æ³•ä¼šç«‹åˆ»è¿”å›ï¼Œå¹¶ä¸”åœ¨å®ƒå®Œæˆæ—¶ï¼Œä¼šç›´æ¥æˆ–ç¨åçš„æŸä¸ªæ—¶é—´ç‚¹é€šçŸ¥ç”¨æˆ·ã€‚</p><p>å¯ä¼¸ç¼©æ€§ï¼šä¸€ç§ç³»ç»Ÿã€ç½‘ç»œæˆ–è€…è¿›ç¨‹åœ¨éœ€è¦å¤„ç†çš„å·¥ä½œä¸æ–­å¢é•¿æ—¶ï¼Œå¯ä»¥é€šè¿‡æŸç§å¯è¡Œçš„æ–¹å¼æˆ–æ‰©å¤§å®ƒçš„å¤„ç†èƒ½åŠ›æ¥é€‚åº”è¿™ç§å¢é•¿çš„èƒ½åŠ›ã€‚</p><h5 id=channel>Channel</h5><p>å®ƒè¡¨ç¤ºä¸€ä¸ªå®ä½“ï¼ˆä¸€ä¸ªç¡¬ä»¶è®¾å¤‡ã€ä¸€ä¸ªæ–‡ä»¶ã€ä¸€ä¸ªç½‘ç»œå¥—æ¥å­—æˆ–è€…ä¸€ä¸ªèƒ½å¤Ÿæ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªä¸åŒIOçš„æ“ä½œç¨‹åºç»„ä»¶ï¼‰çš„å¼€æ”¾è¿æ¥ï¼Œå¦‚è¯»æ“ä½œå’Œå†™æ“ä½œã€‚</p><h5 id=å›è°ƒ>å›è°ƒ</h5><p>ä¸€ä¸ªå›è°ƒå…¶å®å°±æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæŒ‡å‘å·²ç»è¢«æä¾›ç»™å¦ä¸€ä¸ªæ–¹æ³•çš„æ–¹æ³•å¼•ç”¨ã€‚è¿™ä½¿å¾—è¢«è°ƒç”¨è€…åœ¨é€‚å½“çš„æ—¶å€™å¯ä»¥å›è°ƒè°ƒç”¨è€…ã€‚æ˜¯åœ¨æ“ä½œå®Œæˆåé€šçŸ¥ç›¸å…³æ–¹å¸¸ç”¨çš„æ–¹å¼ã€‚</p><ul><li>å›è°ƒç¤ºä¾‹ï¼š</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * å½“ä¸€ä¸ªè¿æ¥å»ºç«‹ï¼ŒChannelHandlerå›è°ƒchannelActiveæ–¹æ³•ï¼Œæ‰“å°å‡ºè¿æ¥çš„åœ°å€ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ConnectHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ChannelInboundHandlerAdapter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelActive</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;client &#34;</span><span class=o>+</span><span class=n>ctx</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>remoteAddress</span><span class=p>()</span><span class=o>+</span><span class=s>&#34;connected&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=future>Future</h5><p>Futureæ˜¯å¦ä¸€ç§åœ¨æ“ä½œå®Œæˆæ—¶é€šçŸ¥åº”ç”¨ç¨‹åºçš„æ–¹å¼ã€‚è¿™ä¸ªå¯¹è±¡å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœå ä½ç¬¦ï¼Œå®ƒå°†åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»å®Œæˆï¼Œå¹¶æä¾›å¯¹å…¶ç»“æœçš„è®¿é—®ã€‚</p><ul><li>JDKé¢„è®¾çš„Future</li></ul><p>åªå…è®¸æ‰‹åŠ¨æ£€æŸ¥å¯¹åº”çš„æ“ä½œæ˜¯å¦å·²ç»å®Œæˆï¼Œæˆ–è€…ä¸€ç›´é˜»å¡çŸ¥é“å®ƒå®Œæˆã€‚</p><ul><li>Nettyçš„ChannelFuture</li></ul><p>å¯ä»¥æ³¨å†Œä¸€ä¸ªæˆ–è€…å¤šä¸ªChannelFutureListener</p><ol><li>ç›‘å¬çš„å›è°ƒæ–¹æ³•operationComplete()ï¼Œä¼šåœ¨å¯¹åº”çš„æ“ä½œå®Œæˆæ—¶è¢«è°ƒç”¨ã€‚</li><li>é€šè¿‡ChannelFutureå¯ä»¥åˆ¤æ–­è¯¥æ“ä½œæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€‚</li><li>é€šè¿‡ChannelFutureListeneræä¾›çš„é€šçŸ¥æœºåˆ¶ï¼Œæ¶ˆé™¤äº†æ‰‹åŠ¨æ£€æŸ¥å¯¹åº”çš„æ“ä½œæ˜¯å¦å®Œæˆçš„å¿…è¦ã€‚</li></ol><p>æ¯ä¸ªIOæ“ä½œéƒ½ä¸ä¼šé˜»å¡ï¼Œæ‰€ä»¥Nettyæ˜¯å®Œå…¨å¼‚æ­¥å’Œäº‹ä»¶é©±åŠ¨çš„ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * æ¼”ç¤ºåˆ©ç”¨ChannelFutureå¤„ç†è¿æ¥è¯·æ±‚ï¼Œå’Œè¿æ¥è¯·æ±‚çš„ç»“æœã€‚å…¨ç¨‹ä¸å½±å“å…¶ä»–ä»£ç ã€‚
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ChannelFuture1</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>(</span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        è¿æ¥ä¼šå¼‚æ­¥çš„å»ºç«‹ï¼Œä¸å½±å“å…¶ä»–é€»è¾‘ä»£ç ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>future</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channel</span><span class=p>.</span><span class=na>connect</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InetSocketAddress</span><span class=p>(</span><span class=s>&#34;192.168.31.141&#34;</span><span class=p>,</span><span class=w> </span><span class=n>25</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//ç»™æ­¤ç»“æœæ·»åŠ ä¸€ä¸ªChannelFutureListenerå¤„ç†æ–¹æ³•ï¼Œå¹¶æ ¹æ®è¿”å›ç»“æœæ¥åšå‡ºå›åº”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>future</span><span class=p>.</span><span class=na>addListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelFutureListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>operationComplete</span><span class=p>(</span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>future</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>future</span><span class=p>.</span><span class=na>isSuccess</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ByteBuf</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Unpooled</span><span class=p>.</span><span class=na>copiedBuffer</span><span class=p>(</span><span class=s>&#34;Hello&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Charset</span><span class=p>.</span><span class=na>defaultCharset</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>wf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>future</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=k>else</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Throwable</span><span class=w> </span><span class=n>cause</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>future</span><span class=p>.</span><span class=na>cause</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>cause</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=äº‹ä»¶å’Œchannelhandler>äº‹ä»¶å’ŒChannelHandler</h5><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-05/2024-7-1115_46_48-1720684007367_1747188019882.png loading=lazy alt=2024-7-1115_46_48-1720684007367.png></p><h5 id=æ€»ç»“>æ€»ç»“</h5><p>Nettyçš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹å»ºç«‹åœ¨Futureå’Œå›è°ƒçš„æ¦‚å¿µä¹‹ä¸Šçš„ï¼Œè€Œå°†äº‹ä»¶æ´¾å‘åˆ°ChannelHandlerçš„æ–¹æ³•åˆ™å‘ç”Ÿåœ¨æ›´æ·±çš„å±‚æ¬¡ä¸Šã€‚</p><p>æ‹¦æˆªæ“ä½œä»¥åŠé«˜é€Ÿåœ°è½¬æ¢å…¥ç«™æ•°æ®å’Œå‡ºç«™æ•°æ®ï¼Œéƒ½åªéœ€è¦ä½ æä¾›å›è°ƒæˆ–è€…åˆ©ç”¨æ“ä½œæ‰€è¿”å›çš„Futureã€‚è¿™ä½¿å¾—é“¾æ¥æ“ä½œå˜å¾—æ—¢ç®€å•åˆé«˜æ•ˆï¼Œå¹¶ä¸”ä¿ƒè¿›äº†å¯é‡ç”¨çš„é€šç”¨ä»£ç çš„ç¼–å†™ã€‚</p><p>Nettyé€šè¿‡è§¦å‘äº‹ä»¶å°†selectorä»åº”ç”¨ç¨‹åºä¸­æŠ½è±¡å‡ºæ¥ï¼Œæ¶ˆé™¤äº†æ‰€æœ‰æœ¬æ¥å°†éœ€è¦æ‰‹åŠ¨ç¼–å†™çš„æ´¾å‘ä»£ç ã€‚</p><h3 id=ç¬¬äºŒç« ä½ çš„ç¬¬ä¸€ä¸ªnettyåº”ç”¨ç¨‹åº>ç¬¬äºŒç« ã€ä½ çš„ç¬¬ä¸€ä¸ªNettyåº”ç”¨ç¨‹åº</h3><h4 id=ä¸åŒçš„äº‹ä»¶å¤„ç†è¯»å–æ•°æ®çš„ç¤ºä¾‹>ä¸åŒçš„äº‹ä»¶å¤„ç†ï¼Œè¯»å–æ•°æ®çš„ç¤ºä¾‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//æ­¤æ³¨è§£è¡¨ç¤ºï¼Œå½“å‰channel-handlerå¯ä»¥è¢«å¤šä¸ªChannelå®‰å…¨çš„å…±äº«</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>EchoServerHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ChannelInboundHandlerAdapter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//    æ¯ä¸ªä¼ å…¥çš„æ¶ˆæ¯éƒ½ä¼šè°ƒç”¨æ­¤æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelRead</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ByteBuf</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=o>=</span><span class=p>(</span><span class=n>ByteBuf</span><span class=p>)</span><span class=w> </span><span class=n>msg</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        ç”¨æ¥è¯»å–æ¶ˆæ¯ï¼ŒæŠŠæ¶ˆæ¯éƒ½è®°å½•åˆ°æ§åˆ¶å°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;server received:&#34;</span><span class=o>+</span><span class=n>in</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>CharsetUtil</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æŠŠæ”¶åˆ°çš„æ¶ˆæ¯å†™ç»™å‘é€è€…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctx</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>in</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//    é€šçŸ¥ChannelInboundHandleræ­¤æ¶ˆæ¯ä¸ºæœ€åä¸€æ¡æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelReadComplete</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        å°†æ¶ˆæ¯å†²åˆ·åˆ°è¿œç¨‹èŠ‚ç‚¹ï¼Œå…³é—­Channel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctx</span><span class=p>.</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=n>Unpooled</span><span class=p>.</span><span class=na>EMPTY_BUFFER</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>addListener</span><span class=p>(</span><span class=n>ChannelFutureListener</span><span class=p>.</span><span class=na>CLOSE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=c1>//    å¼‚å¸¸å¤„ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>exceptionCaught</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=n>cause</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cause</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctx</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>å¦‚æœä¸æ•è·å¼‚å¸¸ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</li></ul><p>æ¯ä¸ªChanneléƒ½æ‹¥æœ‰ä¸€ä¸ªä¸ä¹‹ç›¸å…³è”çš„ChannelPipelineï¼Œå…¶æŒæœ‰ä¸€ä¸ªChannelHandlerçš„å®ä¾‹é“¾ã€‚</p><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒChannelHandlerä¼šæŠŠå®ƒçš„æ–¹æ³•çš„è°ƒç”¨è½¬å‘ç»™é“¾ä¸­çš„ä¸‹ä¸€ä¸ªChannelHandlerã€‚å› æ­¤ï¼Œå¦‚æœexceptionCaughtï¼ˆï¼‰æ–¹æ³•æ²¡æœ‰è¢«è¯¥é“¾ä¸­çš„æŸå¤„å®ç°ï¼Œé‚£ä¹ˆæ‰€æ¥æ”¶çš„å¼‚å¸¸å°†ä¼šè¢«ä¼ é€’åˆ°ChannelPipelineçš„å°¾ç«¯å¹¶è¢«è®°å½•ã€‚ä¸ºæ­¤ï¼Œä½ çš„åº”ç”¨ç¨‹åºè‡³å°‘ä¸æœ‰ä¸€ä¸ªå®ç°äº†exceptionCaughtï¼ˆï¼‰æ–¹æ³•çš„ChannelHandlerã€‚</p><h4 id=æœåŠ¡ç«¯ä»£ç >æœåŠ¡ç«¯ä»£ç </h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//æœåŠ¡ç«¯ä¸»å¯åŠ¨ç±»ï¼Œç”¨æ¥åˆ›å»ºchannelï¼Œç»‘å®šé€šé“ï¼Œå®ä¾‹å¤„ç†ç­‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>EchoServer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//    æ–°å»ºæ—¶æŒ‡å®šå½“å‰æœåŠ¡çš„ç«¯å£ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>EchoServer</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>port</span><span class=o>=</span><span class=n>port</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        if(args.length!=1) System.out.println(&#34;Usage:&#34;+EchoServer.class.getSimpleName()+&#34;&lt;port&gt;&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        int port=Integer.parseInt(args[0]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=n>8080</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            å¯åŠ¨æœåŠ¡å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>EchoServer</span><span class=p>(</span><span class=n>port</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w>  </span><span class=n>EchoServerHandler</span><span class=w> </span><span class=n>serverHandler</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>EchoServerHandler</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        åˆ›å»ºäº‹ä»¶å¤„ç†çº¿ç¨‹æ± </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EventLoopGroup</span><span class=w> </span><span class=n>group</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>NioEventLoopGroup</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            æœåŠ¡å™¨å¯åŠ¨å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ServerBootstrap</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServerBootstrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            æŒ‡å®šæœåŠ¡å™¨ä½¿ç”¨å“ªä¸ªçº¿ç¨‹æ± </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>b</span><span class=p>.</span><span class=na>group</span><span class=p>(</span><span class=n>group</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                    æŒ‡å®šæ‰€ä½¿ç”¨çš„channel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>channel</span><span class=p>(</span><span class=n>NioServerSocketChannel</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                    è®¾ç½®ç«¯å£å·</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>localAddress</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InetSocketAddress</span><span class=p>(</span><span class=n>port</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                    æŒ‡å®šä¸€ä¸ªEchoServerHandleråˆ°å­channelçš„channelPipelineé‡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>childHandler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initChannel</span><span class=p>(</span><span class=n>SocketChannel</span><span class=w> </span><span class=n>ch</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                            ä¸Šé¢åˆ›å»ºçš„Handlerè¢«æ ‡è®°ä¸º@Shareableï¼Œå¯ä»¥é‡å¤ä½¿ç”¨ç›¸åŒçš„å®ä¾‹ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>ch</span><span class=p>.</span><span class=na>pipeline</span><span class=p>().</span><span class=na>addLast</span><span class=p>(</span><span class=n>serverHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            sync()é˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°å®Œæˆç»‘å®š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=na>bind</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            æ²¡æœ‰æ”¶åˆ°closeFutureå°±ä¸€ç›´ç­‰å¾…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>f</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>closeFuture</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            å…³é—­çº¿ç¨‹æ± ï¼Œé‡Šæ”¾èµ„æº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>group</span><span class=p>.</span><span class=na>shutdownGracefully</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol><li>EchoServerHandlerå®ç°äº†ä¸šåŠ¡é€»è¾‘</li><li>mainæ–¹æ³•å¼•å¯¼æœåŠ¡å™¨</li><li>åˆ›å»ºä¸€ä¸ªServerBootstrapçš„å®ä¾‹ä»¥å¼•å¯¼å’Œç»‘å®šæœåŠ¡å™¨</li><li>åˆ›å»ºå¹¶åˆ†é…ä¸€ä¸ªNioEventLoopGroupå®ä¾‹ä»¥è¿›è¡Œäº‹ä»¶çš„å¤„ç†ï¼Œå¦‚æ¥å—æ–°è¿æ¥ä»¥åŠè¯»å†™æ•°æ®</li><li>æŒ‡å®šæœåŠ¡å™¨ç»‘å®šçš„æœ¬åœ°çš„InetSocketAddress</li><li>ä½¿ç”¨ä¸€ä¸ªEchoServerHandlerçš„å®ä¾‹åˆå§‹åŒ–æ¯ä¸€ä¸ªæ–°çš„channel</li><li>è°ƒç”¨ServerBootstrap.bind()æ–¹æ³•æ¥ç»‘å®šæœåŠ¡å™¨ã€‚</li></ol><h4 id=å®¢æˆ·ç«¯ä»£ç >å®¢æˆ·ç«¯ä»£ç </h4><ul><li>å®¢æˆ·ç«¯äº‹ä»¶å¤„ç†ä»£ç </li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>EchoClientHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>ByteBuf</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//    åœ¨åˆ°æœåŠ¡å™¨çš„è¿æ¥å·²ç»å»ºç«‹ä¹‹åè¢«è°ƒç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelActive</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        å»ºç«‹è¿æ¥åï¼Œå‘é€ä¸€æ¡æ¶ˆæ¯ï¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctx</span><span class=p>.</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=n>Unpooled</span><span class=p>.</span><span class=na>copiedBuffer</span><span class=p>(</span><span class=s>&#34;Netty rocks!&#34;</span><span class=p>,</span><span class=w> </span><span class=n>CharsetUtil</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//    å½“ä»æœåŠ¡æ¥æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯åè¢«è°ƒç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelRead0</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>ByteBuf</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Client received:&#34;</span><span class=o>+</span><span class=n>msg</span><span class=p>.</span><span class=na>toString</span><span class=p>(</span><span class=n>CharsetUtil</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//    å‡ºç°å¼‚å¸¸æ—¶è°ƒç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>exceptionCaught</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=n>cause</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cause</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctx</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>å¼•å¯¼å®¢æˆ·ç«¯ä»£ç </li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>EchoClient</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>host</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>EchoClient</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>host</span><span class=o>=</span><span class=n>host</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>port</span><span class=o>=</span><span class=n>port</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>NioEventLoopGroup</span><span class=w> </span><span class=n>group</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NioEventLoopGroup</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Bootstrap</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Bootstrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>b</span><span class=p>.</span><span class=na>group</span><span class=p>(</span><span class=n>group</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>channel</span><span class=p>(</span><span class=n>NioSocketChannel</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>remoteAddress</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InetSocketAddress</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=n>port</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>handler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initChannel</span><span class=p>(</span><span class=n>SocketChannel</span><span class=w> </span><span class=n>ch</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>ch</span><span class=p>.</span><span class=na>pipeline</span><span class=p>().</span><span class=na>addLast</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=k>new</span><span class=w> </span><span class=n>EchoClientHandler</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=na>connect</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>f</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>closeFuture</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>group</span><span class=p>.</span><span class=na>shutdownGracefully</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>host</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=o>=</span><span class=n>10086</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>EchoClient</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=n>port</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol><li>åˆå§‹åŒ–å®¢æˆ·ç«¯ï¼Œåˆ›å»ºä¸€ä¸ªbootstrapå®ä¾‹</li><li>ä¸ºäº‹ä»¶å¤„ç†åˆ†é…ä¸€ä¸ªnioEventLoopGroupå®ä¾‹ï¼Œå…¶ä¸­äº‹ä»¶å¤„ç†åŒ…æ‹¬åˆ›å»ºæ–°çš„è¿æ¥ä»¥åŠå¤„ç†å…¥ç«™å’Œå‡ºç«™æ•°æ®</li><li>ä¸ºæœåŠ¡å™¨è¿æ¥åˆ›å»ºä¸€ä¸ªInetSocketAddresså®ä¾‹ã€‚</li><li>å½“è¿æ¥è¢«å»ºç«‹æ—¶ï¼Œä¸€ä¸ªEchoClientHandlerå®ä¾‹è¢«å®‰è£…åˆ°channelPipelineä¸­ã€‚</li><li>åœ¨ä¸€åˆ‡éƒ½è®¾ç½®å®Œåï¼Œè°ƒç”¨bootstrapã€‚connectï¼ˆï¼‰æ–¹æ³•è¿æ¥åˆ°è¿œç¨‹èŠ‚ç‚¹ã€</li></ol><h3 id=ç¬¬ä¸‰ç« nettyçš„ç»„ä»¶å’Œè®¾è®¡>ç¬¬ä¸‰ç« ã€Nettyçš„ç»„ä»¶å’Œè®¾è®¡</h3><h4 id=channeleventloopå’Œchannelfuture>Channelã€EventLoopå’ŒChannelFuture</h4><p>Channelï¼šsocket</p><p>EventLoopï¼šæ§åˆ¶æµã€å¤šçº¿ç¨‹å¤„ç†ã€å¹¶å‘ï¼›</p><p>ChannelFutureï¼šå¼‚æ­¥é€šçŸ¥ã€‚</p><ul><li>Channelæ¥å£</li></ul><p>ç”¨æ¥å¤„ç†socketè¿æ¥</p><ul><li>EventLoopæ¥å£</li></ul><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-05/2024-7-1216_14_58-1720772097636_1747188058262.png loading=lazy alt=2024-7-1216_14_58-1720772097636.png></p><ol><li>ä¸€ä¸ªEventLoopGroupåŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªEventLoop</li><li>ä¸€ä¸ªEventLoopåœ¨å®ƒçš„ç”Ÿå‘½å‘¨æœŸå†…åªå’Œä¸€ä¸ªThreadç»‘å®š</li><li>æ‰€æœ‰ç”±EventLoopå¤„ç†çš„IOäº‹ä»¶éƒ½å°†åœ¨å®ƒä¸“æœ‰çš„Threadä¸Šè¢«å¤„ç†</li><li>ä¸€ä¸ªChannelåœ¨å®ƒçš„ç”Ÿå‘½å‘¨æœŸå†…åªæ³¨å†Œäºä¸€ä¸ªEventLoop</li><li>ä¸€ä¸ªEventLoopå¯èƒ½ä¼šè¢«åˆ†é…ç»™ä¸€ä¸ªæˆ–å¤šä¸ªChannel</li></ol><blockquote><p>ä¸€ä¸ªç»™å®šçš„Channelçš„ioæ“ä½œéƒ½æ˜¯ç”±ç›¸åŒçš„Threadæ‰§è¡Œçš„ï¼Œè¿™æ ·æ¶ˆé™¤äº†å¯¹äºåŒæ­¥çš„éœ€è¦ã€‚</p></blockquote><ul><li>ChannelFutureæ¥å£</li></ul><p>ä¸€ä¸ªæ“ä½œå¯èƒ½ä¸ä¼šç«‹åˆ»è¿”å›ï¼ŒChannelFutureæ¥å£ç”¨æ¥ç¡®è®¤å…¶ç»“æœã€‚ï¼ˆæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰</p><h4 id=channelhandlerå’Œchannelpipeline>ChannelHandlerå’ŒChannelPipeline</h4><ul><li>ChannelHandleræ¥å£</li></ul><p>Nettyçš„ä¸»è¦ç»„ä»¶å°±æ˜¯ChannelHandlerï¼Œä»–æ˜¯æ‰€æœ‰å¤„ç†å…¥ç«™ã€å‡ºç«™æ•°æ®çš„åº”ç”¨ç¨‹åºé€»è¾‘çš„å®¹å™¨ã€‚</p><ul><li>ChannelPipelineæ¥å£</li></ul><p>ChannelPipelineæä¾›äº†ChannelHandleré“¾çš„å®¹å™¨ï¼Œå¹¶å®šä¹‰äº†ç”¨äºåœ¨è¯¥é“¾ä¸Šä¼ æ’­å…¥ç«™ã€å‡ºç«™äº‹ä»¶æµçš„APIã€‚å½“Channelè¢«åˆ›å»ºï¼Œå®ƒä¼šè‡ªåŠ¨è¢«åˆ†é…åˆ°å®ƒä¸“å±çš„ChannelPipelineã€‚</p><blockquote><p>ChannelHandlerå®‰è£…åˆ°ChannelPipelineçš„è¿‡ç¨‹ï¼š</p></blockquote><ol><li>ä¸€ä¸ªChannelInitializerçš„å®ç°è¢«æ³¨å†Œåˆ°ServerBootstrapä¸­ã€‚</li><li>å½“ChannelInitializer.initChannel()æ–¹æ³•è¢«è°ƒç”¨ï¼ŒChannelInitializerå°†åœ¨ChannelPipelineä¸­å®‰è£…ä¸€ç»„è‡ªå®šä¹‰çš„ChannelHandlerï¼›</li><li>ChannelInitializerå°†å®ƒè‡ªå·±ä»ChannelPipelineä¸­ç§»é™¤ã€‚</li></ol><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-05/2024-7-1223_26_27-1720797986303_1747188083571.png loading=lazy alt=2024-7-1223_26_27-1720797986303.png></p><ul><li>ç¼–ç å™¨å’Œè§£ç å™¨</li></ul><p>ä¸€èˆ¬ï¼Œå…¥ç«™æ•°æ®ä¼šä»å­—èŠ‚è½¬æ¢ä¸ºæˆ‘ä»¬éœ€è¦çš„ç¼–ç ï¼Œå‡ºç«™æ•°æ®è¦ä»å½“å‰ç¼–ç è½¬æ¢æˆå­—èŠ‚ã€‚</p><h4 id=å¼•å¯¼>å¼•å¯¼</h4><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-05/2024-7-1617_32_17-1721122336933_1747188106888.png loading=lazy alt=2024-7-1617_32_17-1721122336933.png></p><h3 id=ç¬¬å››ç« ä¼ è¾“>ç¬¬å››ç« ã€ä¼ è¾“</h3><h4 id=æ¡ˆä¾‹ç ”ç©¶ä¼ è¾“è¿ç§»>æ¡ˆä¾‹ç ”ç©¶ï¼šä¼ è¾“è¿ç§»</h4><blockquote><p>æ¼”ç¤ºä¸€æ¬¡ä»é˜»å¡OIOè¿æ¥å¤„ç†åˆ°éé˜»å¡NIOè¿ç§»ï¼ŒjavaåŸç”Ÿå’ŒNettyçš„è¿ç§»æˆæœ¬å¯¹æ¯”ã€‚</p></blockquote><ul><li>ä¸é€šè¿‡Nettyä½¿ç”¨OIOå’ŒNIO</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>PlainOioServer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>serve</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        ç»™æœåŠ¡å™¨ç»‘å®šæŒ‡å®šç«¯å£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ServerSocket</span><span class=w> </span><span class=n>socket</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>ServerSocket</span><span class=p>(</span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                æ¥æ”¶è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Socket</span><span class=w> </span><span class=n>clientSocket</span><span class=o>=</span><span class=n>socket</span><span class=p>.</span><span class=na>accept</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Accepted conection from &#34;</span><span class=o>+</span><span class=n>clientSocket</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¤„ç†è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>OutputStream</span><span class=w> </span><span class=n>out</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                            ç»™è¿æ¥è‡ªå·±çš„å®¢æˆ·ç«¯è¿”å›æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>out</span><span class=o>=</span><span class=n>clientSocket</span><span class=p>.</span><span class=na>getOutputStream</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>out</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=s>&#34;Hi!\r\n&#34;</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=n>Charset</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;UTF-8&#34;</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>out</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                            å…³é—­è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>clientSocket</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>finally</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>clientSocket</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                                å…³é—­å¼‚å¸¸</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                    çº¿ç¨‹å¯åŠ¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸Šæ–¹ä»£ç å¯ä»¥å¤„ç†ä¸­ç­‰æ•°é‡çš„å¹¶å‘å®¢æˆ·ç«¯ã€‚ä½†éšç€åº”ç”¨ç¨‹åºæµè¡Œèµ·æ¥ï¼Œå®ƒå¹¶ä¸èƒ½å¾ˆå¥½çš„ä¼¸ç¼©åˆ°æ”¯æ’‘æˆåƒä¸Šä¸‡çš„å¹¶å‘è¿å…¥è¿æ¥ã€‚</p><ul><li>åŸºäºjava NIOçš„éé˜»å¡ç‰ˆæœ¬</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>PlainNioServer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>serve</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨Channelï¼Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerSocketChannel</span><span class=w> </span><span class=n>serverChannel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ServerSocketChannel</span><span class=p>.</span><span class=na>open</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        è®¾ç½®å½“å‰Channelä¸ºéé˜»å¡çš„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serverChannel</span><span class=p>.</span><span class=na>configureBlocking</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        è·å–å½“å‰Channelçš„socketå¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerSocket</span><span class=w> </span><span class=n>socket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>serverChannel</span><span class=p>.</span><span class=na>socket</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æ–°å»ºä¸€ä¸ªip+ç«¯å£çš„ç½‘ç»œåœ°å€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>InetSocketAddress</span><span class=w> </span><span class=n>address</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InetSocketAddress</span><span class=p>(</span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æŠŠåœ°å€ç»‘å®šåˆ°serverSocketå¯¹è±¡ä¸Š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>socket</span><span class=p>.</span><span class=na>bind</span><span class=p>(</span><span class=n>address</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æ‰“å¼€selectorï¼šå¼€å§‹æ¥æ”¶Channelä¸­çš„äº‹ä»¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Selector</span><span class=w> </span><span class=n>selector</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Selector</span><span class=p>.</span><span class=na>open</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æŠŠserverSocketæ³¨å†Œåˆ°selectorä¸Š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serverChannel</span><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>selector</span><span class=p>,</span><span class=w> </span><span class=n>SelectionKey</span><span class=p>.</span><span class=na>OP_ACCEPT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ByteBuffer</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ByteBuffer</span><span class=p>.</span><span class=na>wrap</span><span class=p>(</span><span class=s>&#34;Hi!\r\n&#34;</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                å¼€å§‹æ¥æ”¶æ—¶é—´ï¼Œç›®å‰å¤„äºé˜»å¡çŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>selector</span><span class=p>.</span><span class=na>select</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            è·å–æ—¶é—´çš„é€‰æ‹©key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span><span class=w> </span><span class=n>readyKeys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selector</span><span class=p>.</span><span class=na>selectedKeys</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            å¼€å§‹éå†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span><span class=w> </span><span class=n>iterator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>readyKeys</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>iterator</span><span class=p>.</span><span class=na>hasNext</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>iterator</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                å¼€å§‹å¤„ç†å½“å‰ä¸Šé¢çš„keyï¼Œåˆ™åˆ é™¤æ­¤keyï¼ˆé¿å…é‡å¤å¤„ç†ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>iterator</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                    åˆ¤æ–­æ˜¯å¦å°±ç»ªï¼ˆå¯ä»¥è¢«è¿æ¥ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>isAcceptable</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                        è·å–æ­¤keyçš„Channel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>ServerSocketChannel</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ServerSocketChannel</span><span class=p>)</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>channel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>SocketChannel</span><span class=w> </span><span class=n>client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>server</span><span class=p>.</span><span class=na>accept</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>client</span><span class=p>.</span><span class=na>configureBlocking</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                        æŠŠå½“å‰å®¢æˆ·ç«¯Channelçš„è¯»å†™äº‹ä»¶ç›‘å¬æ³¨å†Œåˆ°selectorä¸Š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>client</span><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>selector</span><span class=p>,</span><span class=n>SelectionKey</span><span class=p>.</span><span class=na>OP_WRITE</span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>SelectionKey</span><span class=p>.</span><span class=na>OP_READ</span><span class=p>,</span><span class=n>msg</span><span class=p>.</span><span class=na>duplicate</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;accepted connection from&#34;</span><span class=o>+</span><span class=n>client</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                    å¦‚æœå†™äº‹ä»¶å°±ç»ª</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>isWritable</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                        è·å–å½“å‰å®¢æˆ·ç«¯çš„Channel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>SocketChannel</span><span class=w> </span><span class=n>client</span><span class=o>=</span><span class=p>(</span><span class=n>SocketChannel</span><span class=p>)</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>channel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                        å½“å‰é€šé“çš„ç¼“å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>ByteBuffer</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ByteBuffer</span><span class=p>)</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>attachment</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>while</span><span class=p>(</span><span class=n>buffer</span><span class=p>.</span><span class=na>hasRemaining</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                            æŠŠæ•°æ®å†™åˆ°å½“å‰é€šé“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=p>(</span><span class=n>client</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>buffer</span><span class=p>)</span><span class=o>==</span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                        å…³é—­è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>client</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>key</span><span class=p>.</span><span class=na>cancel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>key</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å…³é—­å¤±è´¥ï¼&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>ä½¿ç”¨Nettyçš„é˜»å¡ç½‘ç»œç¼–ç¨‹</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Netty OIOæ¼”ç¤º
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>NettyOioServer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>server</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ByteBuf</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Unpooled</span><span class=p>.</span><span class=na>unreleasableBuffer</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Unpooled</span><span class=p>.</span><span class=na>copiedBuffer</span><span class=p>(</span><span class=s>&#34;Hi!\r\t&#34;</span><span class=p>,</span><span class=w> </span><span class=n>StandardCharsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æ–°å»ºä¸€ä¸ªäº‹ä»¶å¤„ç†Oioçš„çº¿ç¨‹ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EventLoopGroup</span><span class=w> </span><span class=n>group</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OioEventLoopGroup</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            åˆ›å»ºä¸€ä¸ªå¯åŠ¨å¼•å¯¼ç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ServerBootstrap</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServerBootstrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            æŠŠOIOç»„ç»‘å®šåˆ°å½“å‰å¼•å¯¼ç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>b</span><span class=p>.</span><span class=na>group</span><span class=p>(</span><span class=n>group</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                    ç»™äº‹ä»¶ç»„æŒ‡å®šå¤„ç†äº‹ä»¶çš„Channel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>channel</span><span class=p>(</span><span class=n>OioServerSocketChannel</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                    è®¾è®¡å½“å‰serverçš„ip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>localAddress</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InetSocketAddress</span><span class=p>(</span><span class=n>port</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                    æŒ‡å®šChannelçš„å¤„ç†æ–¹å¼,æ‰€æœ‰è¿æ¥éƒ½ä¼šè°ƒç”¨æ­¤æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>childHandler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initChannel</span><span class=p>(</span><span class=n>SocketChannel</span><span class=w> </span><span class=n>ch</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>ch</span><span class=p>.</span><span class=na>pipeline</span><span class=p>().</span><span class=na>addLast</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                                    ç»™å½“å‰å¤„ç†é“¾æ·»åŠ ä¸€ä¸ªæ‹¦æˆªå¤„ç†å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=k>new</span><span class=w> </span><span class=n>ChannelInboundHandlerAdapter</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                                        å¤„ç†å™¨å®ç°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelActive</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                                            æŠŠæ¶ˆæ¯å†™ç»™å®¢æˆ·ç«¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                            </span><span class=n>ctx</span><span class=p>.</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=n>buf</span><span class=p>.</span><span class=na>duplicate</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                    </span><span class=p>.</span><span class=na>addListener</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                                                            å†™å®Œæ¶ˆæ¯å,è§¦å‘è¿æ¥å…³é—­äº‹ä»¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                            </span><span class=n>ChannelFutureListener</span><span class=p>.</span><span class=na>CLOSE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            ç»‘å®šæœåŠ¡å™¨æ¥æ¥æ”¶è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=na>bind</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>f</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>closeFuture</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            é‡Šæ”¾æ‰€æœ‰èµ„æº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>group</span><span class=p>.</span><span class=na>shutdownGracefully</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>åŸºäºNettyçš„å¼‚æ­¥ç½‘ç»œå¤„ç†</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * åŸºäºNettyçš„Nioç½‘ç»œè¿æ¥
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>NettyNioServer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>server</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ByteBuf</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Unpooled</span><span class=p>.</span><span class=na>unreleasableBuffer</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Unpooled</span><span class=p>.</span><span class=na>copiedBuffer</span><span class=p>(</span><span class=s>&#34;Hi!\r\t&#34;</span><span class=p>,</span><span class=w> </span><span class=n>StandardCharsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æ–°å»ºä¸€ä¸ªäº‹ä»¶å¤„ç†Oioçš„çº¿ç¨‹ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>NioEventLoopGroup</span><span class=w> </span><span class=n>group</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NioEventLoopGroup</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            åˆ›å»ºä¸€ä¸ªå¯åŠ¨å¼•å¯¼ç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ServerBootstrap</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServerBootstrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            æŠŠOIOç»„ç»‘å®šåˆ°å½“å‰å¼•å¯¼ç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>b</span><span class=p>.</span><span class=na>group</span><span class=p>(</span><span class=n>group</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                    ç»™äº‹ä»¶ç»„æŒ‡å®šå¤„ç†äº‹ä»¶çš„Channel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>channel</span><span class=p>(</span><span class=n>NioServerSocketChannel</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                    è®¾è®¡å½“å‰serverçš„ip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>localAddress</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InetSocketAddress</span><span class=p>(</span><span class=n>port</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                    æŒ‡å®šChannelçš„å¤„ç†æ–¹å¼,æ‰€æœ‰è¿æ¥éƒ½ä¼šè°ƒç”¨æ­¤æ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>childHandler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initChannel</span><span class=p>(</span><span class=n>SocketChannel</span><span class=w> </span><span class=n>ch</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>ch</span><span class=p>.</span><span class=na>pipeline</span><span class=p>().</span><span class=na>addLast</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                                    ç»™å½“å‰å¤„ç†é“¾æ·»åŠ ä¸€ä¸ªæ‹¦æˆªå¤„ç†å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=k>new</span><span class=w> </span><span class=n>ChannelInboundHandlerAdapter</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=c1>//                                        å¤„ç†å™¨å®ç°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelActive</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                                            æŠŠæ¶ˆæ¯å†™ç»™å®¢æˆ·ç«¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                            </span><span class=n>ctx</span><span class=p>.</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=n>buf</span><span class=p>.</span><span class=na>duplicate</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                    </span><span class=p>.</span><span class=na>addListener</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//                                                            å†™å®Œæ¶ˆæ¯å,è§¦å‘è¿æ¥å…³é—­äº‹ä»¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                            </span><span class=n>ChannelFutureListener</span><span class=p>.</span><span class=na>CLOSE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            ç»‘å®šæœåŠ¡å™¨æ¥æ¥æ”¶è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=na>bind</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>f</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>closeFuture</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            é‡Šæ”¾æ‰€æœ‰èµ„æº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>group</span><span class=p>.</span><span class=na>shutdownGracefully</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åªä¿®æ”¹äº†ä¸¤è¡Œä»£ç ï¼š</p><ol><li>æŠŠäº‹ä»¶å¤„ç†çš„ç»„ä»OioEventLoopGroupæ¢æˆäº†NioEventLoopGroupã€‚</li><li>æŠŠå½“å‰ç»„ç»‘å®šçš„æ—¶é—´å¤„ç†Channelä»OioServerSocketChannel.classæ¢æˆNioServerSocketChannel.class</li></ol><p>å…¶ä»–æ— éœ€ä¿®æ”¹ã€‚</p><p>Nettyæ¯ç§ä¼ è¾“çš„å®ç°éƒ½æš´éœ²ç›¸åŒçš„APIï¼Œæ‰€ä»¥æ— è®ºé€‰æ‹©å“ªç§å®ç°ï¼Œå…¶ä»–ä»£ç å‡ ä¹éƒ½ä¸å—å½±å“ã€‚</p><h4 id=ä¼ è¾“api>ä¼ è¾“API</h4><p>ä¼ è¾“apiçš„æ ¸å¿ƒæ˜¯Channelæ¥å£ï¼Œå®ƒè¢«ç”¨äºæ‰€æœ‰çš„IOæ“ä½œã€‚</p><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/17213748431541721374842200.png loading=lazy alt=17213748431541721374842200.png></p><p>æ¯ä¸ªChanneléƒ½ä¼šåˆ†é…ä¸€ä¸ªChannelPipelineå’ŒChannelConfigã€‚</p><ul><li>ChannelConfig</li></ul><p>åŒ…å«äº†è¯¥Channelçš„æ‰€æœ‰é…ç½®è®¾ç½®ï¼Œå¹¶ä¸”æ”¯æŒçƒ­æ›´æ–°ã€‚</p><ul><li>ChannelPipeline</li></ul><p>æŒæœ‰æ‰€æœ‰ç”¨äºå…¥ç«™å’Œå‡ºç«™æ•°æ®ä»¥åŠäº‹ä»¶çš„ChannelHandlerå®ä¾‹ã€‚</p><p>ChannelHandlerå®ç°äº†åº”ç”¨ç¨‹åºå¤„ç†çŠ¶æ€å˜åŒ–ä»¥åŠæ•°æ®å¤„ç†çš„é€»è¾‘ã€‚</p><ul><li>ChannelHandlerçš„ç”¨é€”ï¼š</li></ul><ol><li>å°†æ•°æ®çš„ä¸€ç§æ ¼å¼è½¬æ¢æˆå¦ä¸€ç§æ ¼å¼</li><li>æä¾›å¼‚å¸¸çš„é€šçŸ¥</li><li>æä¾›Channelå˜ä¸ºæ´»åŠ¨æˆ–è€…éæ´»åŠ¨çš„é€šçŸ¥</li><li>å½“Channelæ³¨å†Œåˆ°EventLoopæˆ–è€…ä»EventLoopæ³¨é”€æ—¶çš„é€šçŸ¥</li><li>ç”¨æˆ·è‡ªå®šä¹‰äº‹ä»¶çš„é€šçŸ¥ã€‚</li></ol><ul><li>Channelçš„å‡ ä¸ªé‡è¦æ–¹æ³•</li></ul><div class=table-wrapper><table><thead><tr><th>æ–¹æ³•å</th><th>æè¿°</th></tr></thead><tbody><tr><td>eventLoop</td><td>è¿”å›åˆ†é…ç»™Channelçš„EventLoop</td></tr><tr><td>Pipeline</td><td>è¿”å›åˆ†é…ç»™Channelçš„ChannelPipeline</td></tr><tr><td>isActive</td><td>å¦‚æœChannelæ˜¯æ´»åŠ¨çš„ï¼Œè¿”å›trueã€‚ï¼ˆä¸€ä¸ªsocketä¼ è¾“ä¸€æ—¦è¿æ¥åˆ°äº†è¿œç¨‹èŠ‚ç‚¹ä¾¿æ˜¯æ´»åŠ¨çš„ï¼Œä¸€ä¸ªDatagramä¼ è¾“ä¸€æ—¦è¢«æ‰“å¼€å°±æ˜¯æ´»åŠ¨çš„ï¼‰</td></tr><tr><td>localAddress</td><td>è¿”å›æœ¬åœ°socketAddress</td></tr><tr><td>remoteAddress</td><td>è¿”å›è¿œç¨‹socketAddress</td></tr><tr><td>write</td><td>æŠŠæ•°æ®å†™åˆ°è¿œç¨‹èŠ‚ç‚¹ã€‚è¿™ä¸ªæ•°æ®å°†è¢«ä¼ é€’ç»™ChannelPipelineï¼Œå¹¶ä¸”æ’é˜Ÿç›´åˆ°å®ƒè¢«å†²åˆ·</td></tr><tr><td>flush</td><td>å°†ä¹‹å‰å·²å†™çš„æ•°æ®å†²åˆ·åˆ°åº•å±‚ä¼ è¾“ï¼Œå¦‚ä¸€ä¸ªsocket</td></tr><tr><td>writeAndFlush</td><td>å…ˆè°ƒç”¨writeç„¶åè°ƒç”¨flush</td></tr></tbody></table></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//    å†™å‡ºæ•°æ®åˆ°Channel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>demo1</span><span class=p>(</span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        ç”³è¯·ç©ºé—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ByteBuf</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Unpooled</span><span class=p>.</span><span class=na>copiedBuffer</span><span class=p>(</span><span class=s>&#34;your data&#34;</span><span class=p>,</span><span class=w> </span><span class=n>CharsetUtil</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        å†™å®Œæ•°æ®å¹¶å†²åˆ·ï¼ˆæäº¤ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>cf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channel</span><span class=p>.</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æ·»åŠ ChannelFutureListenerç”¨æ¥å†™å®Œåæ¥æ”¶é€šçŸ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cf</span><span class=p>.</span><span class=na>addListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelFutureListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>operationComplete</span><span class=p>(</span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>future</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>future</span><span class=p>.</span><span class=na>isSuccess</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;write successful&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>else</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;write error&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>future</span><span class=p>.</span><span class=na>cause</span><span class=p>().</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//    å¤šä¸ªçº¿ç¨‹ä½¿ç”¨åŒä¸€ä¸ªChannel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>demo2</span><span class=p>(</span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ByteBuf</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Unpooled</span><span class=p>.</span><span class=na>copiedBuffer</span><span class=p>(</span><span class=s>&#34;your data&#34;</span><span class=p>,</span><span class=w> </span><span class=n>CharsetUtil</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        åˆ›å»ºä¸€ä¸ªæŠŠæ•°æ®å†™åˆ°Channelçš„runnable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Runnable</span><span class=w> </span><span class=n>write</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>channel</span><span class=p>.</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=n>buf</span><span class=p>.</span><span class=na>duplicate</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        è·å–ä¸€ä¸ªçº¿ç¨‹æ± </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Executor</span><span class=w> </span><span class=n>executor</span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newCachedThreadPool</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æŠŠä»»åŠ¡æäº¤ç»™ä¸€ä¸ªçº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>executor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>write</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æŠŠä»»åŠ¡æäº¤ç»™å¦ä¸€ä¸ªçº¿ç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>executor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>write</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Nettyçš„Channelæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æ— è®ºæ˜¯æäº¤ç»™ä¸€ä¸ªçº¿ç¨‹è¿˜æ˜¯å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ï¼Œéƒ½ä¸ä¼šæœ‰é—®é¢˜ã€‚</p><h4 id=å†…ç½®çš„ä¼ è¾“>å†…ç½®çš„ä¼ è¾“</h4><ul><li>Nettyæ‰€æä¾›çš„ä¼ è¾“</li></ul><div class=table-wrapper><table><thead><tr><th>åç§°</th><th>åŒ…</th><th>æè¿°</th></tr></thead><tbody><tr><td>NIO</td><td>io.netty.channel.socket.nio</td><td>ä½¿ç”¨java.nio.channelsåŒ…ä½œä¸ºåŸºç¡€&ndash;åŸºäºé€‰æ‹©å™¨çš„æ–¹å¼</td></tr><tr><td>Epoll</td><td>io.netty.channel.epoll</td><td>ç”±JNIé©±åŠ¨çš„epollå’Œéé˜»å¡IOã€‚è¿™ä¸ªä¼ è¾“æ”¯æŒåªæœ‰åœ¨linuxä¸Š å¯ç”¨çš„å¤šç§ç‰¹æ€§ï¼Œå¦‚SO_REUSEPORTï¼Œæ¯”NIOä¼ è¾“æ›´å¿«ï¼Œè€Œä¸”æ˜¯å®Œå…¨éé˜»å¡çš„</td></tr><tr><td>OIO</td><td>io.netty.channel.oioï¼ˆå·²å¼ƒç”¨ï¼‰</td><td>ä½¿ç”¨java.netåŒ…ä½œä¸ºåŸºç¡€&ndash;ä½¿ç”¨é˜»å¡æµ</td></tr><tr><td>local</td><td>io.netty.channel.local</td><td>å¯ä»¥åœ¨VMå†…éƒ¨é€šè¿‡ç®¡é“è¿›è¡Œé€šä¿¡çš„æœ¬åœ°ä¼ è¾“</td></tr><tr><td>embedded</td><td>io.netty.channel.embedded</td><td>å…è®¸ä½¿ç”¨ChannelHandlerè€Œåˆä¸éœ€è¦ä¸€ä¸ªçœŸæ­£åŸºäºç½‘ç»œçš„ä¼ è¾“ã€‚</td></tr><tr><td>kqueue</td><td></td><td></td></tr></tbody></table></div><ul><li>NIO&mdash;-éé˜»å¡IO</li></ul><p>NIOä¸€ä¸ªæ‰€æœ‰IOæ“ä½œå®Œå…¨å¼‚æ­¥çš„å®ç°ã€‚</p><blockquote><p>åŸºäºé€‰æ‹©å™¨çš„API</p></blockquote><p>é€‰æ‹©å™¨å……å½“äº†ä¸€ä¸ªæ³¨å†Œè¡¨ï¼Œåœ¨é‚£é‡Œå¯ä»¥è¯·æ±‚åœ¨Channelçš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶å¾—åˆ°é€šçŸ¥ã€‚</p><ol><li>æ–°çš„Channelå·²è¢«æ¥å—å¹¶ä¸”å°±ç»ª</li><li>Channelè¿æ¥å·²ç»å®Œæˆ</li><li>Channelæœ‰å·²ç»å°±ç»ªçš„å¯ä¾›è¯»å–çš„æ•°æ®</li><li>Channelå¯ç”¨äºå†™æ•°æ®</li></ol><blockquote><p>é€‰æ‹©æ“ä½œçš„ä½æ¨¡å¼</p></blockquote><div class=table-wrapper><table><thead><tr><th>åç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td>OP_ACCEPT</td><td>è¯·æ±‚åœ¨æ¥å—æ–°è¿æ¥å¹¶åˆ›å»ºChannelæ—¶è·å¾—é€šçŸ¥</td></tr><tr><td>OP_CONNECT</td><td>è¯·æ±‚åœ¨å»ºç«‹ä¸€ä¸ªè¿æ¥æ—¶è·å¾—é€šçŸ¥</td></tr><tr><td>OP_READ</td><td>è¯·æ±‚å½“æ•°æ®å·²å°±ç»ªï¼Œå¯ä»¥ä»Channelä¸­è¯»å–æ—¶è·å¾—é€šçŸ¥</td></tr><tr><td>OP_WRITE</td><td>è¯·æ±‚å½“å¯ä»¥æƒ³Channelä¸­å†™æ›´å¤šæ•°æ®æ—¶è·å¾—é€šçŸ¥ã€‚</td></tr></tbody></table></div><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/17213824004291721382399481.png loading=lazy alt=17213824004291721382399481.png></p><blockquote><p>é›¶æ‹·è´ï¼ˆZero-copyï¼‰</p></blockquote><p>ç›®å‰åªæœ‰åœ¨ä½¿ç”¨NIOå’ŒEpollä¼ è¾“æ—¶æ‰å¯ä½¿ç”¨çš„ç‰¹æ€§ã€‚å¯ä»¥å¿«é€Ÿé«˜æ•ˆåœ°å°†æ•°æ®ä»æ–‡ä»¶ç³»ç»Ÿç§»åŠ¨åˆ°ç½‘ç»œæ¥å£ï¼Œè€Œä¸éœ€è¦å°†å…¶ä»å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ã€‚åœ¨FTPæˆ–è€…HTTPè¿™æ ·çš„åè®®ä¸­å¯ä»¥æ˜¾è‘—åœ°æé«˜æ€§èƒ½ã€‚ï¼ˆå¹¶ä¸æ˜¯æ‰€æœ‰æ“ä½œç³»ç»Ÿéƒ½æ”¯æŒï¼‰</p><blockquote><p>é›¶æ‹·è´å¯¹äºå®ç°äº†æ•°æ®åŠ å¯†æˆ–è€…å‹ç¼©çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸å¯ç”¨çš„ï¼ˆåªèƒ½ä¼ è¾“æ–‡ä»¶çš„åŸå§‹å†…å®¹ï¼‰</p></blockquote><ul><li>Epoll&ndash;ç”¨äºLinuxçš„æœ¬åœ°éé˜»å¡ä¼ è¾“</li></ul><blockquote><p>Linuxä¸“å±çš„NIO APIï¼Œåœ¨é«˜è´Ÿè½½ä¸‹å®ƒçš„æ€§èƒ½è¦ä¼˜äºJDKçš„NIOå®ç°ã€‚</p></blockquote><p>åŸç†å’Œå›¾4-2å®Œå…¨ç›¸åŒã€‚</p><ul><li>OIO-æ—§çš„é˜»å¡IOï¼ˆå·²åºŸå¼ƒï¼‰</li></ul><p>å»ºç«‹åœ¨java.netåŒ…çš„é˜»å¡å®ç°ä¹‹ä¸Šçš„ï¼Œéå¼‚æ­¥ã€‚</p><ul><li>ç”¨äºJVMå†…éƒ¨é€šä¿¡çš„Localä¼ è¾“</li></ul><p>ç”¨äºåœ¨åŒä¸€ä¸ªJVMä¸­è¿è¡Œçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç¨‹åºä¹‹é—´çš„å¼‚æ­¥é€šä¿¡ã€‚</p><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/17219082813701721908281040.png loading=lazy alt=17219082813701721908281040.png></p><ul><li>Embeddedä¼ è¾“</li></ul><p>Nettyæä¾›çš„é¢å¤–çš„ä¼ è¾“ï¼Œå¯ä»¥å°†ä¸€ç»„ChannelHandlerä½œä¸ºå¸®åŠ©ç±»åµŒå…¥åˆ°å…¶ä»–çš„ChannelHandlerå†…éƒ¨ã€‚</p><h4 id=ä¼ è¾“çš„ç”¨ä¾‹>ä¼ è¾“çš„ç”¨ä¾‹</h4><div class=table-wrapper><table><thead><tr><th>ä¼ è¾“</th><th>TCP</th><th>UDP</th><th>SCTP</th><th>UDT</th></tr></thead><tbody><tr><td>NIO</td><td>Y</td><td>Y</td><td>Y</td><td>Y</td></tr><tr><td>Epoll(ä»…linux)</td><td>Y</td><td>Y</td><td>N</td><td>N</td></tr><tr><td>OIO</td><td>Y</td><td>Y</td><td>Y</td><td>Y</td></tr></tbody></table></div><ul><li>æ¯ç§åº”ç”¨ç¨‹åºæ¨èçš„ä¼ è¾“æ–¹å¼</li></ul><div class=table-wrapper><table><thead><tr><th>åº”ç”¨ç¨‹åºçš„éœ€æ±‚</th><th>æ¨èçš„ä¼ è¾“</th></tr></thead><tbody><tr><td>éé˜»å¡ä»£ç åº“æˆ–è€…ä¸€ä¸ªå¸¸è§„ä»£ç çš„èµ·æ­¥</td><td>NIOï¼ˆæˆ–è€…åœ¨Linuxä¸Šä½¿ç”¨epollï¼‰</td></tr><tr><td>é˜»å¡ä»£ç åº“</td><td>OIO</td></tr><tr><td>åŒä¸€ä¸ªJVMå†…éƒ¨</td><td>Local</td></tr><tr><td>æµ‹è¯•ChannelHandlerçš„å®ç°</td><td>Embedded</td></tr></tbody></table></div><h3 id=ç¬¬äº”ç« bytebuf>ç¬¬äº”ç« ã€Bytebuf</h3><h4 id=bytebufçš„api>ByteBufçš„API</h4><ul><li>ä¼˜ç‚¹</li></ul><ol><li>å¯ä»¥è¢«ç”¨æˆ·è‡ªå®šä¹‰çš„ç¼“å†²åŒºç±»å‹æ‰©å±•</li><li>é€šè¿‡å†…ç½®çš„å¤åˆç¼“å†²åŒºå®ç°äº†é€æ˜çš„é›¶æ‹·è´</li><li>å®¹é‡å¯ä»¥æŒ‰éœ€å¢é•¿ï¼ˆç±»ä¼¼äºJDKçš„StringBuilderï¼‰</li><li>åœ¨è¯»å’Œå†™ä¸¤ç§æ¨¡å¼ä¹‹é—´åˆ‡æ¢ä¸éœ€è¦è°ƒç”¨bytebufferçš„flip()æ–¹æ³•</li><li>è¯»å’Œå†™ä½¿ç”¨äº†ä¸åŒçš„ç´¢å¼•</li><li>æ”¯æŒæ–¹æ³•çš„é“¾å¼è°ƒç”¨</li><li>æ”¯æŒå¼•ç”¨è®¡æ•°</li><li>æ”¯æŒæ± åŒ–</li></ol><h4 id=bytebufç±»nettyçš„æ•°æ®å®¹å™¨>ByteBufç±»&ndash;Nettyçš„æ•°æ®å®¹å™¨</h4><ul><li>åŸç†</li></ul><p>ByteBufç»´æŠ¤äº†ä¸¤ä¸ªä¸åŒçš„ç´¢å¼•ï¼šä¸€ä¸ªç”¨äºè¯»å–ï¼Œä¸€ä¸ªç”¨äºå†™å…¥ã€‚</p><p>å½“ä½ ä»ByteBufä¸­è¯»å–æ—¶ï¼Œå®ƒçš„readerIndexå°†ä¼šè¢«é€’å¢å·²ç»è¢«è¯»å–çš„å­—èŠ‚æ•°ã€‚</p><p>å½“å†™å…¥bytebufæ—¶ï¼Œå®ƒçš„writerIndexä¹Ÿä¼šè¢«é€’å¢ã€‚</p><ul><li>ä¸‹æ ‡è¶Šç•Œå¼‚å¸¸</li></ul><blockquote><p>å½“ä½ è¯»å–åˆ°â€œå¯ä»¥è¯»å–çš„â€æ•°æ®çš„æœ«å°¾ï¼ˆè¯»å–æŒ‡é’ˆç­‰äºå½“å‰å†™å…¥æŒ‡é’ˆçš„ä½ç½®ï¼‰ï¼Œå¦‚æœä»è¯•å›¾è¯»å–è¶…å‡ºè¯¥ç‚¹çš„æ•°æ®ï¼Œä¼šè§¦å‘IndexOutOfBoundsException</p></blockquote><ul><li>å †ç¼“å†²åŒºï¼ˆæ”¯æ’‘æ•°ç»„backing arrayï¼‰</li></ul><blockquote><p>å°†æ•°æ®å­˜å‚¨åœ¨JVMçš„å †å†…å­˜ä¸­ï¼Œå¯ä»¥åœ¨æ²¡æœ‰ä½¿ç”¨æ± åŒ–çš„æƒ…å†µä¸‹æä¾›å¿«é€Ÿçš„åˆ†é…å’Œé‡Šæ”¾ã€‚</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * å †ç¼“å†²åŒºæ–¹å¼ä½¿ç”¨bytebufã€‚
</span></span></span><span class=line><span class=cl><span class=cm>     * @param buf   ç¼“å†²åŒº
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>byteBufNum</span><span class=p>(</span><span class=n>ByteBuf</span><span class=w> </span><span class=n>buf</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æ£€æµ‹bytebufæ˜¯å¦å­˜åœ¨æ”¯æ’‘æ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>buf</span><span class=p>.</span><span class=na>hasArray</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            è·å–è¯¥æ”¯æ’‘æ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>array</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buf</span><span class=p>.</span><span class=na>array</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            è®¡ç®—å‡ºå½“å‰çš„åç§»é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buf</span><span class=p>.</span><span class=na>arrayOffset</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>buf</span><span class=p>.</span><span class=na>readerIndex</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            è·å–å¯è¯»çš„å­—èŠ‚æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buf</span><span class=p>.</span><span class=na>readableBytes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            handleArray(array,offset,len);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>ç›´æ¥ç¼“å†²åŒº</li></ul><blockquote><p>é€šè¿‡ç›´æ¥å†…å­˜æ¥è®¿é—®æ•°æ®ï¼Œç”±äºç¼“å†²åŒºä¸­çš„æ•°æ®ä¸æ˜¯åœ¨JVMå†…éƒ¨çš„æ‰€ä»¥ä¸ä¼šè‡ªåŠ¨åƒåœ¾å›æ”¶ã€‚</p></blockquote><p>ä¼˜ç‚¹ï¼š</p><p>ç†æƒ³çš„ç½‘ç»œæ•°æ®ä¼ è¾“é€‰æ‹©ã€‚ä¼ ç»Ÿå †ä¸­çš„ç¼“å†²åŒºçš„æ•°æ®ï¼ŒJVMåœ¨è¿›è¡Œç½‘ç»œä¼ è¾“æ—¶ï¼Œä¼šå…ˆæŠŠå †ä¸­çš„æ•°æ®å¤åˆ¶åˆ°å †å¤–ï¼Œç„¶åå†å‘é€ã€‚</p><p>ç¼ºç‚¹ï¼š</p><ol><li>ç”±äºæ•°æ®åœ¨å †å¤–ï¼Œæ‰€ä»¥åˆ†é…å’Œé‡Šæ”¾ç©ºé—´éƒ½æ¯”è¾ƒæ˜‚è´µã€‚</li><li>å› ä¸ºæ•°æ®ä¸åœ¨å †ä¸Šï¼Œæ‰€ä»¥ä¸å¾—ä¸è¿›è¡Œä¸€æ¬¡å¤åˆ¶ã€‚</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * é€šè¿‡ç›´æ¥å†…å­˜æ“ä½œç¼“å†²åŒº
</span></span></span><span class=line><span class=cl><span class=cm>     * @param directBuf ç¼“å†²åŒº
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>byteBufDirect</span><span class=p>(</span><span class=n>ByteBuf</span><span class=w> </span><span class=n>directBuf</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æ£€æµ‹æ˜¯å¦å­˜åœ¨æ•°ç»„ç¼“å†²åŒºï¼Œå¦‚æœä¸åˆ™è®¤ä¸ºå½“å‰ç¼“å†²åŒºæ˜¯ç›´æ¥å†…å­˜ç¼“å†²åŒº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>directBuf</span><span class=p>.</span><span class=na>hasArray</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            è·å–å½“å‰ç¼“å†²åŒºçš„å¯è¯»é•¿åº¦</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>directBuf</span><span class=p>.</span><span class=na>readableBytes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            åˆ†é…å­—èŠ‚æ•°ç»„æ¥æ¥æ”¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>array</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>length</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            ä»ç¼“å†²åŒºè¯»å–æ•°æ®åˆ°ä¸Šæ–¹æ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>directBuf</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(</span><span class=n>directBuf</span><span class=p>.</span><span class=na>readerIndex</span><span class=p>(),</span><span class=n>array</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//            handleArray(array,offset,len);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>å¤åˆç¼“å†²åŒº</li></ul><blockquote><p>Nettyé€šè¿‡ä¸€ä¸ªbyteBufå­ç±»&ndash;CompositeByteBuf&ndash;å®ç°äº†è¿™ä¸ªæ¨¡å¼ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå°†å¤šä¸ªç¼“å†²åŒºè¡¨ç¤ºä¸ºå•ä¸ªåˆå¹¶ç¼“å†²åŒºçš„è™šæ‹Ÿè¡¨ç¤ºã€‚</p></blockquote><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/17223414940961722341493900.png loading=lazy alt=17223414940961722341493900.png></p><p>å°†é€šå¸¸ä¸ä¼šå˜åŠ¨çš„æ•°æ®å­˜æ”¾åˆ°ä¸»ä½“ç¼“å†²åŒºï¼Œå°†ç»å¸¸å˜åŠ¨çš„æ•°æ®å­˜æ”¾åˆ°å¤´éƒ¨ç¼“å†²åŒºã€‚</p><p>å¤šä¸ªå¤´éƒ¨ç¼“å†²åŒºå¯ä»¥å…±äº«åŒä¸€ä¸ªä¸»ä½“ç¼“å†²åŒºã€‚</p><p>å°†ä¸åŒçš„ä¸»ä½“å’Œå¤´éƒ¨ç»„åˆåœ¨ä¸€èµ·ï¼Œå¯ä»¥çœ‹åšä¸€ä¸ªä¸åŒçš„ç¼“å†²åŒºã€‚</p><blockquote><p>è¿™æ ·æ“ä½œå¯ä»¥é¿å…æ²¡æœ‰å¿…è¦çš„å¤åˆ¶ã€‚ï¼ˆä¸»ä½“ç¼“å†²åŒºå§‹ç»ˆåªæœ‰ä¸€ä»½ï¼‰</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * å¤åˆç¼“å†²åŒº
</span></span></span><span class=line><span class=cl><span class=cm>     * @param headByteBuf å¤´ç¼“å†²åŒº
</span></span></span><span class=line><span class=cl><span class=cm>     * @param bodyBuf ä¸»ä½“ç¼“å†²åŒº
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>ByteBufComposite</span><span class=p>(</span><span class=n>ByteBuf</span><span class=w> </span><span class=n>headByteBuf</span><span class=p>,</span><span class=n>ByteBuf</span><span class=w> </span><span class=n>bodyBuf</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CompositeByteBuf</span><span class=w> </span><span class=n>messageBuf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Unpooled</span><span class=p>.</span><span class=na>compositeBuffer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>messageBuf</span><span class=p>.</span><span class=na>addComponents</span><span class=p>(</span><span class=n>headByteBuf</span><span class=p>,</span><span class=n>bodyBuf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        è®¿é—®CompositeByteBufä¸­çš„æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>messageBuf</span><span class=p>.</span><span class=na>readableBytes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        åˆ›å»ºä¸€ä¸ªç”¨æ¥å­˜æ”¾å¤åˆç¼“å†²åŒºä¸­æ•°æ®çš„ç©ºé—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>array</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>length</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å¤åˆ¶åˆ°ç©ºé—´ä¸­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>messageBuf</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(</span><span class=n>messageBuf</span><span class=p>.</span><span class=na>readerIndex</span><span class=p>(),</span><span class=w> </span><span class=n>array</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        åˆ é™¤å¤åˆç¼“å†²åŒºä¸­çš„ç¬¬ä¸€ä¸ªç¼“å†²åŒº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>messageBuf</span><span class=p>.</span><span class=na>removeComponent</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>ByteBuf</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>messageBuf</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>buf</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=å­—èŠ‚çº§æ“ä½œ-bytebufç›¸å…³çš„æ“ä½œ>å­—èŠ‚çº§æ“ä½œ ByteBufç›¸å…³çš„æ“ä½œ</h4><ul><li>éšæœºè®¿é—®ç´¢å¼•</li></ul><p>ç›´æ¥é€šè¿‡buffer.getByte(i)é€šè¿‡ä¸‹æ ‡è®¿é—®ç¼“å†²åŒºä¸­çš„æ•°æ®</p><p>è¿™æ ·ä¸ä¼šæ”¹å˜readerIndexå’ŒwriterIndex</p><ul><li>é¡ºåºè®¿é—®</li></ul><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/17223435050931722343504656.png loading=lazy alt=17223435050931722343504656.png></p><ul><li>å¯ä¸¢å¼ƒçš„å­—èŠ‚</li></ul><p>é€šè¿‡è°ƒç”¨discardReadBytes()æ–¹æ³•æ¥ä¸¢å¼ƒå›æ”¶å¯ä¸¢å¼ƒçš„ç©ºé—´ã€‚</p><p>è¢«å›æ”¶çš„ç©ºé—´ä¼šç”¨æ¥åˆ†é…ç»™å¯å†™ç©ºé—´ä¸­ï¼Œä½†ä¸æ˜¯ç›´æ¥åˆ†é…ã€‚è€Œæ˜¯ä¼šè§¦å‘ä¸€ä¸ªæ•´ç†çš„è¿‡ç¨‹ã€‚æ‰€æœ‰æœªè¯»çš„ç©ºé—´æ•´ç†åˆ°å†…å­˜çš„å¤´éƒ¨ï¼Œå†ç§»åŠ¨å¯è¯»å’Œå¯å†™çš„ä¸‹æ ‡ã€‚</p><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/17223437700931722343769639.png loading=lazy alt=17223437700931722343769639.png></p><blockquote><p>ä¼šå¯¼è‡´å†…å­˜å¤åˆ¶ã€‚</p></blockquote><ul><li>å¯è¯»å­—èŠ‚</li></ul><p>å¯è¯»å­—èŠ‚ä¸­çš„å†…å­˜å­˜æ”¾äº†çœŸæ­£çš„æ•°æ®ã€‚</p><ul><li>å¯å†™å­—èŠ‚</li></ul><p>å¯å†™å­—èŠ‚è¡¨ç¤ºä¸ºè¢«å®šä¹‰ã€æˆ–è€…å†™å…¥å°±ç»ªçš„å†…å­˜åŒºåŸŸã€‚ï¼ˆè¿™ä¸ªåŒºåŸŸä¸­æœ‰å¯èƒ½æœ‰éƒ¨åˆ†è„æ•°æ®ï¼‰</p><h4 id=bytebufholderæ¥å£>ByteBufHolderæ¥å£</h4><blockquote><p>Nettyç”¨æ¥ç®¡ç†ByteBufçš„æ¥å£</p></blockquote><div class=table-wrapper><table><thead><tr><th>åç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td>content()</td><td>è¿”å›ç”±è¿™ä¸ªByteBufholderæ‰€æŒæœ‰çš„ByteBuf</td></tr><tr><td>copy</td><td>è¿”å›ByteBufHolderçš„ä¸€ä¸ªæ·±æ‹·è´ï¼ŒåŒ…æ‹¬å«æœ‰ä¸€ä¸ªå…¶åŒ…å«çš„ByteBufçš„éå…±äº«æ‹·è´</td></tr><tr><td>duplicate</td><td>è¿”å›ByteBufHolderçš„ä¸€ä¸ªæµ…æ‹·è´ï¼ŒåŒ…æ‹¬ä¸€ä¸ªå…¶æ‰€åŒ…å«çš„ByteBufçš„å…±äº«æ‹·è´</td></tr></tbody></table></div><h4 id=bytebufåˆ†é…å’Œç®¡ç†>ByteBufåˆ†é…å’Œç®¡ç†</h4><blockquote><p>ç®¡ç†ByteBufå®ä¾‹çš„ä¸åŒæ–¹å¼</p></blockquote><h5 id=æŒ‰éœ€åˆ†é…bytebufallocatoræ¥å£>æŒ‰éœ€åˆ†é…ByteBufAllocatoræ¥å£</h5><blockquote><p>å®ç°äº†ByteBufçš„æ± åŒ–æŠ€æœ¯</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//    è·å–ByteBufAllocatorå¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>ByteBufAllocator</span><span class=p>(</span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=p>,</span><span class=w> </span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        ä»Channelä¸­è·å–ByteBufAllocator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ByteBufAllocator</span><span class=w> </span><span class=n>allocator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channel</span><span class=p>.</span><span class=na>alloc</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        ä»ChannelHandlerä¸­è·å–ByteBufAllocator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ByteBufAllocator</span><span class=w> </span><span class=n>allocator2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>alloc</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Nettyæä¾›äº†ä¸¤ç§ByteBufAllocatorçš„å®ç°ï¼š</p><ul><li>PooledByteBufAllocatorï¼ˆé»˜è®¤ï¼‰</li></ul><p>æ± åŒ–äº†ByteBufçš„å®ä¾‹ä»¥æé«˜æ€§èƒ½å¹¶æœ€å¤§é™åº¦åœ°å‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæ­¤å®ç°ä½¿ç”¨äº†ä¸€ç§ç§°ä¸ºjemallocâ‘¡ çš„å·²è¢«å¤§é‡ç°ä»£æ“ä½œç³»ç»Ÿæ‰€é‡‡ç”¨çš„é«˜æ•ˆæ–¹æ³•æ¥åˆ†é…å†…å­˜ã€‚</p><ul><li>UnpooledByteBufAllocator</li></ul><p>éæ± åŒ–æŠ€æœ¯</p><h5 id=unpooledç¼“å†²åŒº>Unpooledç¼“å†²åŒº</h5><p>æœ‰é™æ€çš„è¾…åŠ©æ–¹æ³•ï¼Œæ¥æä¾›æœªæ± åŒ–çš„ByteBufå®ä¾‹ã€‚</p><h5 id=bytebufutilç±»>ByteBufUtilç±»</h5><p>æä¾›äº†ç”¨äºæ“ä½œByteBufçš„è¾…åŠ©æ–¹æ³•ã€‚</p><h4 id=å¼•ç”¨è®¡æ•°>å¼•ç”¨è®¡æ•°</h4><p>Nettyä½¿ç”¨ReferenceCountedå®ç°çš„å¼•ç”¨è®¡æ•°ï¼Œæ¥ç®¡ç†æ± åŒ–ByteBufä¸­æ˜¯å¦è¦å›æ”¶å†…å­˜ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//    é‡Šæ”¾ByteBufçš„ç©ºé—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>ByteBufReferenceCounted</span><span class=p>(</span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        ä»Channelä¸­è·å–æ± ç®¡ç†å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ByteBufAllocator</span><span class=w> </span><span class=n>allocator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channel</span><span class=p>.</span><span class=na>alloc</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        ä»æ± ä¸­è·å–ByteBufå¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ByteBuf</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>allocator</span><span class=p>.</span><span class=na>directBuffer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æ£€æŸ¥å½“å‰ByteBufå¼•ç”¨æ•°æ˜¯å¦ä¸º1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>assert</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=na>refCnt</span><span class=p>()</span><span class=o>==</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        é‡Šæ”¾å†…å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>release</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=na>release</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=ç¬¬å…­ç« channelhandlerå’Œchannelpipeline>ç¬¬å…­ç« ã€ChannelHandlerå’ŒChannelPipeline</h3><h4 id=channelhandlerå®¶æ—>Channelhandlerå®¶æ—</h4><h5 id=channelçš„ç”Ÿå‘½å‘¨æœŸ>Channelçš„ç”Ÿå‘½å‘¨æœŸ</h5><div class=table-wrapper><table><thead><tr><th>çŠ¶æ€</th><th>æè¿°</th></tr></thead><tbody><tr><td>ChannelUnregistered</td><td>Channelå·²ç»è¢«åˆ›å»ºï¼Œä½†è¿˜æœªæ³¨å†Œåˆ°EventLoop</td></tr><tr><td>ChannelRegistered</td><td>Channelå·²ç»è¢«æ³¨å†Œåˆ°äº†EventLoop</td></tr><tr><td>ChannelActive</td><td>Channelå¤„äºæ´»åŠ¨çŠ¶æ€ï¼ˆå·²ç»è¿æ¥åˆ°å®ƒçš„è¿œç¨‹èŠ‚ç‚¹ï¼‰å¯ä»¥æ¥æ”¶å’Œå‘é€æ•°æ®äº†</td></tr><tr><td>ChannelInactive</td><td>Channelæ²¡æœ‰è¿æ¥åˆ°è¿œç¨‹èŠ‚ç‚¹</td></tr></tbody></table></div><pre class=mermaid>
  graph TD
	a[ChannelUnregistered]--&gt;b[ChannelRegistered]
	b--&gt;c[ChannelActive]
	c--&gt;d[ChannelInactive]
</pre><h5 id=channelhandlerçš„ç”Ÿå‘½å‘¨æœŸ>ChannelHandlerçš„ç”Ÿå‘½å‘¨æœŸ</h5><div class=table-wrapper><table><thead><tr><th>ç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td>handlerAdded</td><td>å½“æŠŠChannelHandleræ·»åŠ åˆ°ChannelPipelineä¸­æ—¶è¢«è°ƒç”¨</td></tr><tr><td>handlerRemoved</td><td>å½“ä»ChannelPipelineä¸­ç§»é™¤ChannelHandleræ—¶è¢«è°ƒç”¨</td></tr><tr><td>exceptionCaught</td><td>å½“å¤„ç†è¿‡ç¨‹ä¸­åœ¨ChannelPipelineä¸­æœ‰é”™è¯¯äº§ç”Ÿæ—¶è¢«è°ƒç”¨</td></tr></tbody></table></div><p>ChannelHandlerä¸‹æœ‰ä¸¤ä¸ªé‡è¦çš„å­æ¥å£</p><ul><li>ChannelInboundHandler æ¥å£</li></ul><blockquote><p>å¤„ç†å…¥ç«™æ•°æ®ä»¥åŠå„ç§çŠ¶æ€å˜åŒ–</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//åˆ©ç”¨ChannelInboundHandlerAdapteræ˜¾å¼çš„é‡Šæ”¾å†…å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nd>@ChannelHandler.Sharable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DiscardHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ChannelInboundHandlerAdapter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//    ç”¨æ¥æ˜¾å¼çš„é‡Šæ”¾ä¸æ± åŒ–çš„ByteBufå®ä¾‹ç›¸å…³çš„å†…å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelRead</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        ä¸¢å¤±å·²æ¥æ”¶çš„æ¶ˆæ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ReferenceCountUtil</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//åˆ©ç”¨SimpleChannelInboundHandleræ˜¾å¼çš„é‡Šæ”¾å†…å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SimpleDiscardHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>SimpleChannelInboundHandler</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelRead0</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        è‡ªåŠ¨é‡Šæ”¾å†…å­˜ï¼Œä¸éœ€è¦æ‰‹åŠ¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>ChannelOutboundHandler æ¥å£</li></ul><blockquote><p>å¤„ç†å‡ºç«™æ“ä½œçš„æ¥å£ï¼Œå¯ä»¥æŒ‰éœ€æ¨è¿Ÿæ“ä½œæˆ–è€…äº‹ä»¶</p></blockquote><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/17231143465381723114345744.png><pre class=mermaid>
  graph TD
	a[ChannelInboundHandlerAdapter]--&gt;c[ChannelInboundHandler]
	a--&gt;d[ChannelHandlerAdapter]
	b--&gt;d
	b[ChannelOutboundHandlerAdapter]--&gt;b1[ChannelOutboundHandler]
	d--&gt;z[ChannelHandler]
	b1--&gt;z
	c--&gt;z
	
</pre><h4 id=channelpipelineæ¥å£>ChannelPipelineæ¥å£</h4><blockquote><p>ChannelPipelineæ˜¯ä¸€ä¸ªæ‹¦æˆªæµç»Channelçš„å…¥ç«™å’Œå‡ºç«™äº‹ä»¶çš„ChannelHandlerå®ä¾‹é“¾ã€‚</p></blockquote><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/17231156625241723115661886.png><p>ChannelPipelineçš„å¤´éƒ¨å’Œå°¾éƒ¨å–å†³äºè¯¥äº‹ä»¶æ˜¯å…¥ç«™è¿˜æ˜¯å‡ºç«™çš„ã€‚Nettyæ€»æ˜¯å°†ChannelPipelineçš„å…¥ç«™å£ä½œä¸ºå¤´éƒ¨ï¼Œå°†å‡ºç«™å£ä½œä¸ºå°¾éƒ¨ã€‚</p><ul><li>ä¿®æ”¹ChannelPipeline</li></ul><div class=table-wrapper><table><thead><tr><th>åç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td>addFirstaddBefore \n addAfteraddLast</td><td>å°†ä¸€ä¸ªChannelHandleræ·»åŠ åˆ°ChannelPipelineä¸­</td></tr><tr><td>remove</td><td>å°†ä¸€ä¸ªChannelHandlerä»ChannelPipelineä¸­ç§»é™¤</td></tr><tr><td>replace</td><td>å°†ChannelPipelineä¸­çš„ä¸€ä¸ªChannelHandleræ›¿æ¢ä¸ºå¦ä¸€ä¸ªChannelHandler</td></tr></tbody></table></div><blockquote><p>ä¸‹é¢ä¸¾ä¾‹ä¸­æ¯ä¸ªHandleråº”ä¸ºä¸åŒçš„Handlerï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿å…¨éƒ¨ä½¿ç”¨ç›¸åŒçš„äº†ã€‚</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ChangeChannelPipeline</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>change</span><span class=p>(</span><span class=n>ChannelPipeline</span><span class=w> </span><span class=n>pipeline</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>C1FirstHandler</span><span class=w> </span><span class=n>c1FirstHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>C1FirstHandler</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        å°¾æ’ç¬¬ä¸€ä¸ªHandleråä¸ºhandler1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;handler1&#34;</span><span class=p>,</span><span class=n>c1FirstHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        å¤´æ’ä¸€ä¸ªHandleråä¸ºhandler2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addFirst</span><span class=p>(</span><span class=s>&#34;handler2&#34;</span><span class=p>,</span><span class=n>c1FirstHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        å°¾æ’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;handler3&#34;</span><span class=p>,</span><span class=n>c1FirstHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æŒ‰åå­—åˆ é™¤Handler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pipeline</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=s>&#34;handler3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æŒ‰ç…§Handlerç±»å‹æ¥åˆ é™¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pipeline</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>c1FirstHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æŠŠåä¸ºhandler2çš„æ›¿æ¢</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pipeline</span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=s>&#34;handler2&#34;</span><span class=p>,</span><span class=s>&#34;handler4&#34;</span><span class=p>,</span><span class=n>c1FirstHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=æ€»ç»“-1>æ€»ç»“</h5><ul><li>ChannelPipelineä¿å­˜äº†ä¸Channelç›¸å…³è”çš„ChannelHandler</li><li>ChannelPipelineå¯ä»¥æ ¹æ®éœ€è¦ï¼Œé€šè¿‡æ·»åŠ æˆ–è€…åˆ é™¤ChannelHandleræ¥åŠ¨æ€åœ°ä¿®æ”¹</li><li>ChannelPipelineæœ‰ä¸°å¯Œçš„APIå¯ä»¥å“åº”å…¥ç«™å’Œå‡ºç«™äº‹ä»¶ã€‚</li></ul><h4 id=channelhandlercontextæ¥å£>ChannelHandlerContextæ¥å£</h4><blockquote><p>ç®¡ç†å®ƒæ‰€å…³è”çš„ChannelHandlerå’Œåœ¨åŒä¸€ä¸ªChannelPipelineä¸­çš„å…¶ä»–ChannelHandlerä¹‹é—´çš„äº¤äº’ã€‚</p></blockquote><ul><li>ChannelHandlerContextå’ŒChannelHandlerä¹‹é—´çš„å…³è”æ˜¯æ°¸è¿œä¸ä¼šæ”¹å˜çš„ï¼Œæ‰€ä»¥ç¼“å­˜å¯¹å®ƒçš„å¼•ç”¨æ˜¯å®‰å…¨çš„ã€‚</li><li>ChannelHandlerContextçš„æ–¹æ³•å°†äº§ç”Ÿæ›´çŸ­çš„äº‹ä»¶æµï¼Œåº”è¯¥å°½å¯èƒ½åœ°åˆ©ç”¨è¿™ä¸ªç‰¹æ€§æ¥æé«˜æ€§èƒ½ã€‚</li></ul><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/17231181995261723118199395.png><ul><li>é€šè¿‡ChannelHandlerContextè®¿é—®Handlerå’ŒPipeline</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DemoChannelHandlerContext</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//    é€šè¿‡ChannelHandlerContextè®¿é—®Channel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>getChannel</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        è·å–ä¸ChannelHandlerContextå…³è”çš„Channel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>channel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        å‘Channelä¸­å†™å…¥æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channel</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>Unpooled</span><span class=p>.</span><span class=na>copiedBuffer</span><span class=p>(</span><span class=s>&#34;Netty in Action&#34;</span><span class=p>,</span><span class=w> </span><span class=n>CharsetUtil</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//    é€šè¿‡ChannelHandlerContextè®¿é—®Pipeline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>getChannelPipeline</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        è·å–Pipeline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ChannelPipeline</span><span class=w> </span><span class=n>pipeline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=na>pipeline</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        é€šè¿‡Pipelineå†™å…¥ç¼“å†²åŒº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pipeline</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>Unpooled</span><span class=p>.</span><span class=na>copiedBuffer</span><span class=p>(</span><span class=s>&#34;Netty in Action&#34;</span><span class=p>,</span><span class=n>CharsetUtil</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=ä¸€ä¸ªäº‹ä»¶æ˜¯å¦‚ä½•ä¼ é€’çš„>ä¸€ä¸ªäº‹ä»¶æ˜¯å¦‚ä½•ä¼ é€’çš„</h5><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/17231187695351723118769210.png><h4 id=å¼‚å¸¸å¤„ç†>å¼‚å¸¸å¤„ç†</h4><blockquote><p>å…¥ç«™å¼‚å¸¸</p></blockquote><ul><li>ChannelHandler..exceptionCaught()é»˜è®¤å®ç°æ˜¯å°†å½“å‰å¼‚å¸¸è½¬å‘ç»™ChannelPipelineä¸­çš„ä¸‹ä¸€ä¸ªChannelHandler</li><li>å¦‚æœå¼‚å¸¸åˆ°è¾¾äº†ChannelPipelineçš„å°¾ç«¯ï¼Œå®ƒå°†ä¼šè¢«è®°å½•ä¸ºæœªè¢«å¤„ç†</li><li>è‹¥æƒ³è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ï¼Œéœ€è¦é‡å†™exceptionCaught()æ–¹æ³•ã€‚ç„¶åå†³å®šæ˜¯å¦å°†è¯¥å¼‚å¸¸ä¼ æ’­å‡ºå»</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//è‡ªå®šä¹‰å¤„ç†å…¥ç«™å¼‚å¸¸</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>P6InboundExceptionHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ChannelInboundHandlerAdapter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//    é‡å†™exceptionCaughtæ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>exceptionCaught</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=n>cause</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cause</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctx</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>å‡ºç«™å¼‚å¸¸</p></blockquote><ul><li>æ¯ä¸ªå‡ºç«™æ“ä½œéƒ½å°†è¿”å›ä¸€ä¸ªChannelFutureã€‚æ³¨å†Œåˆ°ChannelFutureçš„ChannelFutureListenerå°†åœ¨æ“ä½œå®Œæˆæ—¶è¢«é€šçŸ¥è¯¥æ“ä½œæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€‚</li><li>å‡ ä¹æ‰€æœ‰çš„ChannelOutboundHandlerä¸Šçš„æ–¹æ³•éƒ½ä¼šè¢«ä¼ å…¥ä¸€ä¸ªChannelPromiseå®ä¾‹ã€‚ä½œä¸ºChannelFutureçš„å­ç±»ï¼ŒChannelPromiseä¹Ÿå¯ä»¥è¢«åˆ†é…ç”¨äºå¼‚æ­¥é€šçŸ¥çš„ç›‘å¬å™¨ã€‚ï¼ˆä¹Ÿå¯ä»¥ç«‹å³é€šçŸ¥ï¼‰</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//è‡ªå®šä¹‰å‡ºç«™è§„åˆ™å¼‚å¸¸å¤„ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>P6OutboundExceptionHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ChannelOutboundHandlerAdapter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//    å°†ç»“æœçš„ç›‘å¬å™¨äº¤ç»™operationComplete</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>write</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=n>ChannelPromise</span><span class=w> </span><span class=n>promise</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>promise</span><span class=p>.</span><span class=na>addListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelFutureListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>operationComplete</span><span class=p>(</span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>future</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>future</span><span class=p>.</span><span class=na>isSuccess</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>future</span><span class=p>.</span><span class=na>cause</span><span class=p>().</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>future</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>future</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>closeFuture</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//    é€šè¿‡å°†ç›‘å¬å™¨äº¤ç»™Futureï¼Œä¸¤ç§æ–¹æ³•æ•ˆæœç›¸åŒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>byChannelFuture</span><span class=p>(</span><span class=n>Channel</span><span class=w> </span><span class=n>channel</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>future</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channel</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>future</span><span class=p>.</span><span class=na>addListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelFutureListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>operationComplete</span><span class=p>(</span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>future</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>future</span><span class=p>.</span><span class=na>isSuccess</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>future</span><span class=p>.</span><span class=na>cause</span><span class=p>().</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>future</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>future</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>closeFuture</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=ç¬¬ä¸ƒç« eventloopå’Œçº¿ç¨‹æ¨¡å‹>ç¬¬ä¸ƒç« ã€EventLoopå’Œçº¿ç¨‹æ¨¡å‹</h3><ul><li>java5çš„çº¿ç¨‹æ± åŒ–æŠ€æœ¯</li></ul><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/17231877659461723187765894.png><ul><li>å­˜åœ¨çš„é—®é¢˜</li></ul><p>è™½ç„¶å¯ä»¥é‡ç”¨çº¿ç¨‹ï¼Œä½†æ˜¯å¹¶ä¸èƒ½æ¶ˆé™¤ç”±ä¸Šä¸‹æ–‡åˆ‡æ¢å¸¦æ¥çš„å¼€é”€ã€‚æ€§èƒ½å½±å“å°†éšç€çº¿ç¨‹æ•°é‡çš„å¢åŠ å˜å¾—æ˜æ˜¾ï¼Œä¸”åœ¨é«˜è´Ÿè½½ä¸‹æ„ˆæ¼”æ„ˆçƒˆã€‚</p><h4 id=eventloopæ¥å£>EventLoopæ¥å£</h4><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/17231933815271723193380788.png><pre class=mermaid>
  graph TD
	a[io.netty.channel]
	a1[ThreadPerChannelEventLoop]--&gt;a2[SingleThreadEventLoop]
	a2--&gt;a3[EventLoop]
	a3--&gt;a4[EventLoopGroup]
	b[io.netty.util.concurrent]
	b1[SingleThreadEventExecutor]--&gt;b2[AbstractEventExecutor]
	b2--&gt;b3[EventExecutor]
	b3--&gt;b4[EventExecutorGroup]
	a2--&gt;b1
	a3--&gt;b3
	a4--&gt;b4
	c[java.util.concurrent]
	b2--&gt;c1[AbstractExecutorService]
	b4--&gt;c2[ScheduledExecutorService]
	c1--&gt;c3[ExecutorService]
	c2--&gt;c3
	c3--&gt;c4[Executor]
</pre><p>ä¸€ä¸ªEventLoopå°†ç”±ä¸€ä¸ªæ°¸è¿œä¸ä¼šæ”¹å˜çš„Threadé©±åŠ¨ï¼ŒåŒæ—¶ä»»åŠ¡ï¼ˆRunnableæˆ–è€…Callableï¼‰å¯ä»¥ç›´æ¥æäº¤ç»™EventLoopå®ç°ï¼Œä»¥ç«‹å³æ‰§è¡Œæˆ–è€…è°ƒåº¦æ‰§è¡Œã€‚</p><ul><li>Netty4ä¸­çš„IOäº‹ä»¶å¤„ç†</li></ul><p>I/O æ“ä½œè§¦å‘çš„äº‹ä»¶å°†æµç»å®‰è£…äº†ä¸€ä¸ªæˆ–è€…å¤šä¸ª ChannelHandler çš„ ChannelPipelineã€‚ä¼ æ’­è¿™äº›äº‹ä»¶çš„æ–¹æ³•è°ƒç”¨å¯ä»¥éšåè¢«Channel- Handler æ‰€æ‹¦æˆªï¼Œå¹¶ä¸”å¯ä»¥æŒ‰éœ€åœ°å¤„ç†äº‹ä»¶ã€‚</p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/17231187695351723118769210.png><ul><li>Netty3ä¸­çš„IOæ“ä½œ</li></ul><p>å…¥ç«™äº‹ä»¶ä¼šåœ¨IOçº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ‰€æœ‰çš„å‡ºç«™äº‹ä»¶ç”±è°ƒç”¨çº¿ç¨‹å¤„ç†ã€‚ï¼ˆéœ€è¦é¢å¤–çš„çº¿ç¨‹ï¼Œå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢å¸¦æ¥æŸè€—ï¼‰ã€‚</p><h4 id=ä»»åŠ¡è°ƒåº¦>ä»»åŠ¡è°ƒåº¦</h4><ul><li>JDKçš„ä»»åŠ¡è°ƒåº¦</li></ul><p>jdkæä¾›äº†JUCåŒ…ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </p><p>å­˜åœ¨çš„å¼Šç«¯ï¼šéœ€è¦å¤šä¸ªçº¿ç¨‹ï¼Œå­˜åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢é—®é¢˜</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//    jdkæ˜¯å¦‚ä½•åšä»»åŠ¡è°ƒåº¦çš„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>jdkC</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        åˆ›å»ºä¸€ä¸ªä»»åŠ¡çº¿ç¨‹æ± </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ScheduledExecutorService</span><span class=w> </span><span class=n>executor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newScheduledThreadPool</span><span class=p>(</span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        æ¯60ç§’æ‰§è¡Œä¸€æ¬¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>executor</span><span class=p>.</span><span class=na>schedule</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;60 seconds later&#34;</span><span class=p>),</span><span class=n>60</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        å…³é—­çº¿ç¨‹æ± </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>executor</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>EventLoopä»»åŠ¡è°ƒåº¦</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//    åˆ©ç”¨EventLoopåœæ­¢ä¸€ä¸ªä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>EventLoopC</span><span class=p>(</span><span class=n>Channel</span><span class=w> </span><span class=n>ch</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        é€šè¿‡EventLoopåˆ›å»ºä¸€ä¸ªä»»åŠ¡è°ƒåº¦ï¼Œ60såå¼€å§‹ï¼Œæ¯60sæ‰§è¡Œä¸€æ¬¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ScheduledFuture</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>future</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ch</span><span class=p>.</span><span class=na>eventLoop</span><span class=p>().</span><span class=na>scheduleAtFixedRate</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;60s seconds later&#34;</span><span class=p>),</span><span class=w> </span><span class=n>60</span><span class=p>,</span><span class=n>60</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        åˆ›å»ºä¸€ä¸ªåœæ­¢ä»»åŠ¡çš„è¡¨ç¤º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>mayInterruptIfRunning</span><span class=o>=</span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//        å–æ¶ˆä»»åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>future</span><span class=p>.</span><span class=na>cancel</span><span class=p>(</span><span class=n>mayInterruptIfRunning</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>EventLoopçš„ä¼˜åŠ¿</li></ul><p>Nettyçš„EventLoopæ‰©å±•äº†ScheduledExecutorServiceï¼Œå®ƒå®ç°äº†JDKå¯ç”¨çš„æ‰€æœ‰æ–¹æ³•ã€‚</p><h4 id=å®ç°ç»†èŠ‚>å®ç°ç»†èŠ‚</h4><ul><li>çº¿ç¨‹ç®¡ç†</li></ul><p>Nettyçº¿ç¨‹æ¨¡å‹çš„å“è¶Šå–å†³äºå¯¹äºå½“å‰Threadçš„ç¡®å®šã€‚å¯ä»¥ç¡®å®šå®ƒæ˜¯åˆ†é…ç»™å½“å‰Channelä»¥åŠå®ƒçš„EventLoopçš„å“ªä¸ªçº¿ç¨‹ã€‚</p><p>å¦‚æœï¼ˆå½“å‰ï¼‰è°ƒç”¨çº¿ç¨‹æ­£æ˜¯æ”¯æ’‘EventLoopçš„çº¿ç¨‹ï¼Œé‚£ä¹ˆæ‰€æäº¤çš„ä»£ç å—å°†ä¼šè¢«ï¼ˆç›´æ¥ï¼‰æ‰§è¡Œã€‚å¦åˆ™EventLoopå°†è°ƒåº¦è¯¥ä»»åŠ¡ä»¥ä¾¿ç¨åæ‰§è¡Œï¼Œå¹¶å°†å®ƒæ”¾å…¥åˆ°å†…éƒ¨é˜Ÿåˆ—ä¸­ã€‚å½“EventLoopä¸‹æ¬¡å¤„ç†å®ƒçš„äº‹ä»¶æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„é‚£äº›ä»»åŠ¡ã€‚</p><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-05/66f61fa9ee54e_1747188214067.png loading=lazy alt=66f61fa9ee54e.png></p><blockquote><p>æ°¸è¿œä¸è¦å°†ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡æ”¾å…¥åˆ°æ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼Œå› ä¸ºå®ƒå°†é˜»å¡éœ€è¦åœ¨åŒä¸€çº¿ç¨‹ä¸Šæ‰§è¡Œçš„ä»»ä½•å…¶ä»–ä»»åŠ¡ã€‚å¦‚æœéœ€è¦æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼Œå»ºè®®æ–°å»ºä¸€ä¸ªä¸“é—¨çš„EventExecutor</p></blockquote><ul><li>EventLoop/çº¿ç¨‹çš„åˆ†é…</li></ul><p>EventLoopåŒ…å«åœ¨EventLoopGroupä¸­ï¼Œæ ¹æ®ä¸åŒçš„ä¼ è¾“å®ç°ï¼ŒEventLoopçš„åˆ›å»ºå’Œåˆ†é…æ–¹å¼ä¸åŒã€‚</p><ol><li>å¼‚æ­¥ä¼ è¾“</li></ol><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-05/66f621bd511f9_1747188389323.png loading=lazy alt=66f621bd511f9.png></p><p>EventLoopGroupè´Ÿè´£ä¸ºæ¯ä¸ªæ–°åˆ›å»ºçš„Channelåˆ†é…ä¸€ä¸ªEventLoopã€‚ä½¿ç”¨è½®è¯¢çš„æ–¹å¼è¿›è¡Œåˆ†é…ä»¥è·å–ä¸€ä¸ªå‡è¡¡çš„åˆ†å¸ƒï¼Œç›¸åŒçš„EventLoopå¯èƒ½ä¼šè¢«åˆ†é…ç»™å¤šä¸ªChannelã€‚</p><p>ä¸€æ—¦ä¸€ä¸ªChannelè¢«åˆ†é…ç»™äº†ä¸€ä¸ªEventLoopï¼Œå®ƒå°†åœ¨å®ƒçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­éƒ½ä½¿ç”¨è¿™ä¸ªEventLoopï¼ˆä»¥åŠç›¸å…³çš„Threadï¼‰ã€‚</p><blockquote><p>å› ä¸ºä¸€ä¸ªEventLoopæ”¯æ’‘äº†å¤šä¸ªChannelï¼Œæ‰€ä»¥å¯¹äºæ‰€æœ‰ç›¸å…³çš„Channelæ¥è¯´ï¼ŒThreadLocaléƒ½æ˜¯ç›¸åŒçš„ã€‚</p></blockquote><ol start=2><li>é˜»å¡ä¼ è¾“</li></ol><p><img src=https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-05/6704cdd404a5a_1747188395147.png loading=lazy alt=6704cdd404a5a.png></p><p>æ¯ä¸ªChannelçš„äº‹ä»¶éƒ½ç”±ä¸€ä¸ªThreadå¤„ç†</p><h4 id=æ€»ç»“-2>æ€»ç»“</h4><ul><li>nettyçº¿ç¨‹æ¨¡å‹çš„ä¼¸ç¼©æ€§ï¼š</li></ul><blockquote><p>å¯ä¼¸ç¼©æ€§å°±æ˜¯å¯ä»¥é€šè¿‡å¢åŠ è®¡ç®—èµ„æº(CPUï¼Œå†…å­˜)æ¥æä¾›ç¨‹åºçš„ååé‡æˆ–è€…æ€§èƒ½ã€‚</p></blockquote><p>ç”±äºnettyçš„EventLoopéƒ½ç»‘å®šç€ä¸€ä¸ªç¡®å®šçš„Threadï¼Œæ‰€ä»¥ï¼Œå¯ä»¥æ ¹æ®EventLoopçš„æ•°é‡æ¥è°ƒæ•´cpuæ ¸å¿ƒæ•°é‡ã€‚</p></section><footer class=article-footer><section class=article-tags><a href=/tags/netty/>Netty</a>
<a href=/tags/java/>Java</a>
<a href=/tags/%E8%AF%BB%E5%90%8E%E6%84%9F/>è¯»åæ„Ÿ</a>
<a href=/tags/rpc/>Rpc</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/nettyio%E6%A8%A1%E5%9E%8B/><div class=article-image><img src=/p/nettyio%E6%A8%A1%E5%9E%8B/20205-05-29.332e46be036aa4d6e58c13a2bf201374_hu_f9910541d5a26cd3.png width=250 height=150 loading=lazy alt="Featured image of post NettyIOæ¨¡å‹" data-hash="md5-My5GvgNqpNbljBOivyATdA=="></div><div class=article-details><h2 class=article-title>NettyIOæ¨¡å‹</h2></div></a></article><article class=has-image><a href=/p/%E8%AF%BB%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA2019%E7%89%88%E6%9C%89%E6%84%9F/><div class=article-image><img src=/p/%E8%AF%BB%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BA2019%E7%89%88%E6%9C%89%E6%84%9F/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3java%E8%99%9A%E6%8B%9F%E6%9C%BAv3.7a938c68cb8d638aedb4ae81627b8f0b_hu_76b6da958296544a.png width=250 height=150 loading=lazy alt="Featured image of post è¯»ã€Šæ·±å…¥ç†è§£javaè™šæ‹Ÿæœº2019ç‰ˆã€‹æœ‰æ„Ÿ" data-hash="md5-epOMaMuNY4rttK6BYnuPCw=="></div><div class=article-details><h2 class=article-title>è¯»ã€Šæ·±å…¥ç†è§£javaè™šæ‹Ÿæœº2019ç‰ˆã€‹æœ‰æ„Ÿ</h2></div></a></article><article class=has-image><a href=/p/spring%E4%B8%AD%E6%96%87%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3v6%E6%9C%89%E6%84%9F/><div class=article-image><img src=/p/spring%E4%B8%AD%E6%96%87%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3v6%E6%9C%89%E6%84%9F/springFrameworkV6.45c4949ea90685e7afd2cf20ba4c38ce_hu_6fdd7fdad2841555.png width=250 height=150 loading=lazy alt="Featured image of post springä¸­æ–‡è¯´æ˜æ–‡æ¡£v6æœ‰æ„Ÿ" data-hash="md5-RcSUnqkGheev0s8gukw4zg=="></div><div class=article-details><h2 class=article-title>springä¸­æ–‡è¯´æ˜æ–‡æ¡£v6æœ‰æ„Ÿ</h2></div></a></article><article class=has-image><a href=/p/%E8%AF%BBkafka%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E6%9C%89%E6%84%9F/><div class=article-image><img src=/p/%E8%AF%BBkafka%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E6%9C%89%E6%84%9F/1.b6c59dbf772a12590b4b5e33955593f2_hu_9424f85e3bd38ebb.png width=250 height=150 loading=lazy alt="Featured image of post è¯»ã€ŠKafkaæƒå¨æŒ‡å—ã€‹æœ‰æ„Ÿ" data-hash="md5-tsWdv3cqElkLS14zlVWT8g=="></div><div class=article-details><h2 class=article-title>è¯»ã€ŠKafkaæƒå¨æŒ‡å—ã€‹æœ‰æ„Ÿ</h2></div></a></article><article class=has-image><a href=/p/java-ontwerp-patroon/><div class=article-image><img src=/p/java-ontwerp-patroon/1.81a9dce623b1d6fe4485ac670cb7da98_hu_d1992426cb16f3b7.png width=250 height=150 loading=lazy alt="Featured image of post è¯»ã€Šé‡å­¦javaè®¾è®¡æ¨¡å¼ã€‹æœ‰æ„Ÿ" data-key=java-Ontwerp-patroon data-hash="md5-ganc5iOx1v5EhaxnDLfamA=="></div><div class=article-details><h2 class=article-title>è¯»ã€Šé‡å­¦javaè®¾è®¡æ¨¡å¼ã€‹æœ‰æ„Ÿ</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//thecoolboyhan.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2026 éŸ©æ°¸å‘çš„åšå®¢</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.33.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>