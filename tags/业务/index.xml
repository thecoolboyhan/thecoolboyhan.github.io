<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>业务 on 韩永发的博客</title><link>https://thecoolboyhan.github.io/tags/%E4%B8%9A%E5%8A%A1/</link><description>Recent content in 业务 on 韩永发的博客</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Wed, 04 Jun 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://thecoolboyhan.github.io/tags/%E4%B8%9A%E5%8A%A1/index.xml" rel="self" type="application/rss+xml"/><item><title>个贷核心系统业务与核算规则概览</title><link>https://thecoolboyhan.github.io/p/%E4%B8%AA%E8%B4%B7%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E4%B8%8E%E6%A0%B8%E7%AE%97%E8%A7%84%E5%88%99%E6%A6%82%E8%A7%88/</link><pubDate>Wed, 04 Jun 2025 00:00:00 +0000</pubDate><guid>https://thecoolboyhan.github.io/p/%E4%B8%AA%E8%B4%B7%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E4%B8%8E%E6%A0%B8%E7%AE%97%E8%A7%84%E5%88%99%E6%A6%82%E8%A7%88/</guid><description>&lt;img src="https://thecoolboyhan.github.io/p/%E4%B8%AA%E8%B4%B7%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E4%B8%8E%E6%A0%B8%E7%AE%97%E8%A7%84%E5%88%99%E6%A6%82%E8%A7%88/1.png" alt="Featured image of post 个贷核心系统业务与核算规则概览" /&gt;&lt;p&gt;[TOC]&lt;/p&gt;
&lt;h2 id="业务概览"&gt;业务概览
&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;授信&lt;/li&gt;
&lt;li&gt;放款&lt;/li&gt;
&lt;li&gt;还款&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="主要业务"&gt;主要业务
&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;授信、绑卡、放款、还款、债务重组、不规则还款、延展期、诉讼回款、柜面还款、LPR利率浮动、核销、代偿、机构撤并、管护移交、批量扣款、代偿后还款、日终账务、短信通知、记账机构管理、额度管理、客户信息管理、借据管理、贷款凭证管理、合同管理、核心产品管理、LPR利率维护、银行核心模式、助贷模式、税价分离&amp;hellip;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id="联机业务"&gt;联机业务
&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;授信维护、绑卡维护、客户基础信息维护、合同维护、管护机构及记账机构维护、放款、还款、借据信息维护等&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id="授信"&gt;授信
&lt;/h3&gt;&lt;p&gt;授信是业务开始，只有授信后才能开始贷款。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;额度：客户在一定时间内能够申请贷款的最高金额&lt;/li&gt;
&lt;li&gt;业务：变更、冻结、解冻、额度占用、恢复、失效、注销&lt;/li&gt;
&lt;li&gt;额度类型：循环额度、一次性额度、一次性多次使用额度&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="账户"&gt;账户
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;账户：他行卡与本行卡的鉴权、绑定、解绑，用于客户收款和还款&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;鉴权：为了确保用户的真实性和支付的安全性，一般是四要素鉴权&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="放款"&gt;放款
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;预防款：完成产品，额度等校验，生成借据号等关键信息。&lt;/li&gt;
&lt;li&gt;放款确认：再次校验产品、额度等信息，完成额度占用，生成借据、期供等基本信息&lt;/li&gt;
&lt;li&gt;支付放款：调用支付，完成放款（标准放款、受托支付）&lt;/li&gt;
&lt;li&gt;核算记账：放款成功后，异步通知会计核算记账&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="还款"&gt;还款
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;正常还款：借据到期后的还款&lt;/li&gt;
&lt;li&gt;提前还款：提前N天还当期&lt;/li&gt;
&lt;li&gt;提前还N期：缩期，每期本金不变，总期数减少&lt;/li&gt;
&lt;li&gt;提前还部分：摊薄，每期本金减少，总期数不变&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="其他概念"&gt;其他概念
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;期供：每个借据都有对应的期供，期供记录了每一期还款的本金、利息、开始日、到期日期等。&lt;/li&gt;
&lt;li&gt;还款方式：等额本金、等额本息、先息后本、一次性还本付息，周期性还本付息，气球贷，不规则还款。&lt;/li&gt;
&lt;li&gt;利率：正常利率，罚息利率，复息利率&lt;/li&gt;
&lt;li&gt;优惠券：N天免息券、利率折扣券、N期免息券、固定利率券、利息抵扣券&lt;/li&gt;
&lt;li&gt;还款日：固定还款日、范围随机还款日、最大还款日、还款日间隔&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="批量任务"&gt;批量任务
&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;各种流水状态同步、批量、代偿、银行核心模式行内数据拉取等&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id="批量扣款"&gt;批量扣款
&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;客户借据到期后，每日执行的扣款任务&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="流程"&gt;流程
&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;任务生成：按商户、数据库节点、时间点、支付通道等生成批扣&lt;/li&gt;
&lt;li&gt;数据载入：按生成的不同批扣任务，载入对应的需要批扣的数据&lt;/li&gt;
&lt;li&gt;执行扣款：按人加产品维度，结合还款账户生成扣款记录，发起扣款&lt;/li&gt;
&lt;li&gt;短信发送：客户所有借据扣款完成后，按人维度发送扣款结果短信&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id="业务规则"&gt;业务规则
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;扣款时间&lt;/p&gt;
&lt;p&gt;批扣时间点支持配置，配置三次时间 8、16、20点批扣&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;并发控制&lt;/p&gt;
&lt;p&gt;涉及部分特殊支付渠道的扣款，批扣可以设置不同的并发数量控制&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;扣款账户&lt;/p&gt;
&lt;p&gt;扣款账户的顺序是按照产品维度配置的，主流扣款顺序：自有虚账户&amp;ndash;&amp;gt;行内虚账户&amp;ndash;&amp;gt; 本行卡&amp;ndash;&amp;gt; 他行卡&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;余额查询&lt;/p&gt;
&lt;p&gt;扣款前会查询余额，如果余额不足，按可用余额扣款&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;批扣短信&lt;/p&gt;
&lt;p&gt;扣款完成后，准实时发送扣款短信&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="借据代偿"&gt;借据代偿
&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;借据人无法按时偿还贷款时，由担保人或保险公司等第三方代为偿还的业务&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="业务流程"&gt;业务流程
&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;代偿试算：命中代偿规则的借据，进行代偿试算，生成代偿明细&lt;/li&gt;
&lt;li&gt;申请文件：根据代偿明细，生成批量代偿申请文件，上传OSS&lt;/li&gt;
&lt;li&gt;文件通知：申请文件上传完成后，通过支付通知行内代偿申请已提交&lt;/li&gt;
&lt;li&gt;审批结果：批量代偿审批文件下载、解析、更新审批状态：通过或拒绝，审批通过的借据，会发起代偿还款&lt;/li&gt;
&lt;li&gt;代偿结果：代偿完成后，生成代偿结果文件，上传&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id="业务规则-1"&gt;业务规则
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;代偿天数&lt;/p&gt;
&lt;p&gt;只借据的逾期天数，分为单期代偿天数、整笔代偿天数&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;代偿方式&lt;/p&gt;
&lt;p&gt;单期代偿：单期天数控制，单期做代偿&lt;/p&gt;
&lt;p&gt;整笔代偿：由整笔借据逾期天数控制，做整笔借据代偿&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;账户管理&lt;/p&gt;
&lt;p&gt;按渠道配置代偿账户，或在借据放款时指定代偿账户&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;文件同步&lt;/p&gt;
&lt;p&gt;还款预估文件、代偿申请文件、代偿审批文件、代偿结果文件的同步&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="借据核销"&gt;借据核销
&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;核销后贷款从资产负债表中剔除，相关坏账不计入当期损益&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="业务流程-1"&gt;业务流程
&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;商户校验：商户是否支持核销，减值核销或非减值核销，核销时是否检查计提&lt;/li&gt;
&lt;li&gt;产品校验：产品是否支持核销，核销贷款余额，核销逾期天数是否满足要求&lt;/li&gt;
&lt;li&gt;借据校验：借据状态是否正常，是否处理中，是否做过资产剥离，是否已经核销，贷款余额，逾期天数是否满足条件，最大逾期天数内是否有成功还款记录&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="日终任务"&gt;日终任务
&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;计提、结息、转列、拨备、计税&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id="业务流程-2"&gt;业务流程
&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;日切前：根据日切时间点，拦截前后10分钟的所有交易&lt;/li&gt;
&lt;li&gt;日切中-交易拦截：拦截掉除放款外，其他影响账务的交易&lt;/li&gt;
&lt;li&gt;日切中-核心：执行计提、结息、转列、拨备，生成对应文件通知会计核系统处理&lt;/li&gt;
&lt;li&gt;日切中-会计核算：处理核心系统计提、结息、转列、拨备等文件&lt;/li&gt;
&lt;li&gt;日切中-ODS：待核心系统及会计核算系统数据处理完成后，通知ODS抽数&lt;/li&gt;
&lt;li&gt;日间：ODS完成供数后，通知核心切日间，继续处理被阻塞的还款交易，当日零金额还款的业务。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="业务规则-2"&gt;业务规则
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;计提&lt;/p&gt;
&lt;p&gt;对当天应收客户的贷款利息进行计算，体现银行的贷款利息收入&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;结息&lt;/p&gt;
&lt;p&gt;按约定的时间从客户账扣收贷款利息，体现银行和借据人之间的利息结算&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;转列&lt;/p&gt;
&lt;p&gt;处理贷款借据的四级分类：正常、逾期、呆滞、呆账&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;拨备&lt;/p&gt;
&lt;p&gt;贷款减值准备，拨备金额主要根据贷款的五级分类来确定&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="总结"&gt;总结
&lt;/h2&gt;&lt;p&gt;&lt;img src="https://thecoolboyhan.github.io/p/%E4%B8%AA%E8%B4%B7%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E4%B8%8E%E6%A0%B8%E7%AE%97%E8%A7%84%E5%88%99%E6%A6%82%E8%A7%88/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B.jpg"
width="1099"
height="458"
srcset="https://thecoolboyhan.github.io/p/%E4%B8%AA%E8%B4%B7%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E4%B8%8E%E6%A0%B8%E7%AE%97%E8%A7%84%E5%88%99%E6%A6%82%E8%A7%88/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B_hu_8fc76aba7fb02981.jpg 480w, https://thecoolboyhan.github.io/p/%E4%B8%AA%E8%B4%B7%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E4%B8%8E%E6%A0%B8%E7%AE%97%E8%A7%84%E5%88%99%E6%A6%82%E8%A7%88/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B_hu_af3aa2e41c0525b6.jpg 1024w"
loading="lazy"
alt="业务流程"
class="gallery-image"
data-flex-grow="239"
data-flex-basis="575px"
&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://thecoolboyhan.github.io/p/%E4%B8%AA%E8%B4%B7%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E4%B8%8E%E6%A0%B8%E7%AE%97%E8%A7%84%E5%88%99%E6%A6%82%E8%A7%88/%E5%80%9F%E6%8D%AE%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.jpg"
width="1259"
height="286"
srcset="https://thecoolboyhan.github.io/p/%E4%B8%AA%E8%B4%B7%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E4%B8%8E%E6%A0%B8%E7%AE%97%E8%A7%84%E5%88%99%E6%A6%82%E8%A7%88/%E5%80%9F%E6%8D%AE%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F_hu_1cfb8ec76e7cdada.jpg 480w, https://thecoolboyhan.github.io/p/%E4%B8%AA%E8%B4%B7%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E4%B8%9A%E5%8A%A1%E4%B8%8E%E6%A0%B8%E7%AE%97%E8%A7%84%E5%88%99%E6%A6%82%E8%A7%88/%E5%80%9F%E6%8D%AE%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F_hu_d9ccfbace15b9226.jpg 1024w"
loading="lazy"
alt="借据的生命周期"
class="gallery-image"
data-flex-grow="440"
data-flex-basis="1056px"
&gt;&lt;/p&gt;
&lt;h2 id="贷款"&gt;贷款
&lt;/h2&gt;&lt;p&gt;由于各个银行情况不同，有些并不使用本核心做放款、还款等操作。银行为核心的产品本系统只需路由到对应的银行请求行内接口，获取结果。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;具体的路由方式&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;目前有两种路由方式：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;通过产品号来路由（优先）：通过银行（租户）+产品的维度请求对应的接口&lt;/li&gt;
&lt;li&gt;通过银行路由：有些银行只有一个统一的请求接口，无需区分产品。&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;银行相关的配置信息，统一放入路由配置表，通过请求中的产品号获取对应的规则。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;接下来的所有流程为自有核心流程&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id="贷款试算"&gt;贷款试算
&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;放款提现请的准备重要规则，预生成还款计划、计划利息、借据信息等。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h5 id="前期准备"&gt;前期准备
&lt;/h5&gt;&lt;ul&gt;
&lt;li&gt;首次还款日&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;后续期供信息需要根据首次还款日，来向后累计。在交给计算器来生成期供之前，需要先准备好首次还款日。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;所有产品的首次还款日默认不许超过28（不许出现29、30、31等）&lt;/p&gt;
&lt;/blockquote&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;类型&lt;/th&gt;
&lt;th&gt;结果&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;固定还款日&lt;/td&gt;
&lt;td&gt;每月都使用固定还款日期来还款&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;固定还款日（下月）&lt;/td&gt;
&lt;td&gt;小于等于固定还款日：使用下月固定还款日&lt;br /&gt;大于固定还款日：使用下下月固定还款日&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;随机【1,10】&lt;/td&gt;
&lt;td&gt;1到10号随机一天&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;随机【11,20】&lt;/td&gt;
&lt;td&gt;11到20号随机一天&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;随机【21,28】&lt;/td&gt;
&lt;td&gt;21到28号随机一天&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;如果客户信息中，曾记录过用户的还款日，尽量使用相同的还款日。（方便合并批扣）&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;获取利率（授信协议）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;从授信协议分项中查出授信时风险模型提供的客户贷款利率。&lt;/p&gt;
&lt;h5 id="试算"&gt;试算
&lt;/h5&gt;&lt;blockquote&gt;
&lt;p&gt;通过首次还款日、利率信息。来预生成还款计划和借据信息&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;信贷核心执行过程均采用责任链模式，每一步时都会判断是否继续向后执行，无论中间哪一环出现问题直接让流程失败。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;试算物料初始化&lt;/p&gt;
&lt;p&gt;贷款开始日期、产品信息、优惠券信息&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;使用原始利率试算（折前利率）&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;根据还款方式来选择试算器&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;不同还款方式的试算器&lt;/p&gt;
&lt;/blockquote&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;还款方式&lt;/th&gt;
&lt;th&gt;试算器&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;先息后本&lt;/td&gt;
&lt;td&gt;等额本金计算器&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;等额本息&lt;/td&gt;
&lt;td&gt;等额本息计算器&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;等额本金&lt;/td&gt;
&lt;td&gt;等额本金计算器&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;自定义周期性还本还息&lt;/td&gt;
&lt;td&gt;等额本金计算器&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;气球贷等额本息&lt;/td&gt;
&lt;td&gt;气球贷等额本息计算器&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;气球贷等额本金&lt;/td&gt;
&lt;td&gt;气球贷等额本金计算器&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;气球贷自定义周期性还本还息&lt;/td&gt;
&lt;td&gt;气球贷等额本金计算器&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;各计算器计算方式后文详解&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;通过试算器试算出：&lt;/p&gt;
&lt;p&gt;本息总金额、利息、下次还款日、到期日、还款明细、还款期数&lt;/p&gt;
&lt;p&gt;通过试算器得出的为折前利率，但未使用优惠，需要对总金额和利息使用优惠券（优惠券为负值）&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;当期初始利息=剩余本金*年利率*计息天数（距离放款的天数）/年计息规则天数（360或365）&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;目前已知的情报：&lt;/p&gt;
&lt;p&gt;1、贷款开始日期、产品信息、优惠券信息&lt;/p&gt;
&lt;p&gt;2、折前：本息总金额、利息、下次还款日、到期日、还款明细、还款期数&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;折后利率计算&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;返回折后利率&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;优惠后金额需要通过折扣利率来计算，优惠有两种&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;利率折扣：&lt;strong&gt;折后利率=正常利率*折扣率&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;利息优惠券：&lt;strong&gt;折后利率=（（折前总利息-|优惠券固定优惠利息金额|）/折前总利息&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;目前已知的情报：&lt;/p&gt;
&lt;p&gt;1、贷款开始日期、产品信息、优惠券信息&lt;/p&gt;
&lt;p&gt;2、折前：本息总金额、利息、下次还款日、到期日、还款明细、还款期数&lt;/p&gt;
&lt;p&gt;3、折后利率&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;通过折后利率在进行一次试算&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;上一步中得出折后利率，利用折后利率在进行一次试算，就可得出优惠后的利息情况。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;目前已知的情报：&lt;/p&gt;
&lt;p&gt;1、贷款开始日期、产品信息、优惠券信息&lt;/p&gt;
&lt;p&gt;2、折前：本息总金额、利息、下次还款日、到期日、还款明细、还款期数&lt;/p&gt;
&lt;p&gt;3、折后利率&lt;/p&gt;
&lt;p&gt;4、折后：本息总金额、利息、下次还款日、到期日、还款明细、还款期数&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;试算出每期优惠的金额&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;通过优惠试算器试算出每期优惠的金额&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;优惠方式&lt;/th&gt;
&lt;th&gt;试算器&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;放款使用（折后利息计算还款计划+折扣不提（初始就是折后利息）+回收补提）&lt;/td&gt;
&lt;td&gt;放款优惠试算器&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;放款使用（折后利息计算还款计划+折扣不提（初始就是折后利息）+回收补提 等额本息使用优惠券）&lt;/td&gt;
&lt;td&gt;放款优惠试算器&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;还款使用（折前利息计算还款计划+折扣反提+回收补提）（默认试算器）&lt;/td&gt;
&lt;td&gt;还款优惠试算器&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;还款使用（折前利息计算还款计划+折扣反提+回收补提 等额本息）&lt;/td&gt;
&lt;td&gt;还款优惠试算器&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;ul&gt;
&lt;li&gt;费用计算&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;按出资比率或约定费用计算出所需费用&lt;/p&gt;
&lt;h5 id="放款试算总结"&gt;放款试算总结
&lt;/h5&gt;&lt;p&gt;通过以下信息试算出期供明细+借据&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;试算物料初始化：贷款开始日期、产品信息、优惠券信息&lt;/li&gt;
&lt;li&gt;使用原始利率试算（折前利率）：本息总金额（折前）、利息（折前）、下次还款日、到期日、还款明细、还款期数&lt;/li&gt;
&lt;li&gt;折后利率计算：折后利率&lt;/li&gt;
&lt;li&gt;用折后利率试算：本息总金额（折后）、利息（折后）、下次还款日、到期日、还款明细、还款期数&lt;/li&gt;
&lt;li&gt;抵扣金额：每期优惠金额&lt;/li&gt;
&lt;li&gt;费用计算：根据规则计算出费用&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;放款试算必须的条件：&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;产品信息、放款金额、从授信中获取的利率、期数、还款周期、放款日期、优惠方式。&lt;/p&gt;
&lt;h3 id="放款tcc"&gt;放款（TCC）
&lt;/h3&gt;&lt;h4 id="无事务前期准备"&gt;无事务前期准备
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;生成唯一流水&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;为了防止重复放款，先生成一条唯一交易流水，插入唯一交易流水表（放款、还款同表）。通过唯一约束的交易流水，防重放。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;查询产品信息&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;通过请求参数，查询本次贷款产品信息。&lt;/p&gt;
&lt;h4 id="信贷管理额度占用预开户事务1try"&gt;信贷管理：额度占用+预开户（事务1：try）
&lt;/h4&gt;&lt;p&gt;开启事务Transactional&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;获取客户额度与额度协议分项(事务1.1)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;校验还款方式、末期本金比例是否合规等&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;目前已有：额度信息（未被占用）、协议信息&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;计算还款日(事务1.1)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;根据入参计算还款日，校验卡信息&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;目前已有：&lt;/p&gt;
&lt;p&gt;1、额度信息（未被占用）、协议信息&lt;/p&gt;
&lt;p&gt;2、还款日&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;查询（客户+产品）名下所有的申请信息（成功+处理中的）(事务1.1)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在本次放款记录落库前，先查询一遍申请信息&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;真正的放款try(事务1.1)&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;利率抉择、额度占用、登记流水&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;校验客户信息(事务1.1)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;判断客户是否可以再借款等&lt;/p&gt;
&lt;ol start="2"&gt;
&lt;li&gt;抉择利率（开启一个新事务1.2）&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;Q如何在一个事务中同一个bean内的方法调用，开启一个新事务？&lt;/p&gt;
&lt;p&gt;A由于事务1.1与事务1.2处于同一个bean，且只有通过springAOP代理的对象才会事务生效。（&lt;strong&gt;同类内方法调用即使有@Transactional注解，AOP不会生效&lt;/strong&gt;）&lt;/p&gt;
&lt;p&gt;可以&lt;strong&gt;通过SpringContextHolder.getBean（*.class）获取bean来调用，使事务或AOP生效&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;根据配置使用客户额度协议中的利率或从风险驾驶舱中获取利率&lt;/p&gt;
&lt;p&gt;若风险驾驶舱中利率和额度协议中的利率不同，更新协议分项利率&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;提交事务1.2&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol start="3"&gt;
&lt;li&gt;插入唯一交易流水表（事务1.1）&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;防止重复交易（try）&lt;/p&gt;
&lt;ol start="4"&gt;
&lt;li&gt;占用额度（事务1.1）&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在占用额度之前，先当前读查询额度变更流水（select for update），防止额度重复占用&lt;/p&gt;
&lt;p&gt;select for update 该用户的额度数据（只要事务没有提交，相当于锁住了该客户的读信息）&lt;/p&gt;
&lt;p&gt;利用mysql 更新额度数据：剩余额度=原剩余额度-借据金额&lt;/p&gt;
&lt;p&gt;插入若干流水&lt;/p&gt;
&lt;p&gt;返回更新后的额度分项&lt;/p&gt;
&lt;ol start="5"&gt;
&lt;li&gt;贷款预生成（事务1.1）&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;目前已知信息&lt;/p&gt;
&lt;p&gt;产品信息、卡信息、额度协议信息（已占用）、利率、已登记流水（放款请求，额度占用流水）、还款日、客户信息&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;通过以上信息预生成一笔借据&lt;/p&gt;
&lt;p&gt;生成提前申请流水&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;事务1.1结束&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="信贷核心放款申请事务2try"&gt;信贷核心：放款申请（事务2：try）
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;使用独立事务登记各种流水（事务2.1）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;登记交易流水、贷款系统流水、支付用流水、扩展流水。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;使用同一事务完成各系统流水登记，保证请求都被记录&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;事务2.1结束&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;​ 放款前检查（事务2.2）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;是否营业校验、头寸校验、代偿校验&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;生成借据号（事务2.2）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;生成借据号、获取优惠起始期数&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;贷款试算（事务2.2）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;调用贷款试算，生成期供、借据等&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;开户（事务2.2）&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;事务2.2结束&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;调用支付系统开始放款&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;接收支付返回值，根据返回结果决定：处理中（挂起）、成功、失败。&lt;/p&gt;
&lt;h4 id="信贷管理放款失败事务1cancel"&gt;信贷管理：放款失败（事务1：cancel）
&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;开启事务1.1&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;分布式事务防止资源悬挂&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;try请求由于网络阻塞在cancel请求后才执行&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;解决方式：在cancel之前，先尝试插入一遍try的流水&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;恢复额度（1.1）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;将之前占用的额度取消&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;取消台账流水（1.1）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;将之前预生成的流水状态置为取消&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;事务1.1结束&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="信贷核心放款取消事务2cancel"&gt;信贷核心：放款取消（事务2：cancel）
&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;开启事务2.1&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;更新流水（事务2.1）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;将之前的账务流水、交易流水、主流水、支付流水置为失败&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;事务2.1结束&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="信贷管理放款确认事务1confirm"&gt;信贷管理：放款确认（事务1：confirm）
&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;事务1.1&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;放款申请、台账历史流水确认（事务1.1）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;更新授信协议分项中的放款金额（事务1.1）&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;事务1.1 结束&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="信贷核心放款确认事务2confirm"&gt;信贷核心：放款确认（事务2：confirm）
&lt;/h4&gt;&lt;p&gt;事务2.1&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;更新账户信息、借据状态等为成功（2.1）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;将新借据信息发送给ACT服务（信贷核算）记账（2.1）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;更新计税（若有）事务2.1&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;事务2.1结束&lt;/p&gt;
&lt;h2 id="还款-1"&gt;还款
&lt;/h2&gt;&lt;h3 id="应还款试算"&gt;应还款试算
&lt;/h3&gt;&lt;h4 id="前期准备-1"&gt;前期准备
&lt;/h4&gt;&lt;p&gt;查出借据所有期供、查询宽限期、恢复正常利率（之前利率有可能应折扣导致不准）、处理柜面还款部分&lt;/p&gt;
&lt;h4 id="循环每期期供得出利息真正的试算"&gt;循环每期期供得出利息（真正的试算）
&lt;/h4&gt;&lt;p&gt;每期借据大致分为几种情况&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;为满足正常的还款日要求&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;未到期的期供、交易日未到达正常还款日、不展示的期供信息&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;统一跳过处理&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;未介入待还时间线的期供&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;跳过&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;其他情况的期供会进入试算&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;已知的情报：&lt;/p&gt;
&lt;p&gt;期供信息（未试算）、宽限期&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="利息计算"&gt;利息计算
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;需要的数据&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;起息日sD，上次计提日（可能为空）pD、当前交易日tD&lt;/p&gt;
&lt;p&gt;初始利息（放款时试算得出）、已计提利息（每期的已计提利息）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;pD&amp;gt;=结束日期&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;本期不再计息 return 0；&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;pD为空&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;没有计提过，让pD等于sD&lt;/p&gt;
&lt;p&gt;计息天数：当前日期-起息日&lt;/p&gt;
&lt;p&gt;剩余本金：当期金额+当期后的总剩余本金&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;计息方式&lt;/th&gt;
&lt;th&gt;计算原理&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;按日累计&lt;/td&gt;
&lt;td&gt;（当期本金+当期之后的剩余本金）*年利率*计息天数/年计息天数（360或365） 结果保留8位小数4舍5入&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;按日计息&lt;/td&gt;
&lt;td&gt;剩余本金*年利率/年计息天数*计息天数 保留两位小数&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;放上得出应计息金额后 - 已计提金额 =本次计提金额&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;计息后记账&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;根据减值表示记录表内或表外、应收应计利息和利息发生额&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;转表外当天利息记表内&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="罚息计算"&gt;罚息计算
&lt;/h4&gt;&lt;p&gt;罚息计算流程与计算逻辑大致与利息计算相同&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;不同点&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;罚息存在罚息利率&lt;/p&gt;
&lt;p&gt;宽限期内：使用正常利率参与罚息计算（宽限期内可能存不记罚息的情况，后续用罚息利率一把补记）&lt;/p&gt;
&lt;p&gt;宽限期外：使用罚息利率参与计算&lt;/p&gt;
&lt;h4 id="费用罚息"&gt;费用罚息
&lt;/h4&gt;&lt;p&gt;费用计算与罚息、利息计算逻辑相似，根据配置决定费用利率&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;本金*罚息利率&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="复息计算"&gt;复息计算
&lt;/h4&gt;&lt;p&gt;同上&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;(应收欠息+催收/减值欠息) *复息利率&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="复息补计提"&gt;复息补计提
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;复息为什么存在补计提场景？&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;因为有优惠的情况存在，优惠有两种，一种还款时优惠，一种放款即优惠。如果放款优惠，期供中目前记录的利息为减免后利息， 但还复息的场景中，可能存在优惠券失效情况。若优惠券失效，需补计提减免部分的复息。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;减免金额（取反）*复息利率&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="反向计提"&gt;反向计提
&lt;/h4&gt;&lt;p&gt;因部分银行要求利息、罚息、复息等不能超过一定比例，如超过比例需反向计提。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;反向计提金额：目前已计提金额-最大比例计算得出金额&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="处理减免"&gt;处理减免
&lt;/h4&gt;&lt;p&gt;根据上方得出的各种值做还款减免计算&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;直接从上方金额做扣减&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;还款试算结束&lt;/p&gt;
&lt;h4 id="正常还款试算总结"&gt;正常还款试算总结
&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;查出：期供、柜面还款金额、利率、宽限期&lt;/li&gt;
&lt;li&gt;按期完成试算&lt;/li&gt;
&lt;li&gt;利息：利用剩余本金、利率完成试算&lt;/li&gt;
&lt;li&gt;罚息：需考虑宽限期（宽限期计息、不计息等），利用剩余本金、罚息利率完成&lt;/li&gt;
&lt;li&gt;罚息费用（如有）：根据产品配置情况，利用剩余本金、罚息费用利率完成&lt;/li&gt;
&lt;li&gt;复息：利用利息金额、复息利率完成&lt;/li&gt;
&lt;li&gt;复息补计提（如有）：利用已减免利息、复息利率完成&lt;/li&gt;
&lt;li&gt;反向计提：检测是否超标，若超则扣减&lt;/li&gt;
&lt;li&gt;减免：还款时对各种优惠减免&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;正常还款试算流程简单，计算规则统一&lt;/p&gt;
&lt;/blockquote&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;计息方式&lt;/th&gt;
&lt;th&gt;计算原理&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;按日累计（跳切时）&lt;/td&gt;
&lt;td&gt;（当期本金+当期之后的剩余本金）*年利率*计息天数/年计息天数（360或365） 结果保留8位小数4舍5入&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;按日计息（正常情况）&lt;/td&gt;
&lt;td&gt;剩余本金*年利率/年计息天数*计息天数 保留两位小数&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="提前还款试算"&gt;提前还款试算
&lt;/h3&gt;&lt;h4 id="前期准备-2"&gt;前期准备
&lt;/h4&gt;&lt;p&gt;准备出：交易日期、提前还款方式、提前还款金额、提前还款期数、利率、优惠信息等&lt;/p&gt;
&lt;p&gt;同时对本次还款进行校验&lt;/p&gt;
&lt;h4 id="调用放款试算重新生成期供信息"&gt;调用放款试算重新生成期供信息
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;重新生成期供&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;由于需要涉及未来期次还款，之前使用优惠生成的期供新歘不可用，需调用放款试算来重新生成期供，对本次还款做扣减，方便后续扣款使用&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;求出剩余本金&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;借据剩余金额-当前试算期供的累计本金（当次应还款金额）&lt;/p&gt;
&lt;p&gt;还款后剩余本金&lt;/p&gt;
&lt;p&gt;根据还款方式做不同的处理&lt;/p&gt;
&lt;h4 id="提前还款本金"&gt;提前还款本金
&lt;/h4&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;还款方式&lt;/th&gt;
&lt;th&gt;处理方式&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;提前结清&lt;/td&gt;
&lt;td&gt;还款金额为剩余金额&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;提前部分还款&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;校验金额后暂不处理（仍为输入时金额）&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;提前还本（退货）&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;只校验（仍为输入时金额）&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;提前还当期&lt;/td&gt;
&lt;td&gt;还款本金为当期期次的剩余本金&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;提前还N期&lt;/td&gt;
&lt;td&gt;还款本金为输入n期的剩余本金汇总&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;提前柜面还款&lt;/td&gt;
&lt;td&gt;试算金额- 柜面金额&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4 id="提前还款利息"&gt;提前还款利息
&lt;/h4&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;提前还款方式&lt;/th&gt;
&lt;th&gt;利息金额&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;提前结清&lt;/td&gt;
&lt;td&gt;当前已计提的利息汇总&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;提前还当期&lt;/td&gt;
&lt;td&gt;当前已计提的利息汇总&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;提前还N期&lt;/td&gt;
&lt;td&gt;当前已计提的利息汇总&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;提前柜面还款&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;提前还本（退货）&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;提前部分还款&lt;/td&gt;
&lt;td&gt;特殊处理&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;ul&gt;
&lt;li&gt;对于提前部分还款的特殊处理&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;提前还款利息=天数*提前还款本金*年利率/年计息天数&lt;/p&gt;
&lt;p&gt;应收应计利息和：汇总每期已计提利息金额&lt;/p&gt;
&lt;p&gt;取两个利息的较小值：Math.min(提前还款利息,应收应计利息)&lt;/p&gt;
&lt;h4 id="提前还款费用"&gt;提前还款费用
&lt;/h4&gt;&lt;p&gt;提前还款费用=天数*借据金额*费用年利率/年计息天数&lt;/p&gt;
&lt;h4 id="提前还款利息优惠陕西农信"&gt;提前还款利息优惠（陕西农信）
&lt;/h4&gt;&lt;p&gt;提前还款利息优惠=天数*剩余本金*优惠利率/年计息天数（取反）&lt;/p&gt;
&lt;h4 id="摊薄金额"&gt;摊薄金额
&lt;/h4&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;摊薄方式&lt;/th&gt;
&lt;th&gt;逻辑&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;诉讼还款&lt;/td&gt;
&lt;td&gt;按照传输的还款顺序还款&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;期供优先&lt;/td&gt;
&lt;td&gt;根据配置还款顺序还款：大致为&lt;br /&gt;应计：罚、利、本&lt;br /&gt;非应计：本、利、罚&lt;br /&gt;注意：核心账务并不怎么额外关心核销标识&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;纵向优先&lt;/td&gt;
&lt;td&gt;先还本、总利息、总费用、总费用罚息&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;本金优先&lt;/td&gt;
&lt;td&gt;按期扣减本金、后按期还利息&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;根据上方还款方式后摊薄期供。&lt;/p&gt;
&lt;h4 id="做优惠"&gt;做优惠
&lt;/h4&gt;&lt;p&gt;若有n期免息、n天免息券、利息减免券等再在现有期供上做扣减&lt;/p&gt;
&lt;h4 id="利用剩余本金重新生成还款计划"&gt;利用剩余本金重新生成还款计划
&lt;/h4&gt;&lt;p&gt;利用还款后的剩余本金重新生成还款计划，如借据并未结清，则该此还款后，后续该借据以本次新生成的还款计划为准。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;提前还款试算结束&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="提前还款试算总结"&gt;提前还款试算总结
&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;先准备交易日期、提前还款方式、提前还款金额、提前还款期数、利率、优惠信息等&lt;/li&gt;
&lt;li&gt;由于优惠可能失效，需重新生成还款计划&lt;/li&gt;
&lt;li&gt;根据还款方式，试算出本次还款需要还的金额（本、利、费用）&lt;/li&gt;
&lt;li&gt;根据实还金额对现有期供做扣减（顺序有三种：期供优先、本金优先、纵向优先）&lt;/li&gt;
&lt;li&gt;若有剩余本金则利用剩余本金重新生成期供、给客户后续使用&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="正常还款tcc"&gt;正常还款（TCC)
&lt;/h3&gt;&lt;p&gt;还款前校验：日切中不能还款，批量还款预先记录一条批量还款请求流水（try）&lt;/p&gt;
&lt;h4 id="信贷管理还款事务1try"&gt;信贷管理：还款（事务1：try）
&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;正常还款、提前还款信贷管理逻辑统一&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;开启事务1.1&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;查询客户额度（事务：1.1）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;校验客户信息（事务：1.1）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;增加还款申请流水和台账流水（事务：1.1）&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;若为批量还款，则直接使用中台记录的批量还款请求流水&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;事务1.1结束&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="信贷核心正常还款事务2try"&gt;信贷核心：正常还款（事务2：try）
&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;还款非大事务，整体流水串联没有事务，每一小步都是单独的事务&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;无事务操作&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;查询账户信息、借据信息、是否日间状态是否可以还款等&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;插入流水、日切中的还款锁定账户（临时事务，乐观锁）&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;开启事务&lt;/p&gt;
&lt;/blockquote&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;还款类型&lt;/th&gt;
&lt;th&gt;处理方式&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;非日间还款（非日间的联机还款或批量还款）&lt;/td&gt;
&lt;td&gt;标记为还款待处理、锁定账户、不试算&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;诉讼还款&lt;/td&gt;
&lt;td&gt;插入诉讼还款流水&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;正常还款&lt;/td&gt;
&lt;td&gt;贷款交易表、贷款交易流水表、支付交易流水表插入初始化流水&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;提前还款&lt;/td&gt;
&lt;td&gt;贷款交易表、贷款交易流水表、支付交易流水表插入初始化流水&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;插入流水扩展信息&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;事务结束&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;检测是否在营业窗口，决定是否后续流程（日切过程中直接结束）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;日间的还款锁定账户（乐观锁）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;上方只有在日切过程中会提前锁定账户，直接返回。&lt;/p&gt;
&lt;p&gt;对于其他还款、只插入了流水，现在锁定账户。(借新还旧特殊处理，不锁定账户)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;调用正常还款试算（无事务）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;调用上面提到的正常还款试算，得出还款后的本、利、罚余额等&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;调用支付请求还款&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;默认账户仍未锁定状态、当支付返回失败才进行解锁操作。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;若支付返回处理中，仍未锁定状态，等待后续流水批量状态同步再判断是否解锁。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="信贷管理还款取消事务1cansel"&gt;信贷管理：还款取消（事务1：cansel）
&lt;/h4&gt;&lt;p&gt;更新还款申请流水和台账历史流水为失败&lt;/p&gt;
&lt;h4 id="信贷核心还款取消事务2cansel"&gt;信贷核心：还款取消（事务2：cansel）
&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;事务开启&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;根据主流水为失败&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;诉讼还款更新诉讼流水为失败&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;解锁之前锁定的账户（乐观锁解锁）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;更新支付流水、贷款交易流水为失败&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;事务结束&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="信贷管理还款确认事务1confirm"&gt;信贷管理：还款确认（事务1：confirm）
&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;若支付返回成功，则进入确认流程&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;开启事务&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;更新还款申请流水、台账流水为成功&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;恢复额度（释放额度）&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;根据还款本金，恢复额度协议分项表中的额度&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;若本次还款为代偿还款，记录当前客户被代偿次数+1&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;事务结束&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="信贷核心正常还款确认事务2confirm"&gt;信贷核心：正常还款确认（事务2：confirm）
&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;开启事务&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;查询还款前借据信息、更新主流水为成功&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;判断是否为最后一笔还款、后续是否可以销户&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;保存老期供信息、新建新的期供，金额为试算时的金额&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;保存老、新建新的借据，更新借据信息&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;根据老借据状态对借据进行不同处理&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;原借据状态&lt;/th&gt;
&lt;th&gt;处理方式&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;核销&lt;/td&gt;
&lt;td&gt;还清：核销销户&lt;br /&gt;未还清：更新核销余额&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;已减值&lt;/td&gt;
&lt;td&gt;已结清：销户&lt;br /&gt;若期供最小到期&amp;lt;交易日期：转正常&lt;br /&gt;期供到期日&amp;lt; 交易日期&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;逾期还款&lt;/td&gt;
&lt;td&gt;结清：销户&lt;br /&gt;还完逾期：借据状态转正常&lt;br /&gt;仍为逾期：只扣减金额&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;正常还款&lt;/td&gt;
&lt;td&gt;结清：销户&lt;br /&gt;正常还款：扣减金额&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;ul&gt;
&lt;li&gt;转正常&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;将期供催收金额更新到应收金额&lt;/li&gt;
&lt;li&gt;借据催收金额更新到应收金额&lt;/li&gt;
&lt;li&gt;更新借据扩展信息计息标识&lt;/li&gt;
&lt;li&gt;形态转移表记录本次结转金额&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;若本次还款中涉及计提&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;记录未记录的计提流水&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;判断是否结息&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;结息：应计转应收&lt;/p&gt;
&lt;p&gt;记录结息流水&lt;/p&gt;
&lt;p&gt;更新借据信息为已结息&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;判断是否红冲&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;延展期等可能导致红冲出现&lt;/p&gt;
&lt;p&gt;一般正冲应计&lt;/p&gt;
&lt;p&gt;若已结息则反冲应收&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;登记减免和交易明细&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;解锁账户表、更新账户状态（可能存在减值转正常或销户等）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;更新期供金额、状态&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;至此、借据状态、账户状态、期供状态都已修改完毕&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;确认之前的申请流水&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;将之前的支付流水、贷款交易流水置为成功&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;保存老数据用于冲正&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;事务结束&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="正常还款总结"&gt;正常还款总结
&lt;/h4&gt;&lt;h2 id="特别说明"&gt;特别说明
&lt;/h2&gt;&lt;h3 id="信贷核心还款锁定说明乐观锁"&gt;信贷核心还款锁定说明（乐观锁）
&lt;/h3&gt;&lt;p&gt;客户计提、还款时，为避免多次try导致金额扣减出问题，默认一笔借据同一时间只能有一次还款在处理中。所有在执行扣款、计提中（try阶段）要对客户账户上锁。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;账户上锁的基本原则&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;哪条流水（连接/线程）进行的加锁（开启事务/获取资源）操作，有且只有这条流水去进行解锁（提交事务/释放资源），而且必须保证解锁的逻辑能够执行。&lt;/p&gt;
&lt;p&gt;否则可能导致的后果：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;死锁&lt;/li&gt;
&lt;li&gt;锁失效&lt;/li&gt;
&lt;li&gt;事务不生效&lt;/li&gt;
&lt;li&gt;脏资源&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;加锁与解锁&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;所有借据都有对应的账户数据，账户表中有字段账户处理标识和请求编号字段。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;字段名&lt;/th&gt;
&lt;th&gt;逻辑&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;。。。&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;账户处理标识&lt;/td&gt;
&lt;td&gt;0：已处理&lt;br /&gt;1：账户表处理中/临时表未处理&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;请求流水号&lt;/td&gt;
&lt;td&gt;当前正在操作账户的流水，只有处理表示为1时才存在请求流水号，当标识为0时不存在请求流水号&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;加锁&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-mysql" data-lang="mysql"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;update&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;账户表&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;处理标识&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;1&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="err"&gt;请求流水&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;当前请求流水&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;where&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;借据号&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;借据号&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;and&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;处理标识&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;更新后检测是否更新成功，如果更新成功。则加锁成功。后续其他流水无法再锁定当前账户&lt;/p&gt;
&lt;p&gt;解锁&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-mysql" data-lang="mysql"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;update&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;处理标识&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;where&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;借据号&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;借据号&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;and&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;处理标识&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;1&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;and&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;请求流水&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;请求解锁的流水号&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;解锁只能通过上锁的流水来解锁，保证单笔借据不会重复交易，产生并发问题。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id="计算器"&gt;计算器
&lt;/h2&gt;&lt;h3 id="放款-1"&gt;放款
&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;放款需要的要素：&lt;/p&gt;
&lt;p&gt;还本周期、还息周期、年计息天数、剩余本金、开始日期（借据起始日期）、年利率、总期数（产品配置中存）&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;还本周期（贷款扣收本金的频率）&lt;/strong&gt;：默认为授信时为客户配置，样式：3|M|A|E&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;周期性字段的解释&lt;/p&gt;
&lt;/blockquote&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;3&lt;/th&gt;
&lt;th&gt;M&lt;/th&gt;
&lt;th&gt;A&lt;/th&gt;
&lt;th&gt;E&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;间隔：1,3,12&lt;br /&gt;常数，表示每多少后方量做一次循环&lt;/td&gt;
&lt;td&gt;循环量：&lt;br /&gt;D:天Daily&lt;br /&gt;W:周Weekly&lt;br /&gt;S：旬Semi-Monthly&lt;br /&gt;M：月Monthly&lt;br /&gt;Q：季Quarterly&lt;br /&gt;Y：年Yearly&lt;br /&gt;一般的配置M或月&lt;/td&gt;
&lt;td&gt;工作日选项：&lt;br /&gt;A：实际日期（无视是否工作日）&lt;br /&gt;N：下一个工作日（会顺延到下一个工作日）&lt;br /&gt;P：上一个工作日（同理）&lt;/td&gt;
&lt;td&gt;日期：&lt;br /&gt;E：每次循环的最后一天&lt;br /&gt;1到31：满足前面循环的固定日期&lt;br /&gt;*满足条件的任意一天&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;例：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;1|M|A|15 每个月的15日，无视是否工作日&lt;/li&gt;
&lt;li&gt;1|M|A|E 落在每月的最后那天，不管那个月有多少天。1月31日、2月28日、2月29日，3月30日等&lt;/li&gt;
&lt;li&gt;1|Q|A|E 落在每个季度的最后一天，3月31日、6月30日、9月30日、12月31日&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;还息周期&lt;/strong&gt;：同还本周期&lt;/p&gt;
&lt;h4 id="等额本金计算器"&gt;等额本金计算器
&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;先息后本、等额本金、自定义周期性还本还息&lt;/p&gt;
&lt;/blockquote&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;需要生成的字段&lt;/th&gt;
&lt;th&gt;逻辑&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;还息周期&lt;/td&gt;
&lt;td&gt;一般由授信信息得出，授信时会为每位客户定好固定的还息周期。还息周期一般情况为1开头&lt;br /&gt;一般还息周期决定了一笔借据一期有多长，默认以还一次息为还一期期供&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;还本周期&lt;/td&gt;
&lt;td&gt;等额本金：&lt;strong&gt;等额本金还本周期必须等于还息周期&lt;/strong&gt;&lt;br /&gt;还本周期必须大于等于还息周期，&lt;font color='red'&gt;不能存在本金还完后，利息还没有还完的情况&lt;/font&gt;。若还息周期*期数小于还本周期，则让还本周期等于最末期（先息后本）&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;年计息天数&lt;/td&gt;
&lt;td&gt;产品配置，一般为360或365&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;起息日&lt;/td&gt;
&lt;td&gt;贷款的开始日期&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;每期应还本金额（理想值）&lt;/td&gt;
&lt;td&gt;每期还本金额的平均值（末期可能不同）&lt;br/&gt;&lt;strong&gt;需要还本的期数&lt;/strong&gt;=总期数*还息周期/还本周期&lt;br /&gt;平均还本金额=总金额/需还本期数&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;填充本金&lt;/td&gt;
&lt;td&gt;还本周期为还息周期的整数倍关系，先用理想值填充非末期的（i*还本周期/还息周期）本金余额&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;末期本金&lt;/td&gt;
&lt;td&gt;末期本金不是直接取平均值，而是通过总金额扣减上面每次填充的本金后的余额。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;首期还款日&lt;/td&gt;
&lt;td&gt;单期借据（只有一期的借据）：Math.min(次月的今天,次月的最后一天)&lt;br /&gt;理想情况：为下一个月的放款日&lt;br /&gt;破期（需要向下一个周期推演）：3月10日推迟到4月10日&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;首期计息天数&lt;/td&gt;
&lt;td&gt;只针对破期的情况：&lt;br /&gt;1、按实际天数计算&lt;br /&gt;2、按整期计算&lt;br /&gt;3、按照30天+零头计算&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;首期利息&lt;/td&gt;
&lt;td&gt;剩余本金*年利率*计息天数/年计息天数&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;其他期数&lt;/td&gt;
&lt;td&gt;其他期数按照第一确定的还款日向后推演&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4 id="等额本息计算器"&gt;等额本息计算器
&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;还息周期必须等于还本周期（房贷最常用的还款方式）&lt;/p&gt;
&lt;p&gt;起始日期与结束日期都为固定值，一般不存在破期&lt;/p&gt;
&lt;/blockquote&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;字段&lt;/th&gt;
&lt;th&gt;取值逻辑&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;每期还款金额（本息和）&lt;/td&gt;
&lt;td&gt;放款金额*年利率*（1+年利率）的总期次数量方/（（1+年利率）的总其次数量方-1）&lt;br /&gt;本金.multiply(rate)multiply(Math.pow(1+rate,总期数)).divide(Math.pow(1+rate,总期数)-1)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;利息&lt;/td&gt;
&lt;td&gt;剩余本金*利率*计息天数/年计息天数&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;本金&lt;/td&gt;
&lt;td&gt;每期还款金额-利息金额&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;为什么这么计算每期还款金额？&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;对于每一期的利息，一定是按照当期剩余本金*利率来算息，+1之后可以确定本息和。n次幂-1表示一共需要计算了n次幂的利息，则还款金额刚好等于总金额/n次幂-1&lt;/p&gt;
&lt;p&gt;&lt;img src="https://fastly.jsdelivr.net/gh/thecoolboyhan/th_blogs@main/image/2025-07/250701195852848_1751371132891.png"
loading="lazy"
alt="250701195852848.png"
&gt;&lt;/p&gt;
&lt;h2 id="批量还款"&gt;批量还款
&lt;/h2&gt;&lt;h3 id="批量还款准备"&gt;批量还款准备
&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;清理数据，删除批量临时表(分库)、删除绑卡信息临时表&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;可以被批扣的租户保存在临时表中&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol start="2"&gt;
&lt;li&gt;待还款数据初始化&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;将账户表、借据表中有自动还款标识的数据搬入临时表&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;如果已经做代偿的数据不进入批量扣款&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id="自营批量还款幂等"&gt;自营批量还款(幂等)
&lt;/h3&gt;&lt;p&gt;分布式同时批扣(6台server，6个node,每个机器根据自己的编号取模后决定是否执行)&lt;strong&gt;由于是分片广播，所有机器默认会收到所有通知，但不是每个通知都要处理，只有对应自己的机器才执行&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;创建线程池(可配置线程数)&lt;/p&gt;
&lt;p&gt;开始线程池内部循环任务:按照客户为维度扣款&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;获取当前客户的绑卡卡信息&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;拷贝当前客户名下的所有借据list1&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;外层循环卡信息、内层循环借据信息，逐笔对当前借据进行应还款试算&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;根据试算结果，调用正常还款流程&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;失败场景：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;返回结果还款失败，正常记录失败。&lt;/li&gt;
&lt;li&gt;如果出现I0异常(网络请求异常)，也当失败处理，记录结果为失败。&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;成功：记录成功结果，并记录本次还款金额。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;上面的结果，需携带当前是否出现卡余额不足情况，如果出现余额不足，则跳出当前卡循环，进入下一张卡&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol start="7"&gt;
&lt;li&gt;当前借据全部扣款完成，修改临时list1状态为成功，借据状态为结清(添加如成功集合，下次循环不再处理)&lt;/li&gt;
&lt;li&gt;未结清的借据保持处理中不变，交易状态标记为未结清，下次循环继续扣款。&lt;/li&gt;
&lt;li&gt;对于支付超时，(处理中)的借据也标记为处理中，且标记为支付处理中，同结清逻辑添加到成功集合，下次循环不再处理&lt;/li&gt;
&lt;li&gt;从贷批扣集合中，去除上面批扣成功的借据，更新当前客户updateTime(更新时间是为了防止一直给同一个客户进行批扣)&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="流水状态同步"&gt;流水状态同步
&lt;/h2&gt;&lt;h3 id="自营流水状态同步"&gt;自营流水状态同步
&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;每两分钟执行一次，同步所有交易流水,尽量让为完成的事务走向终态。(最大努力交付)&lt;strong&gt;流水同步需跳过日切时段&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;1、圈定处理数据范围，获取批扣，或主流水表中执行状态为处理中的流水。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;根据主流水范围，单笔执行&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;2、根据流水状态为处理中的流水，查询支付返回的处理结果&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;下面内容为处理模板，对于不同的流水会进行不同的处理实现&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;前置校验:判断是否满足执行&lt;/li&gt;
&lt;li&gt;查询支付流水状态:获取结果&lt;/li&gt;
&lt;li&gt;判断当前是否是日切状态:如果日切，不进行流水同步&lt;/li&gt;
&lt;li&gt;开启独立事务，执行流水状态同步&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;后面的几种流水全部按照上述模板执行，主要展示前置校验和执行流水同步的逻辑&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id="虚账户提现或红包提现的流水同步"&gt;虚账户提现或红包提现的流水同步
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;前置判断&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;无需进行前置判断，虚账户和红包提现没有账户信息和账务交易流水。(默认可以执行)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;处理逻辑&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;直接更新主流水表，由于没有账户信息，不需要上锁或解锁&lt;/p&gt;
&lt;h4 id="放款流水同步"&gt;放款流水同步
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;前置判断&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;对于放款冲正的流水，需修改前流水状态为已冲正(由于借据已经被冲正，不需要进行解锁）&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;更新贷款流水，更新主流水，更新支付流水为失败&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;非冲正流水可执行具体同步逻辑&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;同步逻辑&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;支付状态仍为处理中:只增加同步计数，不做其他处理return&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;有结果的数据，先更新三大流水&lt;/strong&gt;：更新贷款流水，更新主流水，更新支付流水&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;解锁&lt;/strong&gt;:修改账户表到终态&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;对于成功的流水进行后续补偿&lt;/strong&gt;：计税、对于银行核心模式,借据和期供信息来自对方需同步借据信息和期供信息)、发送核算报文(让核算系统记账)、累加头寸(头寸为了汇总每日放款还款等信息勾兑)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;给信贷中台发送成功mg&lt;/strong&gt;，让其做后续处理(可能需处理营销、客户信息、短信等各种自定义流水，但其与账务无关，这里不再赘述)&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id="还款流水同步"&gt;还款流水同步
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;前置判断&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;还款流水必须是主流水表中存在流水才能执行(防止出现意料外的流水)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;同步逻辑&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;类似放款，如果支付同步的流水仍未处理中，则增加同步计数，return(但批扣需特殊处理，批扣会先将数据存放如临时表中，不断无限循环，为了防止死循环，会先把这次临时表状态修改为失败&lt;strong&gt;这里的失败不是让批扣失败，是让批扣不再重试&lt;/strong&gt;)&lt;/li&gt;
&lt;li&gt;对于成功的流水，重新调用提前还款或正常还款:走试算、还款流程来记账。(只是本次不涉及调用支付场景)且提交TCC事务。(直接提交，本次也不存在占用失败，取消等场景）&lt;/li&gt;
&lt;li&gt;对于失败的流水，更新流水状态为失败，解锁账户。&lt;/li&gt;
&lt;li&gt;与放款相同，发送还款后mg，执行后续处理。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="合作方放款流水同步"&gt;合作方放款流水同步
&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;获取合作方的放款流水(获取条件为上一步中所有状态为处理中的用户）&lt;/li&gt;
&lt;li&gt;根据合作方的结果根据当前流水到终态（成功或者失败）&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;注:只更新了流水&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id="合作方还款流水同步"&gt;合作方还款流水同步
&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;查询流水状态为处理中的流水&lt;/li&gt;
&lt;li&gt;通过springcontextHolder.getBean(单笔还款流水查询.class)开启独立新事务执行单笔流水处理&lt;/li&gt;
&lt;li&gt;根据合作方的还款流水，单笔修改流水状态为成功、失败或处理中&lt;/li&gt;
&lt;/ol&gt;</description></item></channel></rss>